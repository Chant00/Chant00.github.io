<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Chant's Personal Blog | NLP/自然语言处理 | Ml/机器学习 | Algorithm/算法"><title>java远程调用shell脚本 | Chant</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">java远程调用shell脚本</h1><a id="logo" href="/.">Chant</a><p class="description">Take things as they are with a cavalier attitude./用漫不经心的态度过随遇而安的生活</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">java远程调用shell脚本</h1><div class="post-meta">Jun 4, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a data-disqus-identifier="2017/06/04/java远程调用shell脚本/" href="/2017/06/04/java远程调用shell脚本/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><h1 id="java远程调用shell脚本"><a href="#java远程调用shell脚本" class="headerlink" title="java远程调用shell脚本"></a>java远程调用shell脚本</h1><hr>
<h3 id="目的："><a href="#目的：" class="headerlink" title="目的："></a>目的：</h3><p>java程序调用远程服务器的shell脚本来实现服务的起、停、重启。</p>
<h3 id="前言（废话）："><a href="#前言（废话）：" class="headerlink" title="前言（废话）："></a>前言（废话）：</h3><p>由于知道我经验不足，领导给新同事分配任务时说：“这个java远程调用shell脚本重启服务，他两可能搞不出来，你研究下吧。”被人鄙视了一把，于是自己搭虚拟机，查资料，试一把，突然发现，好多事情其实没那么难嘛。</p>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><h4 id="Step1-准备脚本"><a href="#Step1-准备脚本" class="headerlink" title="Step1.准备脚本"></a>Step1.准备脚本</h4><p>重启的关键在于关闭，要关闭程序，那就要先找到程序pid，然后kill。<br>找到核心命令（获取pid）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ID=`ps -ef | grep &quot;$NAME&quot; | grep -v &quot;grep&quot; | grep -v kill  | awk &apos;&#123;print $2&#125;&apos;`</div></pre></td></tr></table></figure>
<p>于是初期博主调试后，写出了这样的shell</p>
<blockquote>
<p>如果你的虚机是root用户，kill命令会很强大，所以一定判断参数是否为空或数字，否则，分分钟把你的所以进程都kill，虚机瞬间爆炸😂，重头再来。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line">NAME=$1</div><div class="line">##检查参数，不能为空或纯数字,否则会kill几乎所有进程，直接死机。非root用户的话，应该不会死机，会报permission denied.</div><div class="line">a=`echo &quot;$NAME&quot; | grep [^0-9] &gt;/dev/null &amp;&amp; echo 0 || echo 1` #判断参数是否为数字,是数字则返回1，不是则返回0</div><div class="line">if [ &quot;$NAME&quot; == &quot;&quot; ]; then #$NAME一定要加引号，不然$NAME为空的时候就成了if[ == &quot;&quot; ],会报错：unary operator</div><div class="line">echo &quot;未输入要kill的进程名&quot;</div><div class="line">elif [ $a = 1 ]; then</div><div class="line">echo &quot;进程名不能为纯数字&quot;</div><div class="line">else</div><div class="line">##重启进程</div><div class="line">echo &quot;-----------------------&quot;</div><div class="line">echo -e &quot;pNmae\t=\t$NAME&quot;</div><div class="line">ID=`ps -ef | grep &quot;$NAME&quot; | grep -v &quot;grep&quot; | grep -v &quot;restart&quot;  | awk &apos;&#123;print $2&#125;&apos;`</div><div class="line">echo -e &quot;pid\t=\t$ID&quot;</div><div class="line">echo &quot;-----------------------&quot;</div><div class="line">for id in $ID</div><div class="line">do</div><div class="line">kill -9 $id</div><div class="line">echo &quot;killed $id&quot;</div><div class="line">done</div><div class="line">echo &quot;-----------------------&quot;</div><div class="line">echo &quot;restarted&quot; $NAME</div><div class="line">./$NAME 1&gt;/dev/null 2&gt;&amp;1 &amp;</div><div class="line">#./$NAME</div><div class="line">fi</div></pre></td></tr></table></figure>
<p>然后领导交于博主一份专业的shell脚本，瞬间把博主的三脚猫脚本秒成渣了。于是博主认真研读，添加注释，并稍作修改得到以下脚本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line"># -*- coding: utf-8 -*-</div><div class="line">#Filename:    server.sh.Chant</div><div class="line">#Author:        Chant</div><div class="line">#Email:        statuschuan@gmail.com</div><div class="line">#Date:        2017-06-03</div><div class="line">#Desc:</div><div class="line">#用途：该脚本用于停止、启动服务</div><div class="line">#使用说明：</div><div class="line">#启动该脚本时需要两个参数，参数均不能为空</div><div class="line">#第一个参数为：程序入口名称</div><div class="line">#第二个参数为：参数名称</div><div class="line">#注意事项：</div><div class="line">#远程调用时，请将脚本环境变量配置到/etc/bashrc或者用户目录下的.bashrc</div><div class="line"></div><div class="line"></div><div class="line">print_usage()</div><div class="line">&#123;</div><div class="line">  echo &quot;Usage: $0 COMMAND&quot;</div><div class="line">  echo &quot;where COMMAND is one of:&quot;</div><div class="line">  echo &quot;  help                                         Help print this usage message&quot;</div><div class="line">  echo &quot;  start &lt;server_name&gt; &lt;server_param&gt;           Start&quot;</div><div class="line">  echo &quot;  stop  &lt;server_name&gt; &lt;server_param&gt;           Stop&quot;</div><div class="line">  echo &quot;  restart  &lt;server_name&gt; &lt;server_param&gt;        Restart&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line">start()&#123;</div><div class="line">  #echo &quot;start not suport now.&quot;</div><div class="line">  cmd=$@</div><div class="line">  $cmd 1&gt;/dev/null 2&gt;&amp;1 &amp; #这里一定要写1&gt;/dev/null 2&gt;&amp;1 不能只写&amp;,否则远程调用时，会等待cmd的返回结果(stdOut)，就么法愉快地玩耍了。</div><div class="line">&#125;</div><div class="line"></div><div class="line">stop()&#123;</div><div class="line">  #get arguments</div><div class="line">  SERVER_NAME=$1</div><div class="line">  SERVER_PARAM=$2</div><div class="line">  PROCESS_NAME=&quot;$1 $2&quot;</div><div class="line">  #echo $PROCESS_NAME</div><div class="line">  if [ &quot;$1&quot; = &quot;&quot; ];</div><div class="line">  then</div><div class="line">    echo &quot;第二个参数不能为空&quot;</div><div class="line">    exit 0;</div><div class="line">  fi</div><div class="line">  if [ -z &quot;$2&quot; ];</div><div class="line">  then</div><div class="line">    echo &quot;第三个参数不能为空&quot;</div><div class="line">    exit 0;</div><div class="line">  fi</div><div class="line"></div><div class="line">  #get process&apos;s pids</div><div class="line">  pids=`ps -ef|grep &quot;$PROCESS_NAME&quot;|grep -v &quot;grep&quot;|awk &apos;&#123;print $2&#125;&apos;`</div><div class="line"></div><div class="line">  #Chant:使用以下命令可以过滤掉脚本本身的pid，就不用写后面的判断语句了。</div><div class="line">  #但是其实用$$获取当前脚本pid在逻辑上更严密，否则，万一你的脚本名和要操作的程序名有相同部分就会出问题，</div><div class="line">  #eg: 脚本名为：ser.sh 而程序名为：poser.sh,那么由于grep -v &quot;$0&quot; 就取不到其pid了</div><div class="line">  #pids=`ps -ef|grep &quot;$PROCESS_NAME&quot;|grep -v &quot;grep&quot;| grep -v &quot;$0&quot; |awk &apos;&#123;print $2&#125;&apos;`</div><div class="line">  # 为basename指定一个路径，basename命令会删掉所有的前缀包括最后一个slash（‘/’）字符，然后将字符串显示出来。</div><div class="line">  #pids=`ps -ef|grep &quot;$PROCESS_NAME&quot;|grep -v &quot;grep&quot;| grep -v &quot;$(basename $0)&quot; |awk &apos;&#123;print $2&#125;&apos;`</div><div class="line"></div><div class="line">  current_pid=$$</div><div class="line">  echo process pids is $pids.</div><div class="line"></div><div class="line">  #kill process</div><div class="line">  if [ -n &quot;$pids&quot; ]; #判断pids是否为空，引号必须加。&quot;$pids&quot; == &quot;&quot;等效</div><div class="line">  then</div><div class="line">    for pid in $pids</div><div class="line">    do</div><div class="line">      #current shell pid shoud not kill.</div><div class="line">      if [ $pid -ne $current_pid ];</div><div class="line">      then</div><div class="line">        #check $pid is exist or not</div><div class="line">        check=`ps -p $pid`</div><div class="line">        if [ $? -eq 0 ];</div><div class="line">        then</div><div class="line">          echo kill $pid start.</div><div class="line">          kill -9 $pid</div><div class="line">          #judge result</div><div class="line">          if [ $? -eq 0 ];</div><div class="line">          then</div><div class="line">            echo kill $pid success.</div><div class="line">          else</div><div class="line">            echo kill $pid fail.</div><div class="line">          fi</div><div class="line"></div><div class="line">        fi</div><div class="line">      fi</div><div class="line"></div><div class="line">    done</div><div class="line">  else</div><div class="line">    echo &quot;$PROCESS_NAME does not exist.&quot;</div><div class="line">  fi</div><div class="line">&#125;</div><div class="line"></div><div class="line"># get command arguments</div><div class="line">COMMAND=$1</div><div class="line">shift</div><div class="line"></div><div class="line"># support help commands</div><div class="line">case $COMMAND in</div><div class="line">  --help|-help|-h|help)</div><div class="line">  print_usage</div><div class="line">  exit 0</div><div class="line">  ;;</div><div class="line">esac</div><div class="line">if [ &quot;$COMMAND&quot; = &quot;&quot; ] ; then</div><div class="line">  print_usage</div><div class="line">  exit 0</div><div class="line">elif [ &quot;$COMMAND&quot; = &quot;start&quot; ] ; then</div><div class="line">  start $@</div><div class="line">  echo &quot;$@ started&quot;</div><div class="line">  exit 0</div><div class="line">elif [ &quot;$COMMAND&quot; = &quot;stop&quot; ] ; then</div><div class="line">  stop $@</div><div class="line">  exit 0</div><div class="line">elif [ &quot;$COMMAND&quot; = &quot;restart&quot; ] ; then</div><div class="line">  #start and stop的参数需要一致才可以，如果不一致则需要调整参数传入方式</div><div class="line">  stop $@</div><div class="line">  sleep 3</div><div class="line">  start $@</div><div class="line">  echo &quot;$@ restarted&quot;</div><div class="line">  exit 0</div><div class="line">fi</div></pre></td></tr></table></figure>
<p>####Step2.java程序远程调用shell</p>
<blockquote>
<p>1.导入需要依赖的jar包。Java远程调用Shell脚本这个程序需要ganymed-ssh2-build210.jar包。里面还有example包，方便学习。为了调试方便，可以将\ganymed-ssh2-build210\src下的代码直接拷贝到我们的工程里，此源码的好处就是没有依赖很多其他的包，拷贝过来干干净净。<br>2.导入commons-io包，里面的IOUtils会经常使用。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;dependencies&gt;</div><div class="line">    &lt;!-- https://mvnrepository.com/artifact/commons-io/commons-io --&gt;</div><div class="line">    &lt;dependency&gt;</div><div class="line">        &lt;groupId&gt;commons-io&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;commons-io&lt;/artifactId&gt;</div><div class="line">        &lt;version&gt;2.5&lt;/version&gt;</div><div class="line">    &lt;/dependency&gt;</div><div class="line">    &lt;!-- https://mvnrepository.com/artifact/ch.ethz.ganymed/ganymed-ssh2 --&gt;</div><div class="line">    &lt;dependency&gt;</div><div class="line">        &lt;groupId&gt;ch.ethz.ganymed&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;ganymed-ssh2&lt;/artifactId&gt;</div><div class="line">        &lt;version&gt;build210&lt;/version&gt;</div><div class="line">    &lt;/dependency&gt;</div><div class="line"></div><div class="line">&lt;/dependencies&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>3、编写RemoteShellExecutor工具类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> RemoteShell;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.*;</div><div class="line"><span class="keyword">import</span> java.nio.charset.Charset;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</div><div class="line"></div><div class="line"><span class="keyword">import</span> ch.ethz.ssh2.ChannelCondition;</div><div class="line"><span class="keyword">import</span> ch.ethz.ssh2.Connection;</div><div class="line"><span class="keyword">import</span> ch.ethz.ssh2.Session;</div><div class="line"><span class="keyword">import</span> ch.ethz.ssh2.StreamGobbler;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Chant on 2017/5/27.</div><div class="line"> * 远程调用脚本重启服务</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteShellExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Connection conn;</div><div class="line">    <span class="comment">/** 远程机器IP */</span></div><div class="line">    <span class="keyword">private</span> String ip;</div><div class="line">    <span class="comment">/** 用户名 */</span></div><div class="line">    <span class="keyword">private</span> String osUsername;</div><div class="line">    <span class="comment">/** 密码 */</span></div><div class="line">    <span class="keyword">private</span> String password;</div><div class="line">    <span class="keyword">private</span> String charset = Charset.defaultCharset().toString();</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIME_OUT = <span class="number">1000</span> * <span class="number">5</span> * <span class="number">60</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 构造函数</div><div class="line">     * <span class="doctag">@param</span> ip</div><div class="line">     * <span class="doctag">@param</span> usr</div><div class="line">     * <span class="doctag">@param</span> pasword</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RemoteShellExecutor</span><span class="params">(String ip, String usr, String pasword)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.ip = ip;</div><div class="line">        <span class="keyword">this</span>.osUsername = usr;</div><div class="line">        <span class="keyword">this</span>.password = pasword;</div><div class="line"><span class="comment">//        System.out.println(charset);</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 登录</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@throws</span> IOException</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">login</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        conn = <span class="keyword">new</span> Connection(ip);</div><div class="line">        conn.connect();</div><div class="line">        <span class="keyword">return</span> conn.authenticateWithPassword(osUsername, password);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 执行脚本</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> cmds</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@throws</span> Exception</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">exec</span><span class="params">(String cmds)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        InputStream stdOut = <span class="keyword">null</span>;</div><div class="line">        InputStream stdErr = <span class="keyword">null</span>;</div><div class="line">        String outStr = <span class="string">""</span>;</div><div class="line">        String outErr = <span class="string">""</span>;</div><div class="line">        <span class="keyword">int</span> ret = -<span class="number">1</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (login()) &#123;</div><div class="line">                <span class="comment">// Open a new &#123;@link Session&#125; on this connection</span></div><div class="line">                Session session = conn.openSession();</div><div class="line">                <span class="comment">// Execute a command on the remote machine.</span></div><div class="line">                session.execCommand(cmds);</div><div class="line"></div><div class="line">                stdOut = <span class="keyword">new</span> StreamGobbler(session.getStdout());</div><div class="line">                outStr = processStream(stdOut, charset);</div><div class="line"></div><div class="line">                stdErr = <span class="keyword">new</span> StreamGobbler(session.getStderr());</div><div class="line">                outErr = processStream(stdErr, charset);</div><div class="line"></div><div class="line">                session.waitForCondition(ChannelCondition.EXIT_STATUS, TIME_OUT);</div><div class="line"></div><div class="line">                System.out.println(<span class="string">"outStr="</span> +<span class="string">"\n"</span>+ outStr);</div><div class="line">                System.out.println(<span class="string">"outErr="</span> +<span class="string">"\n"</span>+ outErr);</div><div class="line"></div><div class="line">                ret = session.getExitStatus();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"登录远程机器失败"</span> + ip); <span class="comment">// 自定义异常类 实现略</span></div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</div><div class="line">                conn.close();</div><div class="line">            &#125;</div><div class="line">            IOUtils.closeQuietly(stdOut);</div><div class="line">            IOUtils.closeQuietly(stdErr);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> in</div><div class="line">     * <span class="doctag">@param</span> charset</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@throws</span> IOException</div><div class="line">     * <span class="doctag">@throws</span> UnsupportedEncodingException</div><div class="line">     */</div><div class="line"><span class="comment">//    private String processStream(InputStream in, String charset) throws Exception &#123;</span></div><div class="line"><span class="comment">//        byte[] buf = new byte[1024];</span></div><div class="line"><span class="comment">//        StringBuilder sb = new StringBuilder();</span></div><div class="line"><span class="comment">//        while (in.read(buf) != -1) &#123;</span></div><div class="line"><span class="comment">//            sb.append(new String(buf, charset));</span></div><div class="line"><span class="comment">//        &#125;</span></div><div class="line"><span class="comment">//        return sb.toString();</span></div><div class="line"><span class="comment">//    &#125;</span></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">processStream</span><span class="params">(InputStream in, String charset)</span><span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">        BufferedReader bufr = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(in,charset));</div><div class="line">        String line = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">while</span>((line = bufr.readLine()) != <span class="keyword">null</span>)&#123;</div><div class="line">            sb.append(line);</div><div class="line">            sb.append(<span class="string">"\n"</span>);<span class="comment">//？？换行符是依赖平台的</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sb.toString();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>4、Java程序调用远程Shell</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    RemoteShellExecutor(<span class="string">"10.10.10.100"</span>, <span class="string">"root"</span>, <span class="string">"123123"</span>);</div><div class="line">    String proName = <span class="string">"entranceMain.sh"</span>;</div><div class="line">    String para = <span class="string">"1"</span>;</div><div class="line">        System.out.println(executor.exec(<span class="string">"server.sh.Chant start "</span> + proName +<span class="string">" "</span>+ para));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将start换为restart，stop，测试结果如下，注意pid发生变化，说明重启成功。<br><img src="http://image.jiantuku.com/17-6-4/80160967.jpg?attname=file_1496584141329_3b57.png&amp;e=1496584810&amp;token=el7kgPgYzpJoB23jrChWJ2gV3HpRl0VCzFn8rKKv:24Xu8-YbrqzYKvsT6uoA8NUefVk=" alt="image"></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://chant00.github.io/2017/06/04/java远程调用shell脚本/" data-id="cj3ispffj00004at7unzdlnsl" class="article-share-link">分享</a><div class="tags"></div><div class="post-nav"><a href="/2017/03/08/My-New-Post/" class="next">My New Post</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'chant-1';
var disqus_identifier = '2017/06/04/java远程调用shell脚本/';
var disqus_title = 'java远程调用shell脚本';
var disqus_url = 'https://chant00.github.io/2017/06/04/java远程调用shell脚本/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//chant-1.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://chant00.github.io"/></form></div><div class="widget"><input placeholder="Search" type="text" class="st-default-search-input"/></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/06/04/java远程调用shell脚本/">java远程调用shell脚本</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/08/My-New-Post/">My New Post</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/08/hello-world/">Hello World</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//chant-1.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">Chant.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

_st('install','QyRncwx6yGnoWf2pnRoU','2.0.0');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?8006843039519956000";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>