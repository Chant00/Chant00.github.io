<!doctype html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  
    
      
    

    
  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Fredericka the Great:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hive,Hive原理及其搭建," />





  <link rel="alternate" href="/atom.xml" title="Chant" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="背景架构，原理，搭建，练习及优化">
<meta property="og:type" content="article">
<meta property="og:title" content="Hive学习笔记">
<meta property="og:url" content="http://chant00.com/2016/11/28/ Hive学习笔记/index.html">
<meta property="og:site_name" content="Chant">
<meta property="og:description" content="背景架构，原理，搭建，练习及优化">
<meta property="og:image" content="http://chant00.com/media/15048814182727.jpg">
<meta property="og:image" content="http://chant00.com/media/15048814470996.jpg">
<meta property="og:image" content="http://chant00.com/media/15048814849256.jpg">
<meta property="og:image" content="http://chant00.com/media/15048815124736.jpg">
<meta property="og:image" content="http://chant00.com/media/15048817164862.jpg">
<meta property="og:image" content="http://chant00.com/media/15048817356314.jpg">
<meta property="og:image" content="http://chant00.com/media/15048817617818.jpg">
<meta property="og:image" content="http://chant00.com/media/15048822400022.jpg">
<meta property="og:image" content="http://chant00.com/media/15048822812608.jpg">
<meta property="og:image" content="http://chant00.com/media/15048829956077.jpg">
<meta property="og:image" content="http://chant00.com/media/15048833740737.jpg">
<meta property="og:image" content="http://chant00.com/media/15048834912908.jpg">
<meta property="og:image" content="http://chant00.com/media/15048836221579.jpg">
<meta property="og:image" content="http://chant00.com/media/15048838369515.jpg">
<meta property="og:image" content="http://chant00.com/media/15048845300757.jpg">
<meta property="og:image" content="http://chant00.com/media/15048845407082.jpg">
<meta property="og:image" content="http://chant00.com/media/15048845611075.jpg">
<meta property="og:image" content="http://chant00.com/media/15048845745231.jpg">
<meta property="og:image" content="http://chant00.com/media/15048845860141.jpg">
<meta property="og:image" content="http://chant00.com/media/15048846302709.jpg">
<meta property="og:image" content="http://chant00.com/media/15048848890164.jpg">
<meta property="og:image" content="http://chant00.com/media/15048849054786.jpg">
<meta property="og:updated_time" content="2017-09-09T17:14:02.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hive学习笔记">
<meta name="twitter:description" content="背景架构，原理，搭建，练习及优化">
<meta name="twitter:image" content="http://chant00.com/media/15048814182727.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://chant00.com/2016/11/28/ Hive学习笔记/"/>





  <title>Hive学习笔记 | Chant</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?20a728b896cddba838b0448e60f910f5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>











  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Chant</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Take things as they are with a cavalier attitude./用漫不经心的态度过随遇而安的生活</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-favourite">
          <a href="/favourite" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            颜如玉
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://chant00.com/2016/11/28/ Hive学习笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chant">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chant">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Hive学习笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-28T08:47:49+08:00">
                2016-11-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Bigdata/" itemprop="url" rel="index">
                    <span itemprop="name">Bigdata</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Bigdata/Hive/" itemprop="url" rel="index">
                    <span itemprop="name">Hive</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/11/28/ Hive学习笔记/" class="leancloud_visitors" data-flag-title="Hive学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>背景架构，原理，搭建，练习及优化</p>
<a id="more"></a>
<h3 id="Hive的产生"><a href="#Hive的产生" class="headerlink" title="Hive的产生"></a>Hive的产生</h3><p>Hive产生的原因：<br>方便非java编程者（熟悉SQL语言）对hdfs的数据做mapreduce操作。<br>Hive是数据仓库<br>数据库：用户与数据库交互，提交SQL语句后，马上见到执行结果；存放业务数据；数据库提出范式的概念是为了解决数据冗余和耦合的问题；数据库给业务数据提供存储支撑。<br>数据仓库：不与用户交互；存放历史数据；反范式设计，专门引入冗余数据，保证数据完整。数据仓库面向分析，里面存放的数据用来做分析和挖掘。<br>Hive将SQL转化为MapReduce可以识别的操作，承担解释器、编译器、优化器等角色<br>Hive运行时，元数据（表的结构、属性）存储在关系型数据库里面。因为元数据信息需要高效的读取。</p>
<h3 id="Hive的架构"><a href="#Hive的架构" class="headerlink" title="Hive的架构"></a>Hive的架构</h3><p><img src="/media/15048814182727.jpg" alt=""><img src="/media/15048814470996.jpg" alt=""></p>
<p>用户接口主要有三个：Client（命令行），JDBC/ODBC 和 WEB GUI。其中最常用的是Client，Client启动的时候，会同时启动一个Hive副本。Client是Hive的客户端，用户连接至Hive Server。在启动 Client模式的时候，需要指出Hive Server所在节点，并且在该节点启动Hive Server。 WEB GUI是通过浏览器访问Hive。<br>     Hive将元数据存储在数据库中，如mysql、derby。Hive中的元数据包括表的名字，表的列和分区及其属性，表的属性（是否为外部表等），表的数据所在目录等。<br>解释器、编译器、优化器完成HQL查询语句从词法分析、语法分析、编译、优化以及查询计划的生成。生成的查询计划存储在HDFS中，并在随后有MapReduce调用执行。编译器将一个Hive QL转换操作符，操作符是Hive的最小的处理单元每个操作符代表HDFS的一个操作或者一道MapReduce作业。<br>Operator是hive定义的一个处理过程，是一个树形结构：<br>protected List <operator<? extends="" serializable="">&gt; childOperators;<br>protected List <operator<? extends="" serializable="">&gt; parentOperators;<br>protected boolean done; // 初始化值为false<br>Hive的数据存储在HDFS中，大部分的查询、计算由MapReduce完成（包含<em>的查询，比如select </em> from tbl不会生成MapRedcue任务）。<br><img src="/media/15048814849256.jpg" alt=""></operator<?></operator<?></p>
<h3 id="Hive语法解析"><a href="#Hive语法解析" class="headerlink" title="Hive语法解析"></a>Hive语法解析</h3><p>ANTLR词法语法分析工具解析HQL<br><img src="/media/15048815124736.jpg" alt=""></p>
<h3 id="Hive的三种模式"><a href="#Hive的三种模式" class="headerlink" title="Hive的三种模式"></a>Hive的三种模式</h3><h4 id="local模式"><a href="#local模式" class="headerlink" title="local模式"></a>local模式</h4><p>到一个In-memory的数据库Derby，一般用于Unit Test<br><img src="/media/15048817164862.jpg" alt=""></p>
<h4 id="单用户模式"><a href="#单用户模式" class="headerlink" title="单用户模式"></a>单用户模式</h4><p>通过网络连接到一个数据库中，是最经常使用到的模式。<br><img src="/media/15048817356314.jpg" alt=""></p>
<h4 id="多用户模式"><a href="#多用户模式" class="headerlink" title="多用户模式"></a>多用户模式</h4><p>远程服务器模式。用于非Java客户端访问元数据库，在服务器端启动MetaStoreServer，客户端利用Thrift协议通过MetaStoreServer访问元数据库。<br><img src="/media/15048817617818.jpg" alt=""></p>
<h3 id="Linux下安装MySQL"><a href="#Linux下安装MySQL" class="headerlink" title="Linux下安装MySQL"></a>Linux下安装MySQL</h3><h6 id="1-yum安装mysql"><a href="#1-yum安装mysql" class="headerlink" title="1.yum安装mysql"></a>1.yum安装mysql</h6><p>[root@node01 ~]# yum install mysql-server</p>
<h6 id="2-启动mysqld服务"><a href="#2-启动mysqld服务" class="headerlink" title="2.启动mysqld服务"></a>2.启动mysqld服务</h6><p>[root@node01 ~]# service mysqld start</p>
<h6 id="3-修改mysql修改权限"><a href="#3-修改mysql修改权限" class="headerlink" title="3.修改mysql修改权限"></a>3.修改mysql修改权限</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">[root@node01 ~]# mysql</div><div class="line">mysql&gt; show databases;</div><div class="line">mysql&gt; use mysql;</div><div class="line">mysql&gt; show tables;</div><div class="line">mysql&gt; select host,user from user;</div><div class="line">+------------------+------+</div><div class="line">| host       | user |</div><div class="line">+------------------+------+</div><div class="line">| 127.0.0.1   | root |</div><div class="line">| localhost   |    |</div><div class="line">| localhost   | root |</div><div class="line">| node01    |    |</div><div class="line">| node01    | root |</div><div class="line">+-----------------+-------+</div><div class="line">mysql&gt; GRANT ALL PRIVILEGES ON *.* TO &apos;root&apos;@&apos;%&apos; IDENTIFIED BY &apos;123456&apos; WITH GRANT OPTION;</div><div class="line">mysql&gt; select host,user from user;</div><div class="line">+--------------+------+</div><div class="line">| host      | user |</div><div class="line">+--------------+------+</div><div class="line">| %       | root |</div><div class="line">| 127.0.0.1 | root |</div><div class="line">| localhost |     |</div><div class="line">| localhost | root |</div><div class="line">| node01  |    |</div><div class="line">| node01  | root |</div><div class="line">+---------------+------+</div><div class="line">mysql&gt; delete from mysql.user where host != &apos;%&apos;;</div><div class="line">mysql&gt; flush privileges;</div></pre></td></tr></table></figure>
<h6 id="4-重新登录mysql"><a href="#4-重新登录mysql" class="headerlink" title="4.重新登录mysql"></a>4.重新登录mysql</h6><p>[root@node01 ~]# mysql -u root -p</p>
<h3 id="Hive安装"><a href="#Hive安装" class="headerlink" title="Hive安装"></a>Hive安装</h3><h4 id="本地模式（derby）"><a href="#本地模式（derby）" class="headerlink" title="本地模式（derby）"></a>本地模式（derby）</h4><p>这种方式是最简单的存储方式，只需要在hive-site.xml做如下配置便可<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0"?&gt;  </div><div class="line">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:derby:;databaseName=metastore_db;create=true<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionDriverName<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.derby.jdbc.EmbeddedDriver<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.local<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.warehouse.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>/user/hive/warehouse<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>注：使用derby存储方式时，运行hive会在当前目录生成一个derby文件和一个metastore_db目录。这种存储方式的弊端是在同一个目录下同时只能有一个hive客户端能使用数据库，否则会提示如下错误<br>[html] view plaincopyprint?<br>hive&gt; show tables;<br>FAILED: Error in metadata: javax.jdo.JDOFatalDataStoreException: Failed to start database ‘metastore_db’, see the next exception for details.<br>NestedThrowables:<br>java.sql.SQLException: Failed to start database ‘metastore_db’, see the next exception for details. FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask  </p>
<h4 id="单用户模式（mysql）"><a href="#单用户模式（mysql）" class="headerlink" title="单用户模式（mysql）"></a>单用户模式（mysql）</h4><p>这种存储方式需要在本地运行一个mysql服务器，并作如下配置（下面两种使用mysql的方式，需要将mysql的jar包拷贝到$HIVE_HOME/lib目录下）。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0"?&gt;  </div><div class="line">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </div><div class="line"><span class="comment">&lt;!-- hive_remote 是数据库名称，同时安装不同的模式，连接的数据库要不同--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.warehouse.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>/user/hive_remote/warehouse<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.local<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:mysql://localhost/hive_remote?createDatabaseIfNotExist=true<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionDriverName<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionUserName<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>hive<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionPassword<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>password<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="多用户模式-1"><a href="#多用户模式-1" class="headerlink" title="多用户模式"></a>多用户模式</h4><h5 id="Remot一体"><a href="#Remot一体" class="headerlink" title="Remot一体"></a>Remot一体</h5><p>这种存储方式需要在远端服务器运行一个mysql服务器，并且需要在Hive服务器启动meta服务。<br>这里用mysql的测试服务器，ip位192.168.1.214，新建hive_remote数据库，字符集latine1<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0"?&gt;  </div><div class="line">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.warehouse.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>/user/hive/warehouse<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:mysql://192.168.57.6:3306/hive?createDatabaseIfNotExist=true<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionDriverName<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionUserName<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>hive<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionPassword<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>password<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.local<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.uris<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>thrift://192.168.1.188:9083<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">  </div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>注：这里把hive的服务端和客户端都放在同一台服务器上了。服务端和客户端可以拆开。</p>
<h5 id="Remot分开"><a href="#Remot分开" class="headerlink" title="Remot分开"></a>Remot分开</h5><p>将hive-site.xml配置文件拆为如下两部分</p>
<h6 id="服务端配置文件"><a href="#服务端配置文件" class="headerlink" title="服务端配置文件"></a>服务端配置文件</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0"?&gt;  </div><div class="line">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.warehouse.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>/user/hive/warehouse<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:mysql://192.168.57.6:3306/hive?createDatabaseIfNotExist=true<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionDriverName<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionUserName<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionPassword<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure>
<h6 id="客户端配置文件"><a href="#客户端配置文件" class="headerlink" title="客户端配置文件"></a>客户端配置文件</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0"?&gt;  </div><div class="line">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.warehouse.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>/user/hive/warehouse<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.local<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.uris<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>thrift://192.168.57.5:9083<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">  </div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="安装单用户模式具体步骤"><a href="#安装单用户模式具体步骤" class="headerlink" title="安装单用户模式具体步骤"></a>安装单用户模式具体步骤</h4><h6 id="1-解压hive安装包"><a href="#1-解压hive安装包" class="headerlink" title="1.解压hive安装包"></a>1.解压hive安装包</h6><p>[root@node02 sxt]# tar xf apache-hive-1.2.1-bin.tar.gz</p>
<h6 id="2-配置环境变量"><a href="#2-配置环境变量" class="headerlink" title="2.配置环境变量"></a>2.配置环境变量</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@node02 sxt]# vi + /etc/profile</div><div class="line">export HIVE_PREFIX=/opt/sxt/apache-hive-1.2.1-bin</div><div class="line">export PATH=$JAVA_HOME/bin:$PATH:$HADOOP_PREFIX/bin:$HADOOP_PREFIX/sbin:$ZOOKEEPER_PREFIX/bin:$HIVE_PREFIX/bin</div><div class="line">[root@node02 apache-hive-1.2.1-bin]# . /etc/profile</div></pre></td></tr></table></figure>
<h6 id="3-修改配置文件"><a href="#3-修改配置文件" class="headerlink" title="3.修改配置文件"></a>3.修改配置文件</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[root@node02 sxt]# cd apache-hive-1.2.1-bin/conf</div><div class="line">[root@node02 conf]# cp hive-default.xml.template hive-site.xml</div><div class="line">[root@node02 conf]# vi hive-site.xml</div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span> </div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.warehouse.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/user/hive_remote/warehouse<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.local<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:mysql://node01/hive_remote?createDatabaseIfNotExist=true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionDriverName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionUserName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </div><div class="line">   </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionPassword<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure>
<h6 id="4-把JDBC驱动包放到Hive-lib目录下"><a href="#4-把JDBC驱动包放到Hive-lib目录下" class="headerlink" title="4.把JDBC驱动包放到Hive lib目录下"></a>4.把JDBC驱动包放到Hive lib目录下</h6><h6 id="5-让hadoop的jline包和hive的jline包版本保持一致（高版本替换低版本）"><a href="#5-让hadoop的jline包和hive的jline包版本保持一致（高版本替换低版本）" class="headerlink" title="5.让hadoop的jline包和hive的jline包版本保持一致（高版本替换低版本）"></a>5.让hadoop的jline包和hive的jline包版本保持一致（高版本替换低版本）</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@node02 conf]# cd /opt/sxt/apache-hive-1.2.1-bin/lib</div><div class="line">[root@node02 conf]# cp jline-2.12.jar /opt/sxt/hadoop-2.6.5/share/hadoop/yarn/lib/</div><div class="line">[root@node02 conf]# cd /opt/sxt/hadoop-2.6.5/share/hadoop/yarn/lib/</div><div class="line">[root@node02 lib]# rm -f jline-0.9.94.jar</div></pre></td></tr></table></figure>
<h6 id="6-启动Hive"><a href="#6-启动Hive" class="headerlink" title="6.启动Hive"></a>6.启动Hive</h6><p>[root@node02 lib]# hive<br>hive&gt;<br>客户端启动的时候要注意：<br>[ERROR] Terminal initialization failed; falling back to unsupported<br>java.lang.IncompatibleClassChangeError: Found class jline.Terminal, but interface was expected<br>    at jline.TerminalFactory.create(TerminalFactory.java:101)<br>错误的原因： Hadoop jline版本和hive的jline不一致</p>
<p>一些简单的操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">hive&gt; create table table01 (id int, name string);</div><div class="line">hive&gt; show tables;</div><div class="line">hive&gt; desc table01;</div><div class="line">hive&gt; insert into table01 values(1,&apos;Jed&apos;);</div></pre></td></tr></table></figure></p>
<p><img src="/media/15048822400022.jpg" alt=""></p>
<h4 id="安装多用户模式具体步骤"><a href="#安装多用户模式具体步骤" class="headerlink" title="安装多用户模式具体步骤"></a>安装多用户模式具体步骤</h4><h5 id="角色划分"><a href="#角色划分" class="headerlink" title="角色划分"></a>角色划分</h5><p><img src="/media/15048822812608.jpg" alt=""></p>
<h5 id="1-将hive文件夹copy到node04、node04"><a href="#1-将hive文件夹copy到node04、node04" class="headerlink" title="1.将hive文件夹copy到node04、node04"></a>1.将hive文件夹copy到node04、node04</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@node02 sxt]# scp -r apache-hive-1.2.1-bin node03:`pwd`</div><div class="line">[root@node02 sxt]# scp -r apache-hive-1.2.1-bin node04:`pwd`</div></pre></td></tr></table></figure>
<h5 id="2-把node02的环境变量配置文件copy到node03、node04"><a href="#2-把node02的环境变量配置文件copy到node03、node04" class="headerlink" title="2.把node02的环境变量配置文件copy到node03、node04"></a>2.把node02的环境变量配置文件copy到node03、node04</h5><p>[root@node02 sxt]# scp /etc/profile node03:/etc/<br>[root@node02 sxt]# scp /etc/profile node04:/etc/<br>[root@node03 ~]# . /etc/profile<br>[root@node04 ~]# . /etc/profile</p>
<h5 id="3-修改node03（客户端）的-hive的配置文件"><a href="#3-修改node03（客户端）的-hive的配置文件" class="headerlink" title="3.    修改node03（客户端）的 hive的配置文件"></a>3.    修改node03（客户端）的 hive的配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@node03 conf]# vi hive-site.xml</div><div class="line">&lt;configuration&gt;</div><div class="line">  </div><div class="line">&lt;property&gt;  </div><div class="line">    &lt;name&gt;hive.metastore.warehouse.dir&lt;/name&gt;  </div><div class="line">    &lt;value&gt;/user/hive/warehouse&lt;/value&gt;  </div><div class="line">&lt;/property&gt;  </div><div class="line">   </div><div class="line">&lt;property&gt;  </div><div class="line">    &lt;name&gt;hive.metastore.local&lt;/name&gt;  </div><div class="line">    &lt;value&gt;false&lt;/value&gt;  </div><div class="line">&lt;/property&gt;  </div><div class="line">  </div><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;hive.metastore.uris&lt;/name&gt;</div><div class="line">    &lt;value&gt;thrift://node04:9083&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line">  </div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<h5 id="4-修改node04（服务端）的配置文件"><a href="#4-修改node04（服务端）的配置文件" class="headerlink" title="4.修改node04（服务端）的配置文件"></a>4.修改node04（服务端）的配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">[root@node04 conf]# vi hive-site.xml</div><div class="line">&lt;configuration&gt; </div><div class="line">  </div><div class="line">&lt;property&gt;  </div><div class="line">    &lt;name&gt;hive.metastore.warehouse.dir&lt;/name&gt;  </div><div class="line">    &lt;value&gt;/user/hive/warehouse&lt;/value&gt;  </div><div class="line">&lt;/property&gt;  </div><div class="line">   </div><div class="line">&lt;property&gt;  </div><div class="line">    &lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;  </div><div class="line">    &lt;value&gt;jdbc:mysql://node01:3306/hive?createDatabaseIfNotExist=true&lt;/value&gt;</div><div class="line">&lt;/property&gt;  </div><div class="line">   </div><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;javax.jdo.option.ConnectionDriverName&lt;/name&gt;</div><div class="line">    &lt;value&gt;com.mysql.jdbc.Driver&lt;/value&gt;</div><div class="line">&lt;/property&gt;  </div><div class="line"></div><div class="line">&lt;property&gt;  </div><div class="line">&lt;name&gt;javax.jdo.option.ConnectionUserName&lt;/name&gt;</div><div class="line">&lt;value&gt;root&lt;/value&gt;</div><div class="line">&lt;/property&gt;  </div><div class="line"></div><div class="line">&lt;property&gt;  </div><div class="line">    &lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;</div><div class="line">    &lt;value&gt;123456&lt;/value&gt;</div><div class="line">&lt;/property&gt;  </div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<h5 id="5-使node03和node04的jline包和hadoop包保持版本一致"><a href="#5-使node03和node04的jline包和hadoop包保持版本一致" class="headerlink" title="5.使node03和node04的jline包和hadoop包保持版本一致"></a>5.使node03和node04的jline包和hadoop包保持版本一致</h5><h5 id="6-启动hive服务端"><a href="#6-启动hive服务端" class="headerlink" title="6.启动hive服务端"></a>6.启动hive服务端</h5><p>[root@node04 [root@node04 [root@node04 lib]# hive –service metastore</p>
<h5 id="7-启动客户端"><a href="#7-启动客户端" class="headerlink" title="7.启动客户端"></a>7.启动客户端</h5><p>[root@node03 lib]# hive<br>注意：mysql驱动包放置在服务器端，jline放置在客户端</p>
<h3 id="Hive的数据类型"><a href="#Hive的数据类型" class="headerlink" title="Hive的数据类型"></a>Hive的数据类型</h3><h4 id="primitive-type："><a href="#primitive-type：" class="headerlink" title="primitive_type："></a>primitive_type：</h4><p>array_type、 map_type、struct_type<br>TINYINT、SMALLINT、INT、BIGINT、BOOLEAN、FLOAT、DOUBLE、STRING</p>
<h3 id="DDL（Data-Definition-Language）"><a href="#DDL（Data-Definition-Language）" class="headerlink" title="DDL（Data Definition Language）"></a>DDL（Data Definition Language）</h3><h4 id="Create-Database"><a href="#Create-Database" class="headerlink" title="Create Database"></a>Create Database</h4><p>CREATE (DATABASE|SCHEMA) [IF NOT EXISTS] database_name<br>  [COMMENT database_comment]<br>  [LOCATION hdfs_path]<br>  [WITH DBPROPERTIES (property_name=property_value, …)];</p>
<h4 id="Drop-Database"><a href="#Drop-Database" class="headerlink" title="Drop Database"></a>Drop Database</h4><p>DROP (DATABASE|SCHEMA) [IF EXISTS] database_name [RESTRICT|CASCADE];</p>
<h4 id="Alter-Database"><a href="#Alter-Database" class="headerlink" title="Alter Database"></a>Alter Database</h4><p>ALTER (DATABASE|SCHEMA) database_name SET DBPROPERTIES (property_name=property_value, …);   – (Note: SCHEMA added in Hive 0.14.0)</p>
<p>ALTER (DATABASE|SCHEMA) database_name SET OWNER [USER|ROLE] user_or_role;   – (Note: Hive 0.13.0 and later; SCHEMA added in Hive 0.14.0)</p>
<h4 id="Use-Database"><a href="#Use-Database" class="headerlink" title="Use Database"></a>Use Database</h4><p>USE database_name;<br>USE DEFAULT;</p>
<h4 id="Create-Table"><a href="#Create-Table" class="headerlink" title="Create Table"></a>Create Table</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">CREATE [TEMPORARY] [EXTERNAL] TABLE [IF NOT EXISTS] [db_name.]table_name    -- (Note: TEMPORARY available in Hive 0.14.0 and later)</div><div class="line">  [(col_name data_type [COMMENT col_comment], ... [constraint_specification])]</div><div class="line">  [COMMENT table_comment]</div><div class="line">  [PARTITIONED BY (col_name data_type [COMMENT col_comment], ...)]</div><div class="line">  [CLUSTERED BY (col_name, col_name, ...) [SORTED BY (col_name [ASC|DESC], ...)] INTO num_buckets BUCKETS]</div><div class="line">  [SKEWED BY (col_name, col_name, ...)                  -- (Note: Available in Hive 0.10.0 and later)]</div><div class="line">     ON ((col_value, col_value, ...), (col_value, col_value, ...), ...)</div><div class="line">     [STORED AS DIRECTORIES]</div><div class="line">  [</div><div class="line">   [ROW FORMAT row_format] </div><div class="line">   [STORED AS file_format]</div><div class="line">     | STORED BY &apos;storage.handler.class.name&apos; [WITH SERDEPROPERTIES (...)]  -- (Note: Available in Hive 0.6.0 and later)</div><div class="line">  ]</div><div class="line">  [LOCATION hdfs_path]</div><div class="line">  [TBLPROPERTIES (property_name=property_value, ...)]   -- (Note: Available in Hive 0.6.0 and later)</div><div class="line">  [AS select_statement];   -- (Note: Available in Hive 0.5.0 and later; not supported for external tables)</div><div class="line"> </div><div class="line">CREATE [TEMPORARY] [EXTERNAL] TABLE [IF NOT EXISTS] [db_name.]table_name</div><div class="line">  LIKE existing_table_or_view_name</div><div class="line">  [LOCATION hdfs_path];</div><div class="line"> </div><div class="line">data_type</div><div class="line">  : primitive_type</div><div class="line">  | array_type</div><div class="line">  | map_type</div><div class="line">  | struct_type</div><div class="line">  | union_type  -- (Note: Available in Hive 0.7.0 and later)</div><div class="line"> </div><div class="line">primitive_type</div><div class="line">  : TINYINT</div><div class="line">  | SMALLINT</div><div class="line">  | INT</div><div class="line">  | BIGINT</div><div class="line">  | BOOLEAN</div><div class="line">  | FLOAT</div><div class="line">  | DOUBLE</div><div class="line">  | DOUBLE PRECISION -- (Note: Available in Hive 2.2.0 and later)</div><div class="line">  | STRING</div><div class="line">  | BINARY      -- (Note: Available in Hive 0.8.0 and later)</div><div class="line">  | TIMESTAMP   -- (Note: Available in Hive 0.8.0 and later)</div><div class="line">  | DECIMAL     -- (Note: Available in Hive 0.11.0 and later)</div><div class="line">  | DECIMAL(precision, scale)  -- (Note: Available in Hive 0.13.0 and later)</div><div class="line">  | DATE        -- (Note: Available in Hive 0.12.0 and later)</div><div class="line">  | VARCHAR     -- (Note: Available in Hive 0.12.0 and later)</div><div class="line">  | CHAR        -- (Note: Available in Hive 0.13.0 and later)</div><div class="line"> </div><div class="line">array_type</div><div class="line">  : ARRAY &lt; data_type &gt;</div><div class="line"> </div><div class="line">map_type</div><div class="line">  : MAP &lt; primitive_type, data_type &gt;</div><div class="line"> </div><div class="line">struct_type</div><div class="line">  : STRUCT &lt; col_name : data_type [COMMENT col_comment], ...&gt;</div><div class="line"> </div><div class="line">union_type</div><div class="line">   : UNIONTYPE &lt; data_type, data_type, ... &gt;  -- (Note: Available in Hive 0.7.0 and later)</div><div class="line"> </div><div class="line">row_format</div><div class="line">  : DELIMITED [FIELDS TERMINATED BY char [ESCAPED BY char]] [COLLECTION ITEMS TERMINATED BY char]</div><div class="line">        [MAP KEYS TERMINATED BY char] [LINES TERMINATED BY char（换行符，默认&apos;\n&apos;）]</div><div class="line">        [NULL DEFINED AS char]   -- (Note: Available in Hive 0.13 and later)</div><div class="line">  | SERDE serde_name [WITH SERDEPROPERTIES (property_name=property_value, property_name=property_value, ...)]</div><div class="line"> </div><div class="line">file_format:</div><div class="line">  : SEQUENCEFILE</div><div class="line">  | TEXTFILE    -- (Default, depending on hive.default.fileformat configuration)</div><div class="line">  | RCFILE      -- (Note: Available in Hive 0.6.0 and later)</div><div class="line">  | ORC         -- (Note: Available in Hive 0.11.0 and later)</div><div class="line">  | PARQUET     -- (Note: Available in Hive 0.13.0 and later)</div><div class="line">  | AVRO        -- (Note: Available in Hive 0.14.0 and later)</div><div class="line">  | INPUTFORMAT input_format_classname OUTPUTFORMAT output_format_classname</div><div class="line"> </div><div class="line">constraint_specification:</div><div class="line">  : [, PRIMARY KEY (col_name, ...) DISABLE NOVALIDATE ]</div><div class="line">[, CONSTRAINT constraint_name FOREIGN KEY (col_name, ...) REFERENCES table_name(col_name, ...) DISABLE NOVALIDATE</div></pre></td></tr></table></figure>
<h4 id="示例练习"><a href="#示例练习" class="headerlink" title="示例练习"></a>示例练习</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">人员表</div><div class="line">id、name、hobbyies、address</div><div class="line"></div><div class="line">1,Jed,book-lol-game,beijing:haidian-shanghai:pudong</div><div class="line">2,Tom,book-lol-lanqiu,beijing:xisanqi-shanghai:lujiazui</div><div class="line">内部表：数据存放在配置文件指定的目录下，删除内部表后，其中的数据也会删除</div><div class="line">&lt;property&gt;  </div><div class="line">&lt;name&gt;hive.metastore.warehouse.dir&lt;/name&gt;  </div><div class="line">&lt;value&gt;/user/hive/warehouse&lt;/value&gt;  </div><div class="line">&lt;/property&gt;</div><div class="line"></div><div class="line">create table person0 (</div><div class="line">id int,</div><div class="line">name string,</div><div class="line">hobbies ARRAY&lt;string&gt;,</div><div class="line">address MAP&lt;string,string&gt;</div><div class="line">)</div><div class="line">ROW FORMAT DELIMITED </div><div class="line">FIELDS TERMINATED BY ','  #字段之间用','分隔</div><div class="line">COLLECTION ITEMS TERMINATED BY '-'  #数组元素之间用'-'分隔</div><div class="line">MAP KEYS TERMINATED BY ':';  #Map元素之间用':'分隔</div><div class="line"></div><div class="line">外部表：数据存放在建表时自定义的路径下，删除外部表后，其中的数据没有被删除，只是删除了元数据</div><div class="line">create EXTERNAL table person1 (</div><div class="line">id int,</div><div class="line">name string,</div><div class="line">likes ARRAY&lt;string&gt;,</div><div class="line">address MAP&lt;string,string&gt;</div><div class="line">)</div><div class="line">ROW FORMAT DELIMITED </div><div class="line">FIELDS TERMINATED BY ','  </div><div class="line">COLLECTION ITEMS TERMINATED BY '-' </div><div class="line">MAP KEYS TERMINATED BY ':'</div><div class="line">LOCATION '/user/root/person1';</div><div class="line"></div><div class="line">create table person2 as select id, hobbies from person0;  #MapReduce</div><div class="line"></div><div class="line">create table create table person3 like person0;  #不是MapReduce任务</div></pre></td></tr></table></figure>
<h4 id="Loading-files-into-tables"><a href="#Loading-files-into-tables" class="headerlink" title="Loading files into tables"></a>Loading files into tables</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> [<span class="keyword">LOCAL</span>] INPATH <span class="string">'filepath'</span> [OVERWRITE] <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename [<span class="keyword">PARTITION</span> (partcol1=val1, partcol2=val2 ...)]</div><div class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/tmp/data/person0_data'</span> <span class="keyword">into</span> <span class="keyword">table</span> person0;</div></pre></td></tr></table></figure>
<h4 id="内部表与外部表的区别"><a href="#内部表与外部表的区别" class="headerlink" title="内部表与外部表的区别"></a>内部表与外部表的区别</h4><p>1）创建表时：创建内部表时，会将数据移动到数据仓库指向的路径；若创建外部表，仅记录数据所在的路径， 不对数据的位置做任何改变。<br>2）删除表时：在删除表的时候，内部表的元数据和数据会被一起删除， 而外部表只删除元数据，不删除数据。这样外部表相对来说更加安全些，数据组织也更加灵活，方便共享源数据。 </p>
<p>另外需要注意的是传统数据库对表数据验证是 schema on write（写时模式），而 Hive 在load时是不检查数据是否符合schema的，hive 遵循的是 schema on read（读时模式），只有在读的时候hive才检查、解析具体的 数据字段、schema。<br>读时模式的优势是load data 非常迅速，因为它不需要读取数据进行解析，仅仅进行文件的复制或者移动。<br>写时模式的优势是提升了查询性能，因为预先解析之后可以对列建立索引，并压缩，但这样也会花费要多的加载时间。 </p>
<h4 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h4><p>分区：分区的字段不能是表中已有的字段<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> person4 (</div><div class="line"><span class="keyword">id</span> <span class="built_in">int</span>,</div><div class="line"><span class="keyword">name</span> <span class="keyword">string</span>,</div><div class="line">likes <span class="built_in">ARRAY</span>&lt;<span class="keyword">string</span>&gt;,</div><div class="line">address <span class="keyword">MAP</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;</div><div class="line">)</div><div class="line">PARTITIONED <span class="keyword">BY</span> (sex <span class="keyword">string</span>)</div><div class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span> </div><div class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span>  </div><div class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'-'</span> </div><div class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span>;</div><div class="line"></div><div class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/tmp/data/person0_data'</span> <span class="keyword">into</span> <span class="keyword">table</span> person4 <span class="keyword">PARTITION</span> (sex=<span class="string">'1'</span>);</div><div class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/tmp/data/person0_data'</span> <span class="keyword">into</span> <span class="keyword">table</span> person4 <span class="keyword">PARTITION</span> (sex=<span class="string">'2'</span>);</div></pre></td></tr></table></figure></p>
<p><img src="/media/15048829956077.jpg" alt=""><br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">hive&gt; select * from person4;</div><div class="line">1	Jed	["book","lol"]	&#123;"beijing":"chaoyang"&#125;	1</div><div class="line">2	Tom	["book","lol","sports"]	&#123;"beijing":"chaoyang","shanghai":"pudong"&#125;	1</div><div class="line">3	Cat	["book","lol","sports","music"]	&#123;"beijing":"chaoyang","shanghai":"pudong","shanxi":"taiyuan"&#125;	1</div><div class="line">1	Jed	["book","lol"]	&#123;"beijing":"chaoyang"&#125;	2</div><div class="line">2	Tom	["book","lol","sports"]	&#123;"beijing":"chaoyang","shanghai":"pudong"&#125;	2</div><div class="line">3	Cat	["book","lol","sports","music"]	&#123;"beijing":"chaoyang","shanghai":"pudong","shanxi":"taiyuan"&#125;	2</div><div class="line">hive&gt; select * from person4 where sex="1";</div><div class="line">1	Jed	["book","lol"]	&#123;"beijing":"chaoyang"&#125;	1</div><div class="line">2	Tom	["book","lol","sports"]	&#123;"beijing":"chaoyang","shanghai":"pudong"&#125;	1</div><div class="line">3	Cat	["book","lol","sports","music"]	&#123;"beijing":"chaoyang","shanghai":"pudong","shanxi":"taiyuan"&#125;	1</div><div class="line"></div><div class="line">create table person6 (</div><div class="line">id int,</div><div class="line">name string,</div><div class="line">likes ARRAY&lt;string&gt;,</div><div class="line">address MAP&lt;string,string&gt;</div><div class="line">)</div><div class="line">PARTITIONED BY (sex string, age int)</div><div class="line">ROW FORMAT DELIMITED </div><div class="line">FIELDS TERMINATED BY ','  </div><div class="line">COLLECTION ITEMS TERMINATED BY '-' </div><div class="line">MAP KEYS TERMINATED BY ':';</div><div class="line"></div><div class="line">hive&gt; load data local inpath '/tmp/data/person6_data' into table person6 PARTITION (sex='1',age=18);</div><div class="line">hive&gt; load data local inpath '/tmp/data/person6_data' into table person6 PARTITION (sex='2',age=18);</div><div class="line">hive&gt; load data local inpath '/tmp/data/person6_data' into table person6 PARTITION (sex='3',age=20);</div><div class="line"></div><div class="line">添加/删除分区，内部表删除分区后该分区下的数据也会被删除，外部表删除分区后该分区下的数据不会被删除</div><div class="line">ALTER TABLE person4 add PARTITION (sex='3');</div><div class="line">ALTER TABLE person6 drop PARTITION (sex='1',age=18);</div><div class="line">ALTER TABLE person6 drop PARTITION (sex='2');#会删除sex='2'和age=18</div><div class="line">ALTER TABLE person4 drop PARTITION (age=20); #会删除sex='3'和age=20</div></pre></td></tr></table></figure></p>
<h3 id="DML（Data-Manipulation-Language）"><a href="#DML（Data-Manipulation-Language）" class="headerlink" title="DML（Data Manipulation Language）"></a>DML（Data Manipulation Language）</h3><p>load data inpath ‘hdfs path’ into table table_name<br>这个操作实际是把hdfs path下的文件移动到了hive配置的存放的数据的目录下<br>load data local inpath ‘hdfs path’ into table table_name<br>这个操作实际是把本地的文件上传到hdfs 的临时目录下，然后把该文件移动到了hive配置的存放的数据的目录下<br>多次load相同的文件，数据会追加，而不是覆盖<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">hive&gt; create table person7 like person0;</div><div class="line">常用于分析某张表，把结果放入另一张表</div><div class="line">from log</div><div class="line">insert into table result</div><div class="line">select ……</div><div class="line">hive&gt; from person0</div><div class="line">    &gt; insert into table person7</div><div class="line">&gt; select id,name,hobbies,address;</div></pre></td></tr></table></figure></p>
<h3 id="使用Beeline连接Hive"><a href="#使用Beeline连接Hive" class="headerlink" title="使用Beeline连接Hive"></a>使用Beeline连接Hive</h3><h4 id="服务端启动hiveserver2"><a href="#服务端启动hiveserver2" class="headerlink" title="服务端启动hiveserver2"></a>服务端启动hiveserver2</h4><p>[root@node04 ~]# hiveserver2</p>
<h4 id="客户端进入beeline并连接"><a href="#客户端进入beeline并连接" class="headerlink" title="客户端进入beeline并连接"></a>客户端进入beeline并连接</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@node03 ~]# beeline</div><div class="line">Beeline version 1.2.1 by Apache Hive</div><div class="line">beeline&gt; !connect jdbc:hive2://node04:10000</div><div class="line">Connecting to jdbc:hive2://node04:10000</div><div class="line">Enter username for jdbc:hive2://node04:10000: root</div><div class="line">Enter password for jdbc:hive2://node04:10000: ******</div><div class="line">Connected to: Apache Hive (version 1.2.1)</div><div class="line">Driver: Hive JDBC (version 1.2.1)</div><div class="line">Transaction isolation: TRANSACTION_REPEATABLE_READ</div><div class="line">0: jdbc:hive2://node04:10000&gt;</div></pre></td></tr></table></figure>
<h4 id="退出连接"><a href="#退出连接" class="headerlink" title="退出连接"></a>退出连接</h4><p>0: jdbc:hive2://node04:10000&gt; !quit</p>
<h4 id="另一种连接方法"><a href="#另一种连接方法" class="headerlink" title="另一种连接方法"></a>另一种连接方法</h4><p><code>[root@node03 ~]# beeline -u jdbc:hive2//node04:10000 -n root</code></p>
<h3 id="Hive-JDBC"><a href="#Hive-JDBC" class="headerlink" title="Hive JDBC"></a>Hive JDBC</h3><p>项目依赖包：hive安装包lib根目录下所有包，hadoop项目依赖的包<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sxt.hive.jdbc;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.sql.SQLException;</div><div class="line"><span class="keyword">import</span> java.sql.Connection;</div><div class="line"><span class="keyword">import</span> java.sql.ResultSet;</div><div class="line"><span class="keyword">import</span> java.sql.Statement;</div><div class="line"><span class="keyword">import</span> java.sql.DriverManager;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HiveJDBC</span> </span>&#123;</div><div class="line">     <span class="keyword">private</span> <span class="keyword">static</span> String driverName = <span class="string">"org.apache.hive.jdbc.HiveDriver"</span>;</div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></div><div class="line"><span class="keyword">throws</span> SQLException &#123;</div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">              Class.forName(driverName);</div><div class="line">         &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">              e.printStackTrace();</div><div class="line">              System.exit(<span class="number">1</span>);</div><div class="line">         &#125;</div><div class="line">         </div><div class="line">         Connection conn = DriverManager.getConnection(</div><div class="line">            <span class="string">"jdbc:hive2://node04:10000/default"</span>, <span class="string">"root"</span>, <span class="string">""</span>);</div><div class="line">         </div><div class="line">         Statement stmt = conn.createStatement();</div><div class="line">         </div><div class="line">         String sql = <span class="string">"select * from person7 limit 5"</span>;</div><div class="line">         ResultSet res = stmt.executeQuery(sql);</div><div class="line">         <span class="keyword">while</span> (res.next()) &#123;</div><div class="line">              <span class="comment">//输出第1列和name那一列</span></div><div class="line">              System.out.println(res.getString(<span class="number">1</span>) </div><div class="line">+ <span class="string">"-"</span> </div><div class="line">+ res.getString(<span class="string">"name"</span>));</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Regex"><a href="#Regex" class="headerlink" title="Regex"></a>Regex</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">数据：</div><div class="line">192.168.57.4 - - [29/Feb/2016:18:14:35 +0800] "GET /bg-upper.png HTTP/1.1" 304 -</div><div class="line">192.168.57.4 - - [29/Feb/2016:18:14:35 +0800] "GET /bg-button.png HTTP/1.1" 304 -</div><div class="line">192.168.57.4 - - [29/Feb/2016:18:14:36 +0800] "GET / HTTP/1.1" 200 11217</div><div class="line">SQL：</div><div class="line">CREATE TABLE log (</div><div class="line">host STRING,</div><div class="line">identity STRING,</div><div class="line">t_user STRING,</div><div class="line">time STRING,</div><div class="line">request STRING,</div><div class="line">referer STRING,</div><div class="line">agent STRING</div><div class="line">)</div><div class="line">ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.RegexSerDe'</div><div class="line">WITH SERDEPROPERTIES (</div><div class="line">"input.regex" = "([^ ]*) ([^ ]*) ([^ ]*) \\[(.*)\\] \"(.*)\" (-|[0-9]*) (-|[0-9]*)"</div><div class="line">)</div><div class="line">STORED AS TEXTFILE;</div><div class="line"></div><div class="line">load data local inpath "/tmp/data/log.txt" into table log;</div><div class="line"></div><div class="line">hive&gt; select * from log;</div><div class="line">192.168.57.4	-	-	29/Feb/2016:18:14:35 +0800	GET /bg-upper.png HTTP/1.1	304	-</div><div class="line">192.168.57.4	-	-	29/Feb/2016:18:14:35 +0800	GET /bg-button.png HTTP/1.1	304	-</div><div class="line">192.168.57.4	-	-	29/Feb/2016:18:14:36 +0800	GET / HTTP/1.1	200	11217</div><div class="line">ROW FORMAT不会破坏原数据的结构</div></pre></td></tr></table></figure>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>内置函数参见官网</p>
<h4 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h4><p>自定义函数包括三种UDF、UDAF、UDTF<br>UDF(User-Defined-Function) 一进一出<br>UDAF(User- Defined Aggregation Funcation) 聚集函数，多进一出。如Count/max/min<br>UDTF(User-Defined Table-Generating Functions)&#160; 一进多出，如lateral view explore()<br>使用方式 ：在HIVE会话中add 自定义函数的jar文件，然后创建function继而使用函数</p>
<h4 id="UDF开发"><a href="#UDF开发" class="headerlink" title="UDF开发"></a>UDF开发</h4><p>1)    UDF函数可以直接应用于select语句，对查询结构做格式化处理后，再输出内容。<br>2)    编写UDF函数的时候需要注意一下几点：<br>a)    自定义UDF需要继承org.apache.hadoop.hive.ql.UDF。<br>b)    需要实现evaluate函数，evaluate函数支持重载。<br>3)    步骤<br>a)    把程序打包放到目标机器上去；<br>b)    进入hive客户端，添加jar包：hive&gt;add jar /run/jar/udf_test.jar;<br>c)    创建临时函数：hive&gt;CREATE TEMPORARY FUNCTION add_example AS ‘hive.udf.Add’;<br>d)    查询HQL语句：<br>    SELECT add_example(8, 9) FROM scores;<br>    SELECT add_example(scores.math, scores.art) FROM scores;<br>    SELECT add_example(6, 7, 8, 6.8) FROM scores;<br>e)    销毁临时函数：hive&gt; DROP TEMPORARY FUNCTION add_example;</p>
<h4 id="UDAF自定义集函数"><a href="#UDAF自定义集函数" class="headerlink" title="UDAF自定义集函数"></a>UDAF自定义集函数</h4><p>多行进一行出，如sum()、min()，用在group  by时<br>1)    必须继承<br>org.apache.hadoop.hive.ql.exec.UDAF(函数类继承)<br>org.apache.hadoop.hive.ql.exec.UDAFEvaluator<br>(内部类Evaluator实现UDAFEvaluator接口)<br>2)    Evaluator需要实现 init、iterate、terminatePartial、merge、terminate这几个函数init():类似于构造函数，用于UDAF的初始化<br>iterate():接收传入的参数，并进行内部的轮转，返回boolean<br>terminatePartial():无参数，其为iterate函数轮转结束后，返回轮转数据，类似于hadoop的Combiner<br>merge():接收terminatePartial的返回结果，进行数据merge操作，其返回类型为boolean<br>terminate():返回最终的聚集函数结果<br>3)    开发一个功能同：<br>Oracle的wm_concat()函数<br>Mysql的group_concat()<br>Hive UDF的数据类型<br><img src="/media/15048833740737.jpg" alt=""></p>
<h4 id="案例-输出数据时部分内容显示为“-”"><a href="#案例-输出数据时部分内容显示为“-”" class="headerlink" title="案例-输出数据时部分内容显示为“*”"></a>案例-输出数据时部分内容显示为“*”</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sxt.hive.udf;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.exec.UDF;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestUDF</span> <span class="keyword">extends</span> <span class="title">UDF</span></span>&#123;</div><div class="line"></div><div class="line">     <span class="comment">//输出信息时部分内容用*代替</span></div><div class="line">     <span class="function"><span class="keyword">public</span> Text <span class="title">evaluate</span><span class="params">(<span class="keyword">final</span> Text s)</span> </span>&#123;</div><div class="line">         <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">         &#125;</div><div class="line">         String str = s.toString().substring(<span class="number">0</span>, <span class="number">3</span>) + <span class="string">"***"</span>;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">new</span> Text(str);</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">步骤：</div><div class="line">1.	打成jar包</div><div class="line">2.	上传到Hive客户端</div><div class="line">3.	hive&gt; add jar /root/TestUDF.jar;</div><div class="line">Added [/root/TestUDF.jar] to class path</div><div class="line">Added resources: [/root/TestUDF.jar]</div><div class="line">4.	hive&gt; CREATE TEMPORARY FUNCTION display AS &apos;com.sxt.hive.udf.TestUDF&apos;;</div><div class="line">hive&gt; select id,name,display(name) from person0;</div><div class="line">OK</div><div class="line">1	Jed	Jed***</div><div class="line">2	Tom	Tom***</div><div class="line">3	Cat	Cat***</div><div class="line">5.	销毁临时函数</div><div class="line">hive&gt; DROP TEMPORARY FUNCTION display;</div></pre></td></tr></table></figure>
<h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><h4 id="基站掉话率"><a href="#基站掉话率" class="headerlink" title="基站掉话率"></a>基站掉话率</h4><p>给定50M数据，部分数据如下：<br><img src="/media/15048834912908.jpg" alt=""><br>字段说明：<br>record_time：通话时间<br>imei：基站编号<br>cell：手机编号<br>drop_num：掉话的秒数<br>duration：通话持续总秒数<br>要求：<br>找出掉线率最高的前10基站<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">hive&gt;create table cell_monitor(</div><div class="line">record_time string,</div><div class="line">imei string,</div><div class="line">cell string,</div><div class="line">ph_num int,</div><div class="line">call_num int,</div><div class="line">drop_num int,</div><div class="line">duration int,</div><div class="line">drop_rate double,</div><div class="line">net_type string,</div><div class="line">erl string</div><div class="line">)</div><div class="line">ROW FORMAT DELIMITED FIELDS TERMINATED BY ','</div><div class="line">STORED AS TEXTFILE;</div><div class="line"></div><div class="line">hive&gt;load data local inpath "/root/hivecase1_data" into table cell_monitor;</div><div class="line"></div><div class="line">hive&gt;select * from cell_monitor limit 5;</div><div class="line">2011-07-13 00:00:00+08	356966	29448-37062	0	0	0	0	0.0	G	0</div><div class="line">2011-07-13 00:00:00+08	352024	29448-51331	0	0	0	0	0.0	G	0</div><div class="line">2011-07-13 00:00:00+08	353736	29448-51331	0	0	0	0	0.0	G	0</div><div class="line">2011-07-13 00:00:00+08	353736	29448-51333	0	0	0	0	0.0	G	0</div><div class="line">2011-07-13 00:00:00+08	351545	29448-51333	0	0	0	0	0.0	G	0</div><div class="line"></div><div class="line">建结果表</div><div class="line">hive&gt;create table cell_result(</div><div class="line">imei string,</div><div class="line">total_call_num int,</div><div class="line">total_drop_num int,</div><div class="line">d_rate double</div><div class="line">) </div><div class="line">ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'</div><div class="line">STORED AS TEXTFILE;</div><div class="line"></div><div class="line">hive&gt;from cell_monitor cm </div><div class="line">insert overwrite table cell_result  </div><div class="line">select cm.imei ,sum(cm.drop_num),sum(cm.duration),sum(cm.drop_num)/sum(cm.duration) d_rate </div><div class="line">group by cm.imei </div><div class="line">sort by d_rate desc;</div><div class="line"></div><div class="line">hive&gt;select * from cell_result limit 10;</div><div class="line">639876	1	734	    0.0013623978201634877</div><div class="line">356436	1	1028	9.727626459143969E-4</div><div class="line">351760	1	1232	8.116883116883117E-4</div><div class="line">368883	1	1448	6.906077348066298E-4</div><div class="line">358849	1	1469	6.807351940095302E-4</div><div class="line">358231	1	1613	6.199628022318661E-4</div><div class="line">863738	2	3343	5.982650314089142E-4</div><div class="line">865011	1	1864	5.36480686695279E-4</div><div class="line">862242	1	1913	5.227391531625719E-4</div><div class="line">350301	2	3998	5.002501250625312E-4</div></pre></td></tr></table></figure></p>
<h4 id="WordCount"><a href="#WordCount" class="headerlink" title="WordCount"></a>WordCount</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">hive&gt;create table wordcount (line string);</div><div class="line"></div><div class="line">hive&gt;load data local inpath "/root/wordcount_data" into table wordcount;</div><div class="line"></div><div class="line">hive&gt;select * from wordcount;</div><div class="line">C C++ Java MySQL Oracle</div><div class="line">Spring SpringMVC Hibernate </div><div class="line">Struts2 SpringMVC Hibernate</div><div class="line">Hadoop Hive MapReduce Spring SpringMVC</div><div class="line">Java MySQL Oracle C C++ Java MySQL Oracle</div><div class="line">Struts2 SpringMVC Hibernate</div><div class="line">Hadoop Hive MapReduce</div><div class="line"></div><div class="line">hive&gt; select split(line,' ') from wordcount;</div><div class="line">["C","C++","Java","MySQL","Oracle"]</div><div class="line">["Spring","SpringMVC","Hibernate",""]</div><div class="line">["Struts2","SpringMVC","Hibernate"]</div><div class="line">["Hadoop","Hive","MapReduce","Spring","SpringMVC"]</div><div class="line">["Java","MySQL","Oracle","C","C++","Java","MySQL","Oracle"]</div><div class="line">["Struts2","SpringMVC","Hibernate"]</div><div class="line">["Hadoop","Hive","MapReduce"]</div><div class="line"></div><div class="line">hive&gt; select explode(split(line,' ')) from wordcount;</div><div class="line">OK</div><div class="line">C</div><div class="line">C++</div><div class="line">Java</div><div class="line">MySQL</div><div class="line">Oracle</div><div class="line">Spring</div><div class="line">SpringMVC</div><div class="line">Hibernate</div><div class="line">Struts2</div><div class="line">SpringMVC</div><div class="line">Hibernate</div><div class="line">Hadoop</div><div class="line">Hive</div><div class="line">MapReduce</div><div class="line">Spring</div><div class="line">SpringMVC</div><div class="line">Java</div><div class="line">MySQL</div><div class="line">Oracle</div><div class="line">C</div><div class="line">C++</div><div class="line">Java</div><div class="line">MySQL</div><div class="line">Oracle</div><div class="line">Struts2</div><div class="line">SpringMVC</div><div class="line">Hibernate</div><div class="line">Hadoop</div><div class="line">Hive</div><div class="line">MapReduce</div><div class="line"></div><div class="line">hive&gt; create table count_result(word string,num int);</div><div class="line"></div><div class="line">hive&gt; from (select explode(split(line,' ')) as word from wordcount) w</div><div class="line">insert into table count_result</div><div class="line">select w.word,count(*) as num</div><div class="line">group by w.word;</div><div class="line"></div><div class="line">hive&gt; select * from count_result;</div><div class="line">OK</div><div class="line">C	2</div><div class="line">C++	2</div><div class="line">Hadoop	2</div><div class="line">Hibernate	3</div><div class="line">Hive	2</div><div class="line">Java	3</div><div class="line">MapReduce	2</div><div class="line">MySQL	3</div><div class="line">Oracle	3</div><div class="line">Spring	2</div><div class="line">SpringMVC	4</div><div class="line">Struts2	2</div></pre></td></tr></table></figure>
<h3 id="Hive参数和变量"><a href="#Hive参数和变量" class="headerlink" title="Hive参数和变量"></a>Hive参数和变量</h3><p><img src="/media/15048836221579.jpg" alt=""><br>通过${}方式进行引用，其中system、env下的变量必须以前缀开头</p>
<h4 id="hive-参数设置方式"><a href="#hive-参数设置方式" class="headerlink" title="hive 参数设置方式"></a>hive 参数设置方式</h4><p>1.修改配置文件 ${HIVE_HOME}/conf/hive-site.xml<br>2.启动hive cli时，通过–hiveconf key=value的方式进行设置（临时生效）<br>例：hive –hiveconf hive.cli.print.header=true</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">显示表头</div><div class="line">[root@node03 ~]# hive --hiveconf hive.cli.print.header=true</div><div class="line">hive&gt; select * from count_result limit 2;</div><div class="line">count_result.word	count_result.num</div><div class="line">C	2</div><div class="line">C++	2</div><div class="line"></div><div class="line">临时生效</div><div class="line">[root@node03 ~]# hive -d val=test;</div><div class="line">hive&gt; create table $&#123;val&#125; (id int,name string);</div><div class="line">hive&gt; show tables;</div><div class="line">test</div></pre></td></tr></table></figure>
<p>3.进入cli之后，通过使用set命令设置（临时生效）<br>hive set命令<br>在hive CLI控制台可以通过set对hive中的参数进行查询、设置。<br>set设置：<br>set hive.cli.print.header=true;<br>set查看某个配置的值：<br>set hive.cli.print.header<br>set查看全部配置项：<br>    set<br>hive参数初始化配置文件：<br>当前用户家目录下的.hiverc文件，如:   ~/.hiverc，如果没有，可直接创建该文件，将需要设置的参数写到该文件中，hive启动运行时，会加载改文件中的配置。<br>hive历史操作命令集：<br>~/.hivehistory<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">hive&gt; set hive.cli.print.header=true;</div><div class="line">hive&gt; select * from count_result limit 3;</div><div class="line">count_result.word	count_result.num</div><div class="line">C	2</div><div class="line">C++	2</div><div class="line"></div><div class="line">hive&gt; set hive.cli.print.header;</div><div class="line">hive.cli.print.header=true</div><div class="line"></div><div class="line">永久生效</div><div class="line">[root@node03 ~]# vi .hiverc</div><div class="line">set hive.cli.print.header = true;</div><div class="line"></div><div class="line">[root@node03 ~]# tail -5 .hivehistory </div><div class="line">select * from cell_result;</div><div class="line">select * from cell_result limit 2;</div><div class="line">select * from count_result limit 2;</div><div class="line">quit;</div></pre></td></tr></table></figure></p>
<h3 id="Hive动态分区"><a href="#Hive动态分区" class="headerlink" title="Hive动态分区"></a>Hive动态分区</h3><p>建表时指出分区字段，但不给值，导入数据时hive根据分区字段的值自动创建分区。<br>开启动态分区需要修改一些配置：<br>是否开启动态分区，默认：false<br>set hive.exec.dynamic.partition=true;<br>动态分区模式，默认：strict：严格模式，至少有一个分区列是静态分区<br>set hive.exec.dynamic.partition.mode=nostrict;<br>相关参数：<br>每一个执行mr节点上，允许创建的动态分区的最大数量(100)<br>set hive.exec.max.dynamic.partitions.pernode;<br>所有执行mr节点上，允许创建的所有动态分区的最大数量(1000)<br>set hive.exec.max.dynamic.partitions;<br>所有的mr job允许创建的文件的最大数量(100000)<br>set hive.exec.max.created.files;</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">hive&gt; set hive.exec.dynamic.partition=true;</div><div class="line">hive&gt; set hive.exec.dynamic.partition.mode=nostrict;</div><div class="line">hive&gt; create table part0 (</div><div class="line">id int,</div><div class="line">name string</div><div class="line">)</div><div class="line">PARTITIONED BY (sex string)</div><div class="line">ROW FORMAT DELIMITED </div><div class="line">FIELDS TERMINATED BY ',';</div><div class="line"></div><div class="line">hive&gt; desc part0;</div><div class="line">col_name	data_type	comment</div><div class="line">id                  	int                 	                    </div><div class="line">name               string              	                    </div><div class="line">sex                 	string              	                     	 </div><div class="line"># Partition Information	 	 </div><div class="line"># col_name            	data_type           	comment              	 </div><div class="line">sex                 	string  </div><div class="line"></div><div class="line">导入两个分区的数据</div><div class="line">hive&gt; load data local inpath '/root/part0_data' into table part0 PARTITION (sex='1'); </div><div class="line">hive&gt; load data local inpath '/root/part0_data' into table part0 PARTITION (sex='2');          </div><div class="line"></div><div class="line">hive&gt; select * from part0;</div><div class="line">part0.id	part0.name	part0.sex</div><div class="line">1	Jed	1</div><div class="line">2	Tom	1</div><div class="line">3	Cat	1</div><div class="line">1	Jed	2</div><div class="line">2	Tom	2</div><div class="line">3	Cat	2</div><div class="line"></div><div class="line">创建一个和part0表机构完全相同的表part1</div><div class="line">hive&gt; create table part1 like part0;  </div><div class="line"></div><div class="line">给part1导入数据，使用动态分区</div><div class="line">hive&gt; from part0</div><div class="line">insert into table part1 partition (sex) </div><div class="line">select *;</div><div class="line"></div><div class="line">hive&gt; select * from part1;</div><div class="line">part1.id	part1.name	part1.sex</div><div class="line">1	Jed	1</div><div class="line">2	Tom	1</div><div class="line">3	Cat	1</div><div class="line">1	Jed	2</div><div class="line">2	Tom	2</div><div class="line">3	Cat	2</div></pre></td></tr></table></figure>
<p>使用动态分区导入数据时，不使用load，因为load必须指定分区的值，应该使用from+select方式。</p>
<h3 id="Hive分桶"><a href="#Hive分桶" class="headerlink" title="Hive分桶"></a>Hive分桶</h3><p>分桶表是对列值取哈希值的方式，将不同数据放到不同文件中存储。对于hive中每一个表、分区都可以进一步进行分桶。由列的哈希值除以桶的个数来决定每条数据划分在哪个桶中。比分区更加细粒度。<br>适用场景：数据抽样（ sampling ）、map-join<br>开启分桶支持：<br>set hive.enforce.bucketing=true;<br>默认：false。设置为true之后，mr运行时会根据bucket的个数自动分配reduce task个数。（用户也可以通过mapred.reduce.tasks自己设置reduce任务个数，但分桶时不推荐使用）注意：一次作业产生的桶（文件数量）和reduce task个数一致。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">hive&gt; set hive.enforce.bucketing=true;</div><div class="line"></div><div class="line">创建分桶表</div><div class="line">hive&gt; CREATE TABLE bucket(id int, name string, age int)</div><div class="line">CLUSTERED BY (age) INTO 4 BUCKETS </div><div class="line">ROW FORMAT DELIMITED FIELDS TERMINATED BY ',';</div><div class="line"></div><div class="line">查看表结构（比desc table;更详细）</div><div class="line">hive&gt; desc formatted bucket;</div><div class="line"></div><div class="line">hive&gt; from bucket_test</div><div class="line">insert into table bucket</div><div class="line">select *;</div><div class="line"></div><div class="line">hive&gt; select * from bucket;</div><div class="line">bucket.id	bucket.name	bucket.age</div><div class="line">1	Tom	11</div><div class="line">2	Cat	22</div><div class="line">3	Dog	33</div><div class="line">4	Tony	44</div><div class="line">5	Bob	55</div><div class="line">6	Hive	66</div><div class="line">7	Hadoop	77</div><div class="line">8	Java	88</div></pre></td></tr></table></figure></p>
<p><img src="/media/15048838369515.jpg" alt=""><br>注意：使用load加载数据不会出现分桶的效果<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">[root@node03 ~]# hdfs dfs -cat /user/hive/warehouse/bucket/000000_0</div><div class="line">8,Java,88</div><div class="line">4,Tony,44</div><div class="line">[root@node03 ~]# hdfs dfs -cat /user/hive/warehouse/bucket/000001_0</div><div class="line">7,Hadoop,77</div><div class="line">3,Dog,33</div><div class="line"></div><div class="line">抽样查询</div><div class="line">TABLESAMPLE语法：TABLESAMPLE (BUCKET x OUT OF y [ON colname])</div><div class="line">x：表示从哪个bucket开始抽取数据</div><div class="line">y：必须为该表总bucket数的倍数或因子</div><div class="line">共抽取(bucketNum/y)个桶的数据，抽取第x，和第(y+x)个桶中的数据</div><div class="line">例如：</div><div class="line">TABLESAMPLE(BUCKET 2 OUT OF 16) 桶总数为32</div><div class="line">共抽取2(32/16)个桶的数据，抽取第2(x)，和第18(y+32/16)个桶中的数据</div><div class="line">TABLESAMPLE(BUCKET 3 OUT OF 256) 桶总数为32</div><div class="line">共抽取0.125(32/256)个桶的数据，抽取第3(x)个桶的1/8数据</div><div class="line"></div><div class="line">hive&gt; select id, name, age </div><div class="line">from bucket </div><div class="line">tablesample(bucket 2 out of 4 on age);#取第二个桶</div><div class="line">id	name	age</div><div class="line">7	Hadoop	77</div><div class="line">3	Dog	33</div><div class="line"></div><div class="line">bk_users分桶结构:clustered by(uid) into 4 buckets</div><div class="line">#从bk_users分桶表抽出一桶数据：</div><div class="line">x=2,y=4</div><div class="line">select * from bk_users TABLESAMPLE(BUCKET 2 OUT OF 4);</div><div class="line">#从bk_users分桶表抽出二桶数据：</div><div class="line">x=2,y=2</div><div class="line">select * from bk_users TABLESAMPLE(BUCKET 2 OUT OF 2);</div><div class="line">#从bk_users分桶表抽出四桶数据：</div><div class="line">x=1,y=1</div><div class="line">select * from bk_users TABLESAMPLE(BUCKET 1 OUT OF 1);</div><div class="line">#从bk_users分桶表抽出半桶数据：</div><div class="line">x=1,y=8</div><div class="line">select * from bk_users TABLESAMPLE(BUCKET 1 OUT OF 8);</div><div class="line"></div><div class="line">=================抽样查询======================</div><div class="line">#随机从某表中取5条数据：</div><div class="line">select * from u_users order by rand() limit 5;</div><div class="line">#从Hive-0.8开始可以使用块抽样，语法为：</div><div class="line">#数据块取样 (TABLESAMPLE (n PERCENT))抽取表大小的n%</div><div class="line">select * from u_users TABLESAMPLE (10 PERCENT);</div><div class="line"></div><div class="line">#指定数据大小取样(TABLESAMPLE (nM)) M为MB单位</div><div class="line">select * from u_users TABLESAMPLE (10M);</div><div class="line">#指定抽取条数(TABLESAMPLE (n ROWS))</div><div class="line">select * from u_users TABLESAMPLE (5 ROWS);</div></pre></td></tr></table></figure></p>
<h3 id="Hive-Lateral-View"><a href="#Hive-Lateral-View" class="headerlink" title="Hive Lateral View"></a>Hive Lateral View</h3><p>Lateral View用于和UDTF函数（explode、split）结合来使用。首先通过UDTF函数拆分成多行，再将多行结果组合成一个支持别名的虚拟表。主要解决在select使用UDDTF做查询过程中，查询只能包含单个UDTF，不能包含其他字段、以及多个UDTF的问题。<br>语法：<br>LATERAL VIEW udtf(expression) tableAlias AS columnAlias (‘,’ columnAlias)<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">hive&gt; select * from person0;</div><div class="line">person0.id	person0.name	person0.hobbies	person0.address</div><div class="line">1	Jed	["book","lol"]	&#123;"beijing":"chaoyang"&#125;</div><div class="line">2	Tom	["book","lol","sports"]	&#123;"beijing":"chaoyang","shanghai":"pudong"&#125;</div><div class="line">3	Cat	["book","lol","sports","music"]	&#123;"beijing":"chaoyang","shanghai":"pudong","shanxi":"taiyuan"&#125;</div><div class="line"></div><div class="line">hive&gt; select explode(hobbies) from person0;</div><div class="line">col</div><div class="line">book</div><div class="line">lol</div><div class="line">book</div><div class="line">lol</div><div class="line">sports</div><div class="line">book</div><div class="line">lol</div><div class="line">sports</div><div class="line">music</div><div class="line"></div><div class="line">hive&gt; select explode(address) from person0;</div><div class="line">key	value</div><div class="line">beijing	chaoyang</div><div class="line">beijing	chaoyang</div><div class="line">shanghai	pudong</div><div class="line">beijing	chaoyang</div><div class="line">shanghai	pudong</div><div class="line">shanxi	taiyuan</div><div class="line"></div><div class="line">explode只能支持查询一个字段</div><div class="line">hive&gt; select explode(address),id from person0;</div><div class="line">FAILED: SemanticException 1:24 Only a single expression in the SELECT clause is supported with UDTF's. Error encountered near token 'i</div><div class="line">d'hive&gt; select explode(address),explode(hobbies) from person0;</div><div class="line">FAILED: SemanticException 1:24 Only a single expression in the SELECT clause is supported with UDTF's. Error encountered near token 'h</div><div class="line">obbies'</div><div class="line"></div><div class="line">例子：统计表中有多少种hobby和city</div><div class="line">hive&gt; select count(distinct(myCol1)) , count(distinct(myCol2)) from person0 </div><div class="line">LATERAL VIEW explode(hobbies) myTable1 AS myCol1 </div><div class="line">LATERAL VIEW explode(address) myTable2 AS myCol2, myCol3; </div><div class="line">_c0	_c1</div><div class="line">4	3</div></pre></td></tr></table></figure></p>
<h3 id="Hive-View视图"><a href="#Hive-View视图" class="headerlink" title="Hive View视图"></a>Hive View视图</h3><p>和关系型数据库中的普通视图一样，hive也支持视图<br>特点：<br>不支持物化视图、只能查询，不能做加载数据操作；<br>视图的创建，只是保存一份元数据，查询视图时才执行对应的子查询；<br>view定义中若包含了ORDER BY/LIMIT语句，当查询视图时也进行ORDER BY/LIMIT语句操作，view当中定义的优先级更高，view支持迭代视图。</p>
<p>View语法：<br>创建视图<br>CREATE VIEW [IF NOT EXISTS] [db_name.]view_name<br>  [(column_name [COMMENT column_comment], …) ]<br>  [COMMENT view_comment]<br>  [TBLPROPERTIES (property_name = property_value, …)]<br>  AS SELECT … ;</p>
<p>查询视图<br>select colums from view;</p>
<p>删除视图<br>DROP VIEW [IF EXISTS] [db_name.]view_name;</p>
<h3 id="Hive索引"><a href="#Hive索引" class="headerlink" title="Hive索引"></a>Hive索引</h3><p>目的：优化查询以及检索性能</p>
<p>创建索引：<br>create index t1_index on table person0(name)<br>as ‘org.apache.hadoop.hive.ql.index.compact.CompactIndexHandler’<br>with deferred rebuild in table t1_index_table;<br>as：指定索引器；<br>in table：指定索引表，若不指定默认生成在default_person0_t1<em>index</em>表中</p>
<p>create index t1_index on table person0(name)<br>as ‘org.apache.hadoop.hive.ql.index.compact.CompactIndexHandler’ with deferred rebuild;</p>
<p>查询索引<br>show index on person0;</p>
<p>重建索引（建立索引之后必须重建索引才能生效）<br>ALTER INDEX t1_index ON person0 REBUILD;</p>
<p>删除索引<br>DROP INDEX IF EXISTS t1_index ON person0;<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Hive&gt; create index t1_index on table person0(name) </div><div class="line">as 'org.apache.hadoop.hive.ql.index.compact.CompactIndexHandler' </div><div class="line">with deferred rebuild in table t1_index_table;</div><div class="line"></div><div class="line">hive&gt; show tables;</div><div class="line">person0</div><div class="line">t1_index_table</div><div class="line"></div><div class="line">hive&gt; show index on person0;</div><div class="line">t1_index    person0      name     t1_index_table   compact    </div><div class="line"></div><div class="line">hive&gt; ALTER INDEX t1_index ON person0 REBUILD; </div><div class="line">hive&gt; select * from t1_index_table;</div><div class="line">Cat	hdfs://mycluster/user/hive/warehouse/person0/person0_data	[87]</div><div class="line">Jed	hdfs://mycluster/user/hive/warehouse/person0/person0_data	[0]</div><div class="line">Tom	hdfs://mycluster/user/hive/warehouse/person0/person0_data	[32]</div></pre></td></tr></table></figure></p>
<h3 id="Hive运行方式"><a href="#Hive运行方式" class="headerlink" title="Hive运行方式"></a>Hive运行方式</h3><p>命令行方式cli：控制台模式<br>    metastore hive<br>    hiveserver2 beeline<br>脚本运行方式（实际生产环境中用最多）<br>JDBC方式：hiveserver2<br>web GUI接口（hwi、hue等）</p>
<h4 id="命令行模式"><a href="#命令行模式" class="headerlink" title="命令行模式"></a>命令行模式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">与HDFS交互（比在Linux中快，因为已经获得连接）</div><div class="line">hive&gt; dfs -ls /;</div><div class="line">Found 3 items</div><div class="line">drwxr-xr-x   - root supergroup          0 2017-07-11 19:58 /psn6</div><div class="line">drwxr-xr-x   - root supergroup          0 2017-07-11 15:31 /tmp</div><div class="line">drwxr-xr-x   - root supergroup          0 2017-07-11 17:22 /user</div><div class="line"></div><div class="line">与Linux交互（Linux命令以!开头）</div><div class="line">hive&gt; ! pwd;</div><div class="line">/root</div></pre></td></tr></table></figure>
<h4 id="脚本方式运行"><a href="#脚本方式运行" class="headerlink" title="脚本方式运行"></a>脚本方式运行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">查询</div><div class="line">[root@node03 ~]# hive -e &quot;select * from wordcount limit 3&quot;;</div><div class="line">17/07/12 17:35:43 WARN conf.HiveConf: HiveConf of name hive.metastore.local does not exist</div><div class="line">Logging initialized using configuration in jar:file:/opt/sxt/apache-hive-1.2.1-bin/lib/hive-common-1.2.1.jar!/hive-log4j.properties</div><div class="line">OK</div><div class="line">C C++ Java MySQL Oracle</div><div class="line">Spring SpringMVC Hibernate </div><div class="line">Struts2 SpringMVC Hibernate</div><div class="line">Time taken: 1.831 seconds, Fetched: 3 row(s)</div><div class="line"></div><div class="line">静默执行，只返回结果，不返回其他信息</div><div class="line">[root@node03 ~]# hive -S -e &quot;select * from wordcount limit 3&quot;;</div><div class="line">17/07/12 17:39:18 WARN conf.HiveConf: HiveConf of name hive.metastore.local does not exist</div><div class="line">C C++ Java MySQL Oracle</div><div class="line">Spring SpringMVC Hibernate </div><div class="line">Struts2 SpringMVC Hibernate</div><div class="line"></div><div class="line">查询结果保存到文件中</div><div class="line">[root@node03 ~]# hive -e &quot;select * from wordcount limit 1&quot; &gt; result;</div><div class="line">[root@node03 ~]# vi result</div><div class="line">C C++ Java MySQL Oracle</div><div class="line"></div><div class="line">执行指定文件中的sql语句（有几条执行几条，顺序执行）</div><div class="line">[root@node03 ~]# vi sql</div><div class="line">select * from wordcount limit 1;</div><div class="line">[root@node03 ~]# hive -f sql</div><div class="line">C C++ Java MySQL Oracle</div><div class="line"></div><div class="line">执行指定文件中的sql语句，执行完后进入hive客户端</div><div class="line">[root@node03 ~]# hive -i sql</div><div class="line">hive&gt;</div><div class="line"></div><div class="line">在hive客户端中执行Linux中的文件</div><div class="line">hive&gt; source /root/sql;</div><div class="line">C C++ Java MySQL Oracle</div></pre></td></tr></table></figure>
<h4 id="Web-GUI接口-hwi"><a href="#Web-GUI接口-hwi" class="headerlink" title="Web GUI接口-hwi"></a>Web GUI接口-hwi</h4><p>####搭建步骤</p>
<h5 id="1-把apache-hive-src-hwi-web-下的所有文件打成war包"><a href="#1-把apache-hive-src-hwi-web-下的所有文件打成war包" class="headerlink" title="1.把apache-hive-*-src/hwi/web/下的所有文件打成war包"></a>1.把apache-hive-*-src/hwi/web/下的所有文件打成war包</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Microsoft Windows [版本 10.0.14393]</div><div class="line">(c) 2016 Microsoft Corporation。保留所有权利。</div><div class="line"></div><div class="line">C:\Users\Jed&gt;e:</div><div class="line">E:\&gt;cd E:\package\hive-1.2.1-src\apache-hive-1.2.1-src\hwi\web</div><div class="line">E:\package\hive-1.2.1-src\apache-hive-1.2.1-src\hwi\web&gt;jar -cvf hive-hwi.war *</div></pre></td></tr></table></figure>
<p>war包在压缩的当前目录生成</p>
<h5 id="2-把war包上传到-HIVE-HOME-lib-下（服务端）"><a href="#2-把war包上传到-HIVE-HOME-lib-下（服务端）" class="headerlink" title="2.把war包上传到$HIVE_HOME/lib/下（服务端）"></a>2.把war包上传到$HIVE_HOME/lib/下（服务端）</h5><h5 id="3-把JAVA-HOME-lib-下的tool-jar拷贝到-HIVE-HOME-lib-下"><a href="#3-把JAVA-HOME-lib-下的tool-jar拷贝到-HIVE-HOME-lib-下" class="headerlink" title="3.把JAVA_HOME/lib/下的tool.jar拷贝到$HIVE_HOME/lib/下"></a>3.把JAVA_HOME/lib/下的tool.jar拷贝到$HIVE_HOME/lib/下</h5><p><code>[root@node04 ~]# cp /usr/java/jdk1.7.0_67/lib/tools.jar /opt/sxt/apache-hive-1.2.1-bin/lib/</code></p>
<h5 id="4-修改hive-site-xml，添加如下配置"><a href="#4-修改hive-site-xml，添加如下配置" class="headerlink" title="4.修改hive-site.xml，添加如下配置"></a>4.修改hive-site.xml，添加如下配置</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.hwi.listen.host<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>0.0.0.0<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.hwi.listen.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>9999<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.hwi.war.file<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>lib/hive-hwi.war<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure>
<h5 id="5-启动hwi服务"><a href="#5-启动hwi服务" class="headerlink" title="5.启动hwi服务"></a>5.启动hwi服务</h5><p>[root@node04 conf]# hive –service hwi</p>
<h5 id="6-访问浏览器"><a href="#6-访问浏览器" class="headerlink" title="6.访问浏览器"></a>6.访问浏览器</h5><p><img src="/media/15048845300757.jpg" alt=""><br><img src="/media/15048845407082.jpg" alt=""><br>创建查询：<br><img src="/media/15048845611075.jpg" alt=""></p>
<p>结果：<br><img src="/media/15048845745231.jpg" alt=""><br><img src="/media/15048845860141.jpg" alt=""></p>
<h3 id="Hive优化"><a href="#Hive优化" class="headerlink" title="Hive优化"></a>Hive优化</h3><p>hive核心思想：把Hive SQL 当做Mapreduce程序去优化。以下SQL不会转为Mapreduce来执行：<br>select仅查询本表字段；<br>where仅对本表字段做条件过滤。</p>
<p>explain命令可以显示执行计划：EXPLAIN [EXTENDED] query; EXTENDED可以看到更详细的信息。<br><img src="/media/15048846302709.jpg" alt=""></p>
<h4 id="本地模式提高执行效率"><a href="#本地模式提高执行效率" class="headerlink" title="本地模式提高执行效率"></a>本地模式提高执行效率</h4><p>本地模式：<br>mapreduce任务运行在一台节点上，该节点把需要的资源从其他机器copy过来<br>集群模式：<br>mapreduce任务在hadoop集群中执行<br>开启本地模式：<br>set hive.exec.mode.local.auto=true;<br>注意：<br>hive.exec.mode.local.auto.inputbytes.max默认值为128M，表示加载文件的最大值，若大于该配置仍会以集群方式来运行<br>    查询的数据在数据量不大的表中，这种情况使用本地模式，数据量大时使用集群模式</p>
<h4 id="并行计算"><a href="#并行计算" class="headerlink" title="并行计算"></a>并行计算</h4><p>hive执行sql默认是顺序执行，如下sql如果使用并行计算会大大提高效率，但是集群压力也增大：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span>  wc.col1,bk.col2 <span class="keyword">from</span></div><div class="line">(<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> col1 <span class="keyword">from</span> wordcount) wc,</div><div class="line">(<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">as</span> col2 <span class="keyword">from</span> bucket) bk;</div></pre></td></tr></table></figure></p>
<p>两条子查询可以使用并行计算</p>
<p>通过设置以下参数开启并行模式：<br>set hive.exec.parallel=true;<br>注意：<br>hive.exec.parallel.thread.number<br>代表一次SQL计算中允许并行执行的job个数的最大值</p>
<h4 id="严格模式"><a href="#严格模式" class="headerlink" title="严格模式"></a>严格模式</h4><p>查询限制：<br>1)    对于分区表，必须添加where对于分区字段的条件过滤；<br>2)    order by语句必须包含limit输出限制；<br>3)    限制执行笛卡尔积的查询。</p>
<h5 id="严格模式详解"><a href="#严格模式详解" class="headerlink" title="严格模式详解"></a>严格模式详解</h5><p>hive提供了一个严格模式，可以防止用户执行那些可能产生意想不到的不好的效果的查询。即某些查询在严格模式下无法执行。通过设置hive.mapred.mode的值为strict，可以禁止3中类型的查询。</p>
<h6 id="1）带有分区的表的查询"><a href="#1）带有分区的表的查询" class="headerlink" title="1）带有分区的表的查询"></a>1）带有分区的表的查询</h6><p>如果在一个分区表执行hive，除非where语句中包含分区字段过滤条件来显示数据范围，否则不允许执行。换句话说，<br>就是用户不允许扫描所有的分区。进行这个限制的原因是，通常分区表都拥有非常大的数据集，而且数据增加迅速。<br>如果没有进行分区限制的查询可能会消耗令人不可接受的巨大资源来处理这个表：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">hive&gt; SELECT DISTINCT(planner_id) FROM fracture_ins WHERE planner_id=5;</div><div class="line">FAILED: Error in semantic analysis: No Partition Predicate Found for Alias "fracture_ins" Table "fracture_ins</div><div class="line"></div><div class="line"></div><div class="line">如下这个语句在where语句中增加了一个分区过滤条件（也就是限制了表分区）：</div><div class="line">hive&gt; SELECT DISTINCT(planner_id) FROM fracture_ins</div><div class="line">&gt; WHERE planner_id=5 AND hit_date=20120101;</div><div class="line">       ... normal results ...</div></pre></td></tr></table></figure></p>
<h6 id="2）带有orderby的查询"><a href="#2）带有orderby的查询" class="headerlink" title="2）带有orderby的查询"></a>2）带有orderby的查询</h6><p>对于使用了orderby的查询，要求必须有limit语句。因为orderby为了执行排序过程会讲所有的结果分发到同一个reducer中进行处理，强烈要求用户增加这个limit语句可以防止reducer额外执行很长一段时间：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">hive&gt; SELECT * FROM fracture_ins WHERE hit_date&gt;2012 ORDER BY planner_id;</div><div class="line">FAILED: Error in semantic analysis: line 1:56 In strict mode,</div><div class="line">limit must be specified if ORDER BY is present planner_id</div><div class="line"></div><div class="line"></div><div class="line">        只需要增加limit语句就可以解决这个问题：</div><div class="line">hive&gt; SELECT * FROM fracture_ins WHERE hit_date&gt;2012 ORDER BY planner_id</div><div class="line">        &gt; LIMIT 100000;</div><div class="line">        ... normal results ...</div></pre></td></tr></table></figure></p>
<p><img src="/media/15048848890164.jpg" alt=""><br><img src="/media/15048849054786.jpg" alt=""></p>
<p>笛卡尔集中的记录不一定正确，为了避免笛卡尔集可以在WHERE中加入有效的连接条件，实际运行环境下应该避免使用笛卡尔全集。</p>
<h6 id="3）限制笛卡尔积的查询"><a href="#3）限制笛卡尔积的查询" class="headerlink" title="3）限制笛卡尔积的查询"></a>3）限制笛卡尔积的查询</h6><p>对关系型数据库非常了解的用户可能期望在执行join查询的时候不使用on语句而是使用where语句，这样关系数据库的执行优化器就可以高效的将where语句转换成那个on语句。不幸的是，hive不会执行这种优化，因此，如果表足够大，那么这个查询就会出现不可控的情况：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">hive&gt; SELECT * FROM fracture_act JOIN fracture_ads</div><div class="line">&gt; WHERE fracture_act.planner_id = fracture_ads.planner_id;</div><div class="line">FAILED: Error in semantic analysis: In strict mode, cartesian product</div><div class="line">is not allowed. If you really want to perform the operation,</div><div class="line">+set hive.mapred.mode=nonstrict+</div><div class="line"></div><div class="line"></div><div class="line">        下面这个才是正确的使用join和on语句的查询：</div><div class="line">hive&gt; SELECT * FROM fracture_act JOIN fracture_ads</div><div class="line">        &gt; ON (fracture_act.planner_id = fracture_ads.planner_id);</div><div class="line">        ... normal results ...</div></pre></td></tr></table></figure>
<p>通过设置以下参数开启严格模式：<br>set hive.mapred.mode=strict;（默认为：nonstrict非严格模式）</p>
<h4 id="Hive排序"><a href="#Hive排序" class="headerlink" title="Hive排序"></a>Hive排序</h4><p>Order By<br>对于查询结果做全排序，只允许有一个reduce处理。当数据量较大时，应慎用。严格模式下，必须结合limit来使用<br>Sort By<br>对于单个reduce的数据进行排序<br>Distribute By<br>分区排序，经常和Sort By结合使用<br>Cluster By<br>相当于 Sort By + Distribute By，Cluster By不能通过asc、desc的方式指定排序规则；<br>可通过 distribute by column sort by column asc|desc 的方式结合使用。</p>
<h4 id="Hive-join"><a href="#Hive-join" class="headerlink" title="Hive join"></a>Hive join</h4><h5 id="Join计算时，将小表（驱动表）放在join的左边"><a href="#Join计算时，将小表（驱动表）放在join的左边" class="headerlink" title="Join计算时，将小表（驱动表）放在join的左边"></a>Join计算时，将小表（驱动表）放在join的左边</h5><p>在编写带有 join 操作的代码语句时，应该将条目少的表/子查询放在 Join 操作符的左边。 因为在 Reduce 阶段，位于 Join 操作符左边的表的内容会被加载进内存，载入条目较少的表 可以有效减少 OOM（out of memory）即内存溢出。所以对于同一个 key 来说，对应的 value 值小的放前，大的放后，这便是“小表放前”原则。</p>
<h5 id="Map端完成Join（避免数据倾斜）"><a href="#Map端完成Join（避免数据倾斜）" class="headerlink" title="Map端完成Join（避免数据倾斜）"></a>Map端完成Join（避免数据倾斜）</h5><p>两种实现方式：<br>1)    SQL方式，在SQL语句中添加MapJoin标记（mapjoin hint）<br>Hive0.7之前，需要使用hint提示 /<em>+ mapjoin(table) </em>/才会执行MapJoin,否则执行Common Join（即reduce端join），但在0.7版本之后，默认自动会转换Map Join，由参数 hive.auto.convert.join来控制，默认为true.<br>语法：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span>  <span class="comment">/*+ MAPJOIN(smallTable) */</span>  smallTable.key,  bigTable.value </div><div class="line"><span class="keyword">FROM</span>  smallTable  <span class="keyword">JOIN</span>  bigTable  <span class="keyword">ON</span>  smallTable.key  =  bigTable.key;</div></pre></td></tr></table></figure></p>
<p>2)    开启自动的MapJoin<br>通过修改以下配置启用自动的mapjoin：<br>set hive.auto.convert.join = true;<br>该参数为true时，Hive自动对左边的表统计量，如果是小表就加入内存，即对小表使用Map join</p>
<p>相关配置参数：<br>hive.mapjoin.smalltable.filesize;  默认值是25M<br>大表小表判断的阈值，如果表的大小小于该值则会被加载到内存中运行<br>hive.ignore.mapjoin.hint；<br>默认值：true；是否忽略mapjoin hint 即mapjoin标记<br>hive.auto.convert.join.noconditionaltask;<br>默认值：true；将普通的join转化为普通的mapjoin时，是否将多个mapjoin转化为一个mapjoin<br>hive.auto.convert.join.noconditionaltask.size;<br>最多可以把几个mapjoin转化为一个mapjoin</p>
<h4 id="Map-Side聚合"><a href="#Map-Side聚合" class="headerlink" title="Map-Side聚合"></a>Map-Side聚合</h4><p>通过设置以下参数开启在Map端的聚合：<br>set hive.map.aggr=true;</p>
<p>相关配置参数：<br>hive.groupby.mapaggr.checkinterval：<br>map端group by执行聚合时处理的多少行数据（默认：100000）<br>hive.map.aggr.hash.min.reduction：<br>进行聚合的最小比例，预先对100000条数据做聚合，若聚合之后的数据量/100000的值大于该配置0.5，则不会聚合<br>hive.map.aggr.hash.percentmemory：<br>map端聚合使用的内存的最大值<br>hive.map.aggr.hash.force.flush.memory.threshold：<br>map端做聚合操作时hash表的最大可用内存，大于该值则会触发flush，溢写到磁盘<br>hive.groupby.skewindata<br>是否对GroupBy产生的数据倾斜做优化，默认为false<br>当选项设定为 true 是，生成的查询计划有两 个 MapReduce 任务。在第一个 MapReduce 中，map 的输出结果集合会随机分布到 reduce 中， 每个 reduce 做部分聚合操作，并输出结果。这样处理的结果是，相同的 Group By Key 有可 能分发到不同的 reduce 中，从而达到负载均衡的目的；第二个 MapReduce 任务再根据预处 理的数据结果按照 Group By Key 分布到 reduce 中（这个过程可以保证相同的 Group By Key 分布到同一个 reduce 中），最后完成最终的聚合操作</p>
<h4 id="无效ID在关联时的数据倾斜问题"><a href="#无效ID在关联时的数据倾斜问题" class="headerlink" title="无效ID在关联时的数据倾斜问题"></a>无效ID在关联时的数据倾斜问题</h4><p>问题：日志中常会出现信息丢失，比如每日约为 20 亿的全网日志，其中的 user_id 为主 键，在日志收集过程中会丢失，出现主键为 null 的情况，如果取其中的 user_id 和 bmw_users 关联，就会碰到数据倾斜的问题。原因是 Hive 中，主键为 null 值的项会被当做相同的 Key 而分配进同一个计算 Map。</p>
<p>自己动手写sql解决数据倾斜问题是个不错的选择。set hive.groupby.skewindata=true;这是通用的算法优化，但算法优化总是漠视业务，习惯性提供通用的解决方法。 Etl开发人员更了解业务，更了解数据，所以通过业务逻辑解决倾斜的方法往往更精确，更有效。</p>
<h5 id="解决方法-1：user-id-为空的不参与关联，子查询过滤-null"><a href="#解决方法-1：user-id-为空的不参与关联，子查询过滤-null" class="headerlink" title="解决方法 1：user_id 为空的不参与关联，子查询过滤 null"></a>解决方法 1：user_id 为空的不参与关联，子查询过滤 null</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">log</span> a </div><div class="line"><span class="keyword">JOIN</span> bmw_users b <span class="keyword">ON</span> a.user_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">AND</span> a.user_id=b.user_id </div><div class="line"><span class="keyword">UNION</span> All <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">log</span> a <span class="keyword">WHERE</span> a.user_id <span class="keyword">IS</span> <span class="literal">NULL</span></div></pre></td></tr></table></figure>
<h5 id="解决方法-2-如下所示：函数过滤-null"><a href="#解决方法-2-如下所示：函数过滤-null" class="headerlink" title="解决方法 2 如下所示：函数过滤 null"></a>解决方法 2 如下所示：函数过滤 null</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">log</span> a <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> </div><div class="line"><span class="keyword">JOIN</span> bmw_users b <span class="keyword">ON</span> </div><div class="line"><span class="keyword">CASE</span> <span class="keyword">WHEN</span> a.user_id <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">THEN</span> <span class="keyword">CONCAT</span>(‘dp_hive’,<span class="keyword">RAND</span>()) <span class="keyword">ELSE</span> a.user_id <span class="keyword">END</span> =b.user_id;</div></pre></td></tr></table></figure>
<p>　　调优结果：原先由于数据倾斜导致运行时长超过 1 小时，解决方法 1 运行每日平均时长 25 分钟，解决方法 2 运行的每日平均时长在 20 分钟左右。优化效果很明显。</p>
<p>　　我们在工作中总结出：解决方法2比解决方法1效果更好，不但IO少了，而且作业数也少了。解决方法1中log读取两次，job 数为2。解决方法2中 job 数是1。这个优化适合无效 id（比如-99、 ‘’，null 等）产生的倾斜问题。把空值的 key 变成一个字符串加上随机数，就能把倾斜的 数据分到不同的Reduce上，从而解决数据倾斜问题。因为空值不参与关联，即使分到不同 的 Reduce 上，也不会影响最终的结果。附上 Hadoop 通用关联的实现方法是：关联通过二次排序实现的，关联的列为 partion key，关联的列和表的 tag 组成排序的 group key，根据 pariton key分配Reduce。同一Reduce内根据group key排序。</p>
<h4 id="控制Hive中Map以及Reduce的数量"><a href="#控制Hive中Map以及Reduce的数量" class="headerlink" title="控制Hive中Map以及Reduce的数量"></a>控制Hive中Map以及Reduce的数量</h4><p>Map数量相关的参数：</p>
<p>mapred.max.split.size<br>一个split的最大值，即每个map处理文件的最大值<br>mapred.min.split.size.per.node<br>一个节点上split的最小值<br>mapred.min.split.size.per.rack<br>一个机架上split的最小值</p>
<p>Reduce数量相关的参数：</p>
<p>mapred.reduce.tasks<br>强制指定reduce任务的数量<br>hive.exec.reducers.bytes.per.reducer<br>每个reduce任务处理的数据量<br>hive.exec.reducers.max<br>每个任务最大的reduce数</p>
<h4 id="JVM重用"><a href="#JVM重用" class="headerlink" title="JVM重用"></a>JVM重用</h4><p>适用场景：<br>1)    小文件个数过多<br>2)    task个数过多<br>频繁的申请资源，释放资源降低了执行效率<br>通过set mapred.job.reuse.jvm.num.tasks=n; （n为task插槽个数）来设置，道理与“池”类似。<br>缺点：<br>设置开启之后，task插槽会一直占用资源，不论是否有task运行，直到所有的task即整个job全部执行完成时，才会释放所有的task插槽资源。<br>更多优化细节参考<a href="http://www.cnblogs.com/smartloli/p/4356660.html" target="_blank" rel="external">Hive性能优化</a></p>
<h3 id="Hive窗口函数分组取TopN"><a href="#Hive窗口函数分组取TopN" class="headerlink" title="Hive窗口函数分组取TopN"></a>Hive窗口函数分组取TopN</h3><p>Hive利用row_number实现<br>我们知道Hive允许执行HQL语句，虽说HQL和SQL有很多相同之处，但还是有许多差别之处，以ROW_NUMBER()为例：<br>在Hive低版本中，ROW_NUMBER（）在HIVE中是一个函数，必须带一个或者多个列参数，如ROW_NUMBER(col1, ….)，它的作用是按指定的列进行分组生成行序列，在ROW_NUMBER(a,b) 时，若两条记录的a，b列相同，则行序列+1，否则重新计数。而在高版本中就取消了这一限制，写法和现在的sql一致，同时，因为HIVE是基于MAPREADUCE的，必须保证ROW_NUMBER执行是在REDUCE中，并且ROW_NUMBER中使用的列中，列值相同的记录要再同一个reduce中，否则ROW_NUMBER的行为是无意义的。</p>
<p>将目标数据存入临时表中<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">drop</span> <span class="keyword">table</span> tmp_users_time;  </div><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> tmp_users_time   </div><div class="line"><span class="keyword">as</span>  </div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span>  </div><div class="line">(  </div><div class="line"><span class="keyword">select</span> u.*,row_numwer() <span class="keyword">over</span>(<span class="keyword">distribute</span> <span class="keyword">by</span> grade <span class="keyword">sort</span> <span class="keyword">by</span> score <span class="keyword">desc</span>) sn  </div><div class="line"><span class="keyword">from</span> <span class="keyword">users</span> u  </div><div class="line">)tu  </div><div class="line"><span class="keyword">where</span> tu.sn &gt; <span class="number">2</span>;</div></pre></td></tr></table></figure></p>
<p>或者将数据添加到记录时刻top的大表中，默认大表自动添加时间<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> users_time_top  </div><div class="line"><span class="keyword">select</span> tu.grade,tu.score  </div><div class="line"><span class="keyword">from</span>  </div><div class="line">(  </div><div class="line"><span class="keyword">select</span> u.*,row_number() <span class="keyword">over</span>(<span class="keyword">distribute</span> <span class="keyword">by</span> grade <span class="keyword">sort</span> <span class="keyword">by</span> score <span class="keyword">desc</span>) sn  </div><div class="line"><span class="keyword">from</span> <span class="keyword">users</span> u  </div><div class="line">)tu  </div><div class="line"><span class="keyword">where</span> tu.sn &gt; <span class="number">2</span>;</div></pre></td></tr></table></figure></p>
<p><a href="http://blog.csdn.net/u010670689/article/details/49337137" target="_blank" rel="external">练习</a><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">实例一:</div><div class="line">相当于按muid分组,然后同muid组内按muid,time排序</div><div class="line"><span class="keyword">select</span> channel,muid,<span class="keyword">time</span>, row_number() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> muid <span class="keyword">order</span> <span class="keyword">by</span> muid,<span class="keyword">time</span> <span class="keyword">desc</span> ) <span class="keyword">rank</span></div><div class="line"><span class="keyword">from</span> dc_dev.tmp_row_num</div><div class="line"><span class="keyword">group</span> <span class="keyword">by</span> channel,muid,<span class="keyword">time</span></div><div class="line"></div><div class="line">实例二:</div><div class="line">相当于按muid分组,然后同muid组内按<span class="keyword">time</span>排序</div><div class="line"><span class="keyword">select</span> channel,muid,<span class="keyword">time</span>, row_number() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> channel <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">time</span> <span class="keyword">desc</span> ) <span class="keyword">rank</span></div><div class="line"><span class="keyword">from</span> dc_dev.tmp_row_num</div><div class="line"><span class="keyword">group</span> <span class="keyword">by</span> channel,muid,<span class="keyword">time</span></div><div class="line"></div><div class="line">实例三:</div><div class="line">相当于按channel,muid分组,然后同channel,muid组内按<span class="keyword">time</span>排序</div><div class="line"><span class="keyword">select</span> channel,muid,<span class="keyword">time</span>, row_number() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> channel,muid <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">time</span> <span class="keyword">desc</span> ) <span class="keyword">rank</span></div><div class="line"><span class="keyword">from</span> dc_dev.tmp_row_num</div><div class="line"><span class="keyword">group</span> <span class="keyword">by</span> channel,muid,<span class="keyword">time</span></div></pre></td></tr></table></figure></p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol>
<li><a href="http://blog.csdn.net/wisgood/article/details/19852553" target="_blank" rel="external">Hive严格模式</a></li>
<li><a href="http://www.cnblogs.com/smartloli/p/4356660.html" target="_blank" rel="external">Hive性能优化</a></li>
<li><a href="http://blog.csdn.net/u010670689/article/details/49337137" target="_blank" rel="external">Hive组内排序及分组取topN</a></li>
<li><a href="http://blog.csdn.net/zeb_perfect/article/details/53336495" target="_blank" rel="external">分组Top N问题(三) - sql及Hive实现</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Hive/" rel="tag"># Hive</a>
          
            <a href="/tags/Hive原理及其搭建/" rel="tag"># Hive原理及其搭建</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/11/28/2017-09-09/" rel="next" title="HBase学习笔记">
                <i class="fa fa-chevron-left"></i> HBase学习笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/12/07/概率论/" rel="prev" title="概率论迷思">
                概率论迷思 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Chant" />
          <p class="site-author-name" itemprop="name">Chant</p>
           
              <p class="site-description motion-element" itemprop="description">Take things as they are with a cavalier attitude./用漫不经心的态度过随遇而安的生活</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Chant00" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/profile.php?id=100014951437344" target="_blank" title="Facebook">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                  Facebook
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/63254896/" target="_blank" title="豆瓣">
                  
                    <i class="fa fa-fw fa-book"></i>
                  
                  豆瓣
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              值得一看：
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://isujin.com/" title="素锦" target="_blank">素锦</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://zhibimo.com/explore/books" title="知笔墨" target="_blank">知笔墨</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.danielaandrade.com/" title="Daniela Andrade" target="_blank">Daniela Andrade</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive的产生"><span class="nav-number">1.</span> <span class="nav-text">Hive的产生</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive的架构"><span class="nav-number">2.</span> <span class="nav-text">Hive的架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive语法解析"><span class="nav-number">3.</span> <span class="nav-text">Hive语法解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive的三种模式"><span class="nav-number">4.</span> <span class="nav-text">Hive的三种模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#local模式"><span class="nav-number">4.1.</span> <span class="nav-text">local模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#单用户模式"><span class="nav-number">4.2.</span> <span class="nav-text">单用户模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多用户模式"><span class="nav-number">4.3.</span> <span class="nav-text">多用户模式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux下安装MySQL"><span class="nav-number">5.</span> <span class="nav-text">Linux下安装MySQL</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-yum安装mysql"><span class="nav-number">5.0.0.1.</span> <span class="nav-text">1.yum安装mysql</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-启动mysqld服务"><span class="nav-number">5.0.0.2.</span> <span class="nav-text">2.启动mysqld服务</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-修改mysql修改权限"><span class="nav-number">5.0.0.3.</span> <span class="nav-text">3.修改mysql修改权限</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-重新登录mysql"><span class="nav-number">5.0.0.4.</span> <span class="nav-text">4.重新登录mysql</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive安装"><span class="nav-number">6.</span> <span class="nav-text">Hive安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#本地模式（derby）"><span class="nav-number">6.1.</span> <span class="nav-text">本地模式（derby）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#单用户模式（mysql）"><span class="nav-number">6.2.</span> <span class="nav-text">单用户模式（mysql）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多用户模式-1"><span class="nav-number">6.3.</span> <span class="nav-text">多用户模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Remot一体"><span class="nav-number">6.3.1.</span> <span class="nav-text">Remot一体</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Remot分开"><span class="nav-number">6.3.2.</span> <span class="nav-text">Remot分开</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#服务端配置文件"><span class="nav-number">6.3.2.1.</span> <span class="nav-text">服务端配置文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#客户端配置文件"><span class="nav-number">6.3.2.2.</span> <span class="nav-text">客户端配置文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装单用户模式具体步骤"><span class="nav-number">6.4.</span> <span class="nav-text">安装单用户模式具体步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-解压hive安装包"><span class="nav-number">6.4.0.1.</span> <span class="nav-text">1.解压hive安装包</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-配置环境变量"><span class="nav-number">6.4.0.2.</span> <span class="nav-text">2.配置环境变量</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-修改配置文件"><span class="nav-number">6.4.0.3.</span> <span class="nav-text">3.修改配置文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-把JDBC驱动包放到Hive-lib目录下"><span class="nav-number">6.4.0.4.</span> <span class="nav-text">4.把JDBC驱动包放到Hive lib目录下</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-让hadoop的jline包和hive的jline包版本保持一致（高版本替换低版本）"><span class="nav-number">6.4.0.5.</span> <span class="nav-text">5.让hadoop的jline包和hive的jline包版本保持一致（高版本替换低版本）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#6-启动Hive"><span class="nav-number">6.4.0.6.</span> <span class="nav-text">6.启动Hive</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装多用户模式具体步骤"><span class="nav-number">6.5.</span> <span class="nav-text">安装多用户模式具体步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#角色划分"><span class="nav-number">6.5.1.</span> <span class="nav-text">角色划分</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-将hive文件夹copy到node04、node04"><span class="nav-number">6.5.2.</span> <span class="nav-text">1.将hive文件夹copy到node04、node04</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-把node02的环境变量配置文件copy到node03、node04"><span class="nav-number">6.5.3.</span> <span class="nav-text">2.把node02的环境变量配置文件copy到node03、node04</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-修改node03（客户端）的-hive的配置文件"><span class="nav-number">6.5.4.</span> <span class="nav-text">3.    修改node03（客户端）的 hive的配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-修改node04（服务端）的配置文件"><span class="nav-number">6.5.5.</span> <span class="nav-text">4.修改node04（服务端）的配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-使node03和node04的jline包和hadoop包保持版本一致"><span class="nav-number">6.5.6.</span> <span class="nav-text">5.使node03和node04的jline包和hadoop包保持版本一致</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-启动hive服务端"><span class="nav-number">6.5.7.</span> <span class="nav-text">6.启动hive服务端</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-启动客户端"><span class="nav-number">6.5.8.</span> <span class="nav-text">7.启动客户端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive的数据类型"><span class="nav-number">7.</span> <span class="nav-text">Hive的数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#primitive-type："><span class="nav-number">7.1.</span> <span class="nav-text">primitive_type：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DDL（Data-Definition-Language）"><span class="nav-number">8.</span> <span class="nav-text">DDL（Data Definition Language）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Create-Database"><span class="nav-number">8.1.</span> <span class="nav-text">Create Database</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Drop-Database"><span class="nav-number">8.2.</span> <span class="nav-text">Drop Database</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Alter-Database"><span class="nav-number">8.3.</span> <span class="nav-text">Alter Database</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Use-Database"><span class="nav-number">8.4.</span> <span class="nav-text">Use Database</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Create-Table"><span class="nav-number">8.5.</span> <span class="nav-text">Create Table</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例练习"><span class="nav-number">8.6.</span> <span class="nav-text">示例练习</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Loading-files-into-tables"><span class="nav-number">8.7.</span> <span class="nav-text">Loading files into tables</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#内部表与外部表的区别"><span class="nav-number">8.8.</span> <span class="nav-text">内部表与外部表的区别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分区"><span class="nav-number">8.9.</span> <span class="nav-text">分区</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DML（Data-Manipulation-Language）"><span class="nav-number">9.</span> <span class="nav-text">DML（Data Manipulation Language）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用Beeline连接Hive"><span class="nav-number">10.</span> <span class="nav-text">使用Beeline连接Hive</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务端启动hiveserver2"><span class="nav-number">10.1.</span> <span class="nav-text">服务端启动hiveserver2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端进入beeline并连接"><span class="nav-number">10.2.</span> <span class="nav-text">客户端进入beeline并连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#退出连接"><span class="nav-number">10.3.</span> <span class="nav-text">退出连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#另一种连接方法"><span class="nav-number">10.4.</span> <span class="nav-text">另一种连接方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive-JDBC"><span class="nav-number">11.</span> <span class="nav-text">Hive JDBC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Regex"><span class="nav-number">12.</span> <span class="nav-text">Regex</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#函数"><span class="nav-number">13.</span> <span class="nav-text">函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义函数"><span class="nav-number">13.1.</span> <span class="nav-text">自定义函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UDF开发"><span class="nav-number">13.2.</span> <span class="nav-text">UDF开发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UDAF自定义集函数"><span class="nav-number">13.3.</span> <span class="nav-text">UDAF自定义集函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#案例-输出数据时部分内容显示为“-”"><span class="nav-number">13.4.</span> <span class="nav-text">案例-输出数据时部分内容显示为“*”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#案例"><span class="nav-number">13.5.</span> <span class="nav-text">案例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基站掉话率"><span class="nav-number">13.6.</span> <span class="nav-text">基站掉话率</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#WordCount"><span class="nav-number">13.7.</span> <span class="nav-text">WordCount</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive参数和变量"><span class="nav-number">14.</span> <span class="nav-text">Hive参数和变量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#hive-参数设置方式"><span class="nav-number">14.1.</span> <span class="nav-text">hive 参数设置方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive动态分区"><span class="nav-number">15.</span> <span class="nav-text">Hive动态分区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive分桶"><span class="nav-number">16.</span> <span class="nav-text">Hive分桶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive-Lateral-View"><span class="nav-number">17.</span> <span class="nav-text">Hive Lateral View</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive-View视图"><span class="nav-number">18.</span> <span class="nav-text">Hive View视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive索引"><span class="nav-number">19.</span> <span class="nav-text">Hive索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive运行方式"><span class="nav-number">20.</span> <span class="nav-text">Hive运行方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#命令行模式"><span class="nav-number">20.1.</span> <span class="nav-text">命令行模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#脚本方式运行"><span class="nav-number">20.2.</span> <span class="nav-text">脚本方式运行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Web-GUI接口-hwi"><span class="nav-number">20.3.</span> <span class="nav-text">Web GUI接口-hwi</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-把apache-hive-src-hwi-web-下的所有文件打成war包"><span class="nav-number">20.3.1.</span> <span class="nav-text">1.把apache-hive-*-src/hwi/web/下的所有文件打成war包</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-把war包上传到-HIVE-HOME-lib-下（服务端）"><span class="nav-number">20.3.2.</span> <span class="nav-text">2.把war包上传到$HIVE_HOME/lib/下（服务端）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-把JAVA-HOME-lib-下的tool-jar拷贝到-HIVE-HOME-lib-下"><span class="nav-number">20.3.3.</span> <span class="nav-text">3.把JAVA_HOME/lib/下的tool.jar拷贝到$HIVE_HOME/lib/下</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-修改hive-site-xml，添加如下配置"><span class="nav-number">20.3.4.</span> <span class="nav-text">4.修改hive-site.xml，添加如下配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-启动hwi服务"><span class="nav-number">20.3.5.</span> <span class="nav-text">5.启动hwi服务</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-访问浏览器"><span class="nav-number">20.3.6.</span> <span class="nav-text">6.访问浏览器</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive优化"><span class="nav-number">21.</span> <span class="nav-text">Hive优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#本地模式提高执行效率"><span class="nav-number">21.1.</span> <span class="nav-text">本地模式提高执行效率</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#并行计算"><span class="nav-number">21.2.</span> <span class="nav-text">并行计算</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#严格模式"><span class="nav-number">21.3.</span> <span class="nav-text">严格模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#严格模式详解"><span class="nav-number">21.3.1.</span> <span class="nav-text">严格模式详解</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1）带有分区的表的查询"><span class="nav-number">21.3.1.1.</span> <span class="nav-text">1）带有分区的表的查询</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2）带有orderby的查询"><span class="nav-number">21.3.1.2.</span> <span class="nav-text">2）带有orderby的查询</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3）限制笛卡尔积的查询"><span class="nav-number">21.3.1.3.</span> <span class="nav-text">3）限制笛卡尔积的查询</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hive排序"><span class="nav-number">21.4.</span> <span class="nav-text">Hive排序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hive-join"><span class="nav-number">21.5.</span> <span class="nav-text">Hive join</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Join计算时，将小表（驱动表）放在join的左边"><span class="nav-number">21.5.1.</span> <span class="nav-text">Join计算时，将小表（驱动表）放在join的左边</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Map端完成Join（避免数据倾斜）"><span class="nav-number">21.5.2.</span> <span class="nav-text">Map端完成Join（避免数据倾斜）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Map-Side聚合"><span class="nav-number">21.6.</span> <span class="nav-text">Map-Side聚合</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#无效ID在关联时的数据倾斜问题"><span class="nav-number">21.7.</span> <span class="nav-text">无效ID在关联时的数据倾斜问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#解决方法-1：user-id-为空的不参与关联，子查询过滤-null"><span class="nav-number">21.7.1.</span> <span class="nav-text">解决方法 1：user_id 为空的不参与关联，子查询过滤 null</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#解决方法-2-如下所示：函数过滤-null"><span class="nav-number">21.7.2.</span> <span class="nav-text">解决方法 2 如下所示：函数过滤 null</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#控制Hive中Map以及Reduce的数量"><span class="nav-number">21.8.</span> <span class="nav-text">控制Hive中Map以及Reduce的数量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JVM重用"><span class="nav-number">21.9.</span> <span class="nav-text">JVM重用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive窗口函数分组取TopN"><span class="nav-number">22.</span> <span class="nav-text">Hive窗口函数分组取TopN</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考资料"><span class="nav-number">23.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chant</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  







  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/three/three.min.js"></script>

  
  <script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://chant00.com/2016/11/28/ Hive学习笔记/';
          this.page.identifier = '2016/11/28/ Hive学习笔记/';
          this.page.title = 'Hive学习笔记';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://chant-1.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("7n9J9l0UCv4yQu1307uCu3oM-gzGzoHsz", "OUDiIhwsTbY8xOgAKOuYf7Xb");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  


  

  

</body>
</html>
