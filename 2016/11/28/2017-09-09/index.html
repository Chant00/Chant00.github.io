<!doctype html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  
    
      
    

    
  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Fredericka the Great:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="HBase,HBase原理及其搭建," />





  <link rel="alternate" href="/atom.xml" title="Chant" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="Hbase架构，原理，搭建，练习，表设计，写表，读表的优化">
<meta property="og:type" content="article">
<meta property="og:title" content="HBase学习笔记">
<meta property="og:url" content="http://chant00.com/2016/11/28/2017-09-09/index.html">
<meta property="og:site_name" content="Chant">
<meta property="og:description" content="Hbase架构，原理，搭建，练习，表设计，写表，读表的优化">
<meta property="og:image" content="http://chant00.com/media/15049342042644.jpg">
<meta property="og:image" content="http://chant00.com/media/15049342795251.jpg">
<meta property="og:image" content="http://chant00.com/media/15049350315173.jpg">
<meta property="og:image" content="http://chant00.com/media/15049353392609.jpg">
<meta property="og:image" content="http://chant00.com/media/15049354432212.jpg">
<meta property="og:image" content="http://chant00.com/media/15049355282433.jpg">
<meta property="og:image" content="http://chant00.com/media/15049356652756.jpg">
<meta property="og:image" content="http://chant00.com/media/15049356789339.jpg">
<meta property="og:image" content="http://chant00.com/media/15049399011765.jpg">
<meta property="og:image" content="http://chant00.com/media/15049401864093.jpg">
<meta property="og:image" content="http://chant00.com/media/15049402267437.jpg">
<meta property="og:image" content="http://chant00.com/media/15049402402031.jpg">
<meta property="og:image" content="http://chant00.com/media/15049408045777.jpg">
<meta property="og:image" content="http://chant00.com/media/15049408398775.jpg">
<meta property="og:image" content="http://chant00.com/media/15049409080848.jpg">
<meta property="og:image" content="http://chant00.com/media/15049409225534.jpg">
<meta property="og:image" content="http://chant00.com/media/15049409408141.jpg">
<meta property="og:updated_time" content="2017-09-10T06:50:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HBase学习笔记">
<meta name="twitter:description" content="Hbase架构，原理，搭建，练习，表设计，写表，读表的优化">
<meta name="twitter:image" content="http://chant00.com/media/15049342042644.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://chant00.com/2016/11/28/2017-09-09/"/>





  <title>HBase学习笔记 | Chant</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?20a728b896cddba838b0448e60f910f5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>











  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Chant</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Take things as they are with a cavalier attitude./用漫不经心的态度过随遇而安的生活</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-favourite">
          <a href="/favourite" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            颜如玉
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://chant00.com/2016/11/28/2017-09-09/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chant">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chant">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">HBase学习笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-28T08:47:49+08:00">
                2016-11-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Bigdata/" itemprop="url" rel="index">
                    <span itemprop="name">Bigdata</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Bigdata/HBase/" itemprop="url" rel="index">
                    <span itemprop="name">HBase</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/11/28/2017-09-09/" class="leancloud_visitors" data-flag-title="HBase学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <script src="/assets/js/DPlayer.min.js"> </script><script src="/assets/js/APlayer.min.js"> </script><p>Hbase架构，原理，搭建，练习，表设计，写表，读表的优化</p>
<a id="more"></a><br>### Hadoop生态系统<br><img src="/media/15049342042644.jpg" alt=""><br>### HBase简介<br>HBase -Hadoop Database，是一个高可靠性、高性能、面向列、可伸缩、可实时读写的分布式数据库，利用Hadoop HDFS作为其文件存储系统，利用Hadoop MapReduce来处理HBase中的海量数据，利用Zookeeper作为其分布式协同服务，主要用来存储非结构化和半结构化的松散数据（列存 NoSQL 数据库）。<br>#### 列式数据库<br>列式数据库是以列相关存储架构进行数据存储的数据库，主要适合与批量数据处理和即席查询。相对应的是行式数据库，数据以行相关的存储体系架构进行空间分配，主要适合与小批量的数据处理，常用于联机事务型数据处理。<br>列式数据库以行、列的二维表的形式存储数据，但是却以一维字符串的方式存储，例如以下的一个表：<br><img src="/media/15049342795251.jpg" alt=""><br>这个简单的表包括员工代码(EmpId), 姓名字段(Lastname and Firstname)及工资(Salary).这个表存储在电脑的内存(RAM)和存储(硬盘)中。虽然内存和硬盘在机制上不同，电脑的操作系统是以同样的方式存储的。数据库必须把这个二维表存储在一系列一维的“字节”中，操作系统把它们写到内存或硬盘中。<br><br>行式数据库把一行中的数据值串在一起存储起来，然后再存储下一行的数据，以此类推。<br>1,Smith,Joe,40000;2,Jones,Mary,50000;3,Johnson,Cathy,44000;<br>列式数据库把一列中的数据值串在一起存储起来，然后再存储下一列的数据，以此类推。<br>1,2,3;Smith,Jones,Johnson;Joe,Mary,Cathy;40000,50000,44000;<br>### HBase数据模型<br>在HBase中，数据是存储在有行有列的表格中。这是与关系型数据库重复的术语，但不能做类比。相反，HBase可以被认为是一个多维度的映射。<br><br>#### HBase数据模型术语<br>##### Table（表格）<br>一个HBase表格由多行组成。<br>##### Row（行）<br>HBase中的行里面包含一个key和一个或者多个包含值的列。行按照行的key字母顺序存储在表格中。Row key只能存储64k的字节数据。因为这个原因，行的key的设计就显得非常重要。数据的存储目标是相近的数据存储到一起。一个常用的行的key的格式是网站域名。如果你的行的key是域名，你应该将域名进行反转(org.apache.www, org.apache.mail, org.apache.jira)再存储。这样的话，所有Apache域名将会存储在一起，好过基于子域名的首字母分散在各处。<br><br>##### Column（列）<br>HBase中的列包含用：分隔开的列族和列的限定符。<br><br>##### Column Family（列族）<br>因为性能的原因，列族物理上包含一组列和它们的值。每一个列族拥有一系列的存储属性，例如值是否缓存在内存中，数据是否要压缩或者他的行key是否要加密等等。表格中的每一行拥有相同的列族，尽管一个给定的行可能没有存储任何数据在一个给定的列族中。<br><br>##### Column Qualifier（列的限定符）<br>列的限定符是列族中数据的索引。例如给定了一个列族content，那么限定符可能是content:html，也可以是content:pdf。列族在创建表格时是确定的了，但是列的限定符是动态地并且行与行之间的差别也可能是非常大的。<br>HBase表中的每个列都归属于某个列族，列族必须作为表模式(schema)定义的一部分预先给出。如 create ‘test’, ‘course’；<br>列名以列族作为前缀，每个“列族”都可以有多个列成员(column)；如course:math, course:english，新的列族成员（列）可以随后按需、动态加入；<br>权限控制、存储以及调优都是在列族层面进行的；<br>HBase把同一列族里面的数据存储在同一目录下，由几个文件保存。<br><br>##### Cell（单元）<br>由行和列的坐标交叉决定；<br>单元格是有版本的；<br>单元格的内容是未解析的字节数组；<br>单元格是由行、列族、列限定符、值和代表值版本的时间戳组成的（{row key， column( =<family> +<qualifier>)， version} ）唯一确定单元格。cell中的数据是没有类型的，全部是字节码形式存储。<br><br>##### Timestamp（时间戳）<br>时间戳是写在值旁边的一个用于区分值的版本的数据。默认情况下，时间戳表示的是当数据写入时RegionSever的时间点，但你也可以在写入数据时指定一个不同的时间戳。<br>在HBase每个cell存储单元对同一份数据有多个版本，根据唯一的时间戳来区分每个版本之间的差异，不同版本的数据按照时间倒序排序，最新的数据版本排在最前面。<br>时间戳的类型是64位整型。时间戳可以由HBase(在数据写入时自动)赋值，此时时间戳是精确到毫秒的当前系统时间。时间戳也可以由客户显式赋值，如果应用程序要避免数据版本冲突，就必须自己生成具有唯一性的时间戳。<br>##### 概念视图<br>例子:<br>一个名为webable的表格，表格中有两行（com.cnn.www 和 com.example.www）和三个列族（contents, anchor和people）。在这个例子当中，第一行(com.cnn.www)中anchor包含两列（anchor:cssnsi.com, anchor:my.look.ca）和content包含一列（contents:html）。这个例子中com.cnn.www拥有5个版本而com.example.www有一个版本。contents:html列中包含给定网页的整个HTML。anchor限定符包含能够表示行的站点以及链接中文本。People列族表示跟站点有关的人。<br><img src="/media/15049350315173.jpg" alt="Table webtable"><br><br>在HBase中，表格中的单元如果是空将不占用空间或者事实上不存在。这就使得HBase看起来“稀疏”。表格视图不是唯一方式来查看HBase中数据，甚至不是最精确的。下面的方式以多维度映射的方式来表达相同的信息。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">&quot;com.cnn.www&quot;: &#123;</div><div class="line">contents: &#123;</div><div class="line">t6: contents:html: &quot;&lt;html&gt;...&quot;</div><div class="line">t5: contents:html: &quot;&lt;html&gt;...&quot;</div><div class="line">t3: contents:html: &quot;&lt;html&gt;...&quot;</div><div class="line">&#125;</div><div class="line">    	anchor: &#123;</div><div class="line">      		t9: anchor:cnnsi.com = &quot;CNN&quot;</div><div class="line">t8: anchor:my.look.ca = &quot;CNN.com&quot;</div><div class="line">    	&#125;</div><div class="line">people: &#123;&#125;</div><div class="line">  	&#125;</div><div class="line">&quot;com.example.www&quot;: &#123;</div><div class="line">    	contents: &#123;</div><div class="line">t5: contents:html: &quot;&lt;html&gt;...&quot;</div><div class="line">    	&#125;</div><div class="line">    	anchor: &#123;&#125;</div><div class="line">    	people: &#123;</div><div class="line">      		t5: people:author: &quot;John Doe&quot;</div><div class="line">    	&#125;</div><div class="line">  	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="物理视图"><a href="#物理视图" class="headerlink" title="物理视图"></a>物理视图</h4><p>尽管一个概念层次的表格可能看起来是由一些列稀疏的行组成，但他们是通过列族来存储的。一个新建的限定符(column_family:column_qualifier)可以随时地添加到已存在的列族中。<br><img src="/media/15049353392609.jpg" alt="ColumnFamily anchor"><br><img src="/media/15049354432212.jpg" alt="ColumnFamily contents"></p>
<p>概念视图中的空单元实际上是没有进行存储的。因此对于返回时间戳为t8的contents:html的值的请求，结果为空。同样的，一个返回时间戳为t9的anchor:my.look.ca的值的请求，结果也为空。然而，如果没有指定时间戳的话，那么会返回特定列的最新值。对有多个版本的列，优先返回最新的值，因为时间戳是按照递减顺序存储的。因此对于一个返回com.cnn.www里面所有的列的值并且没有指定时间戳的请求，返回的结果会是时间戳为t6的contents:html 的值、时间戳 t9的anchor:cnnsi.com f的值和时间戳t8的anchor:my.look.ca。</p>
<h3 id="HBase体系架构"><a href="#HBase体系架构" class="headerlink" title="HBase体系架构"></a>HBase体系架构</h3><p><img src="/media/15049355282433.jpg" alt=""></p>
<h4 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h4><p>包含访问HBase的接口并维护cache来加快对HBase的访问</p>
<h4 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h4><ul>
<li>保证任何时候，集群中只有一个工作状态和master。</li>
<li>存储所有Region的寻址入口。</li>
<li>实时监控Region server的上线和下线信息。并实时通知Master。</li>
<li>存储HBase的schema和table元数据。</li>
</ul>
<h4 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h4><ul>
<li>为Region server分配region</li>
<li>负责Region server的负载均衡</li>
<li>发现失效的Region server并重新分配其上的region</li>
<li>管理用户对table的增删改操作</li>
</ul>
<h4 id="RegionServer"><a href="#RegionServer" class="headerlink" title="RegionServer"></a>RegionServer</h4><p>Region server维护region，处理对这些region的IO请求。<br>Region server负责切分在运行过程中变得过大的region。</p>
<h3 id="存储模型"><a href="#存储模型" class="headerlink" title="存储模型"></a>存储模型</h3><h4 id="region"><a href="#region" class="headerlink" title="region"></a>region</h4><p>HBase自动把表水平划分成多个区域(region)，每个region会保存一个表里面某段连续的数据；每个表一开始只有一个region，随着数据不断插入表，region不断增大，当增大到一个阀值的时候，region就会等分会两个新的region（裂变）；当table中的行不断增多，就会有越来越多的region。这样一张完整的表被保存在多个Regionserver 上。</p>
<h4 id="HLog-WAL-log"><a href="#HLog-WAL-log" class="headerlink" title="HLog(WAL log)"></a>HLog(WAL log)</h4><p>HLog文件就是一个普通的Hadoop Sequence File，Sequence File的Key是HLogKey对象，HLogKey中记录了写入数据的归属信息，除了table和region名字外，同时还包括 sequence number和timestamp，timestamp是“写入时间”，sequence number的起始值为0，或者是最近一次存入文件系统中的sequence number。<br>HLog SequeceFile的Value是HBase的KeyValue对象，即对应HFile中的KeyValue。</p>
<h4 id="数据模型：Memstore-与-storefile"><a href="#数据模型：Memstore-与-storefile" class="headerlink" title="数据模型：Memstore 与 storefile"></a>数据模型：Memstore 与 storefile</h4><p>一个region由多个store组成，一个store对应一个CF（列族）。store包括位于内存中的memstore和位于磁盘的storefile，写操作先写入memstore，当memstore中的数据达到某个阈值，hregionserver会启动flashcache进程写入storefile，每次写入形成单独的一个storefile，当storefile文件的数量增长到一定阈值后，系统会进行合并（minor、major compaction），在合并过程中会进行版本合并和删除工作（majar），形成更大的storefile<br>当一个region所有storefile的大小和数量超过一定阈值后，会把当前的region分割为两个，并由hmaster分配到相应的regionserver服务器，实现负载均衡，客户端检索数据，先在memstore找，找不到再找storefile。</p>
<p>HRegion是HBase中分布式存储和负载均衡的最小单元。最小单元就表示不同的HRegion可以分布在不同的 HRegion server上。HRegion由一个或者多个Store组成，每个store保存一个columns family。每个Strore又由一个memStore和0至多个StoreFile组成。如图：StoreFile以HFile格式保存在HDFS上。<br><img src="/media/15049356652756.jpg" alt=""><br><img src="/media/15049356789339.jpg" alt=""></p>
<h3 id="HBase伪分布式搭建（node01）"><a href="#HBase伪分布式搭建（node01）" class="headerlink" title="HBase伪分布式搭建（node01）"></a>HBase伪分布式搭建（node01）</h3><h6 id="0-启动zookeeper集群和hadoop集群"><a href="#0-启动zookeeper集群和hadoop集群" class="headerlink" title="0.启动zookeeper集群和hadoop集群"></a>0.启动zookeeper集群和hadoop集群</h6><p>zkServer.sh start<br>start-dfs.sh<br>start-yarn.sh<br>yarn-daemon.sh start resourcemanager<br>JDK安装好，环境变量配置好</p>
<h6 id="1-解压hbase安装包"><a href="#1-解压hbase安装包" class="headerlink" title="1.解压hbase安装包"></a>1.解压hbase安装包</h6><p><code>[root@node01 sxt]# tar xf hbase-0.98.12.1-hadoop2-bin.tar.gz</code></p>
<h6 id="2-配置环境变量"><a href="#2-配置环境变量" class="headerlink" title="2.配置环境变量"></a>2.配置环境变量</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@node01 sxt]# vi + /etc/profile</div><div class="line">export JAVA_HOME=/usr/java/jdk1.7.0_67</div><div class="line">export PATH=$PATH:$JAVA_HOME/bin</div><div class="line">export HADOOP_PREFIX=/opt/sxt/hadoop-2.6.5</div><div class="line">export PATH=$PATH:$HADOOP_PREFIX/bin:$HADOOP_PREFIX/sbin</div><div class="line">export ZOOKEEPER_PREFIX=/opt/sxt/zookeeper-3.4.6</div><div class="line">export PATH=$PATH:$ZOOKEEPER_PREFIX/bin</div><div class="line">export HBASE_HOME=/opt/sxt/hbase-0.98.12.1</div><div class="line">export PATH=$PATH:$HBASE_HOME/bin</div><div class="line">[root@node01 sxt]# . /etc/profile</div></pre></td></tr></table></figure>
<h6 id="3-hbase-env-sh中配置JAVA-HOME"><a href="#3-hbase-env-sh中配置JAVA-HOME" class="headerlink" title="3.hbase-env.sh中配置JAVA_HOME"></a>3.hbase-env.sh中配置JAVA_HOME</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@node01 sxt]# cd hbase-0.98.12.1/conf/</div><div class="line">[root@node01 conf]# vi hbase-env.sh</div><div class="line">export JAVA_HOME=/usr/java/jdk1.7.0_67</div></pre></td></tr></table></figure>
<h6 id="4-修改hbase-site-xml配置文件"><a href="#4-修改hbase-site-xml配置文件" class="headerlink" title="4.修改hbase-site.xml配置文件"></a>4.修改hbase-site.xml配置文件</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@node01 conf]# vi hbase-site.xml</div><div class="line">&lt;configuration&gt;</div><div class="line"></div><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;hbase.rootdir&lt;/name&gt;</div><div class="line">    &lt;value&gt;file:///var/hbase/local&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"></div><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;hbase.zookeeper.property.dataDir&lt;/name&gt;</div><div class="line">    &lt;value&gt;/var/hbase/local/zookeeper&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"></div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<h6 id="5-启动hbase"><a href="#5-启动hbase" class="headerlink" title="5.启动hbase"></a>5.启动hbase</h6><p><code>[root@node01 conf]# start-hbase.sh</code></p>
<h6 id="6-进入hbase命令行"><a href="#6-进入hbase命令行" class="headerlink" title="6.进入hbase命令行"></a>6.进入hbase命令行</h6><p><code>[root@node01 conf]# hbase shell</code></p>
<h3 id="基础命令练习"><a href="#基础命令练习" class="headerlink" title="基础命令练习"></a>基础命令练习</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">hbase删除已经打好的命令：ctrl+backspace</div><div class="line"></div><div class="line">hbase(main):002:0&gt; version</div><div class="line">0.98.12.1-hadoop2, rb00ec5da604d64a0bdc7d92452b1e0559f0f5d73, Sun May 17 12:55:03 PDT 2015</div><div class="line"></div><div class="line">hbase(main):003:0&gt; whoami</div><div class="line">SLF4J: Class path contains multiple SLF4J bindings.</div><div class="line">SLF4J: Found binding in [jar:file:/opt/sxt/hbase-0.98.12.1/lib/slf4j-log4j12-1.6.4.jar!/org/slf4j/impl/StaticLoggerBinder.class]</div><div class="line">SLF4J: Found binding in [jar:file:/opt/sxt/hadoop-2.6.5/share/hadoop/common/lib/slf4j-log4j12-1.7.5.jar!/org/slf4j/impl/StaticLoggerBi</div><div class="line">nder.class]SLF4J: See http://www.slf4j.org/codes.html#multiple_bindings for an explanation.</div><div class="line">root (auth:SIMPLE)</div><div class="line">    groups: root</div><div class="line"></div><div class="line">建表</div><div class="line">                                       表名   列族  列族</div><div class="line">hbase(main):004:0&gt;hbase(main):006:0&gt; create &apos;person&apos;,&apos;name&apos;, &apos;age&apos;</div><div class="line"></div><div class="line">查看有哪些表</div><div class="line">hbase(main):007:0&gt; list</div><div class="line">TABLE                                                                             </div><div class="line">person</div><div class="line"></div><div class="line">查看表描述</div><div class="line">hbase(main):010:0&gt; describe &apos;person&apos;</div><div class="line">Table person is ENABLED                                                                                                               </div><div class="line">person                                                                                                                                </div><div class="line">COLUMN FAMILIES DESCRIPTION                                                                                                           </div><div class="line">&#123;NAME =&gt; &apos;age&apos;, DATA_BLOCK_ENCODING =&gt; &apos;NONE&apos;, BLOOMFILTER =&gt; &apos;ROW&apos;, REPLICATION_SCOPE =&gt; &apos;0&apos;, VERSIONS =&gt; &apos;1&apos;, COMPRESSION =&gt; &apos;NONE&apos;,</div><div class="line">MIN_VERSIONS =&gt; &apos;0&apos;, TTL =&gt; &apos;FOREVER&apos;, KEEP_DELETED_CELLS =&gt; &apos;FALSE&apos;, </div><div class="line">BLOCKSIZE =&gt; &apos;65536&apos;, IN_MEMORY =&gt; &apos;false&apos;, BLOCKCACHE =&gt; &apos;true&apos;&#125;                                                                                                                                    </div><div class="line">&#123;NAME =&gt; &apos;name&apos;, DATA_BLOCK_ENCODING =&gt; &apos;NONE&apos;, BLOOMFILTER =&gt; &apos;ROW&apos;, REPLICATION_SCOPE =&gt; &apos;0&apos;, VERSIONS =&gt; &apos;1&apos;, COMPRESSION =&gt; &apos;NONE&apos;, </div><div class="line">MIN_VERSIONS =&gt; &apos;0&apos;, TTL =&gt; &apos;FOREVER&apos;, KEEP_DELETED_CELLS =&gt; &apos;FALSE&apos;,</div><div class="line">BLOCKSIZE =&gt; &apos;65536&apos;, IN_MEMORY =&gt; &apos;false&apos;, BLOCKCACHE =&gt; &apos;true&apos;&#125;</div><div class="line">NAME：列族名</div><div class="line">VERSIONS：最大版本号</div><div class="line">MIN_VERSIONS：最小版本号</div><div class="line">TTL（Time To Live）：存活时间</div><div class="line">IN_MEMORY：是否开启缓存，默认false，应该开启，否则与BLOCKCACHE冲突</div><div class="line">BLOCKCACHE：读缓存是否开启，默认开启，64M</div><div class="line"></div><div class="line">插入数据</div><div class="line">hbase(main):012:0&gt; put &apos;person&apos;,&apos;0001&apos;,&apos;name:firstname&apos;,&apos;Jed&apos;</div><div class="line">hbase(main):013:0&gt; put &apos;person&apos;,&apos;0001&apos;,&apos;age:zhousui&apos;,&apos;20&apos;</div><div class="line"></div><div class="line">查看全部数据</div><div class="line">hbase(main):014:0&gt; scan &apos;person&apos;</div><div class="line">ROW                   COLUMN+CELL                                                 </div><div class="line"> 0001                 column=age:zhousui, timestamp=1499929503879, value=20       </div><div class="line"> 0001                 column=name:firstname, timestamp=1499929407656, value=Jed</div><div class="line"></div><div class="line">查看个别数据</div><div class="line">hbase(main):015:0&gt; get &apos;person&apos;,&apos;0001&apos;,&apos;name:firstname&apos;</div><div class="line">COLUMN                CELL                                                        </div><div class="line"> name:firstname       timestamp=1499929407656, value=Jed</div><div class="line"></div><div class="line">修改数据</div><div class="line">hbase(main):016:0&gt; put &apos;person&apos;,&apos;0001&apos;,&apos;name:firstname&apos;,&apos;Tom&apos;</div><div class="line">hbase(main):017:0&gt; get &apos;person&apos;,&apos;0001&apos;,&apos;name:firstname&apos;</div><div class="line">COLUMN                CELL                                                        </div><div class="line"> name:firstname       timestamp=1499929924936, value=Tom                          </div><div class="line"></div><div class="line">查看表空间</div><div class="line">hbase(main):018:0&gt; list_namespace</div><div class="line">NAMESPACE                                                                         </div><div class="line">default #用户创建的表放在这里                                                                       </div><div class="line">hbase #系统表空间</div><div class="line"></div><div class="line">进入存放数据的目录/var/hbase/local（在hbase-site.xml中配置过）</div><div class="line">[root@node01 ~]# cd /var/hbase/local/</div><div class="line">[root@node01 local]# ls</div><div class="line">archive  data  hbase.id  hbase.version  oldWALs  WALs  zookeeper</div><div class="line">data是存放数据的目录，oldWAL和WALs是Hlog</div><div class="line">[root@node01 local]# cd data</div><div class="line">[root@node01 data]# ls</div><div class="line">default  hbase</div><div class="line">[root@node01 data]# cd default/</div><div class="line">[root@node01 default]# ls</div><div class="line">person</div><div class="line">[root@node01 default]# cd person/</div><div class="line">[root@node01 person]# ls</div><div class="line">b14e1200e562fb736ce81df88d712823</div><div class="line">[root@node01 person]# cd b14e1200e562fb736ce81df88d712823/</div><div class="line">[root@node01 b14e1200e562fb736ce81df88d712823]# ls</div><div class="line">age  name</div><div class="line">[root@node01 b14e1200e562fb736ce81df88d712823]# cd age</div><div class="line">[root@node01 age]# cd ls</div><div class="line">总用量 0</div><div class="line">age和name下没有数据，因为数据还在内存中，我们设置强制溢写</div><div class="line">hbase(main):028:0&gt; flush &apos;person&apos;</div><div class="line">root@node01 b14e1200e562fb736ce81df88d712823]# cd age/</div><div class="line">[root@node01 age]# ls</div><div class="line">06c01947d23e4fafa3a95bd407cc8c94</div><div class="line">[root@node01 age]# hbase hfile -p -f 06c01947d23e4fafa3a95bd407cc8c94</div><div class="line">K: 0001/age:zhousui/1499931020776/Put/vlen=2/mvcc=0 V: 20</div><div class="line"></div><div class="line"></div><div class="line">删除表</div><div class="line">hbase(main):021:0&gt; disable &apos;person&apos; #先让表禁用</div><div class="line">hbase(main):022:0&gt; drop &apos;person&apos; #再删除表</div></pre></td></tr></table></figure>
<h3 id="HBase完全分布式搭建"><a href="#HBase完全分布式搭建" class="headerlink" title="HBase完全分布式搭建"></a>HBase完全分布式搭建</h3><h4 id="角色分布"><a href="#角色分布" class="headerlink" title="角色分布"></a>角色分布</h4><p><img src="/media/15049399011765.jpg" alt=""></p>
<p>在生产中，不要把namenode和HbaseMaster配置到一台机器上。</p>
<h6 id="0-再准备一台机器node05"><a href="#0-再准备一台机器node05" class="headerlink" title="0.    再准备一台机器node05"></a>0.    再准备一台机器node05</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">vi /etc/sysconfig/network-scripts/ifcfg-eth0</div><div class="line">vi /etc/sysconfig/network</div><div class="line">vi /etc/hosts</div><div class="line">编辑C:\Windows\System32\drivers\etc\hosts文件</div><div class="line">node05免秘钥</div><div class="line">[root@node01 .ssh]# vi authorized_keys 复制一行，末尾改为node05</div><div class="line">[root@node05 ~]# ssh-keygen -t dsa -P &apos;&apos; -f ~/.ssh/id_dsa</div><div class="line">[root@node01 .ssh]# scp ./* node04:`pwd`</div></pre></td></tr></table></figure>
<p>安装jdk<br>一定要保证集群中所有机器的系统时间相同！</p>
<h6 id="1-从node01上分发hbase目录到其他机器"><a href="#1-从node01上分发hbase目录到其他机器" class="headerlink" title="1.从node01上分发hbase目录到其他机器"></a>1.从node01上分发hbase目录到其他机器</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@node01 sxt]# scp -r hbase-0.98.12.1 node02:`pwd`</div><div class="line">[root@node01 sxt]# scp -r hbase-0.98.12.1 node03:`pwd`</div><div class="line">[root@node01 sxt]# scp -r hbase-0.98.12.1 node04:`pwd`</div><div class="line">[root@node01 sxt]# scp -r hbase-0.98.12.1 node05:`pwd`</div></pre></td></tr></table></figure>
<h6 id="2-修改node01中hbase的配置文件hbase-env-sh"><a href="#2-修改node01中hbase的配置文件hbase-env-sh" class="headerlink" title="2.修改node01中hbase的配置文件hbase-env.sh"></a>2.修改node01中hbase的配置文件hbase-env.sh</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@node01 conf]# vi hbase-env.sh</div><div class="line">#不使用自带的zookeeper</div><div class="line">export HBASE_MANAGES_ZK=false</div></pre></td></tr></table></figure>
<h6 id="3-修改node01中hbase的配置文件hbase-site-xml"><a href="#3-修改node01中hbase的配置文件hbase-site-xml" class="headerlink" title="3.修改node01中hbase的配置文件hbase-site.xml"></a>3.修改node01中hbase的配置文件hbase-site.xml</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">[root@node01 conf]# vi hbase-site.xml</div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- </span></div><div class="line">可以不配置，如果要配置，需要和zookeeper配置文件中的路径相同</div><div class="line">    $ZOOKEEPER_HOME/conf/zoo.cfg中dataDir=/var/sxt/zookeeper</div><div class="line">&lt;property&gt;</div><div class="line">           &lt;name&gt;hbase.zookeeper.property.dataDir&lt;/name&gt;</div><div class="line">           &lt;value&gt;/var/sxt/zookeeper &lt;/value&gt;</div><div class="line">       &lt;/property&gt;</div><div class="line">   --&gt;</div><div class="line">   <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://mycluster/hbase<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  </div><div class="line">   <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  </div><div class="line">   <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">value</span>&gt;</span>node02,node03,node04<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure>
<h6 id="4-修改node01中hbase的配置文件regionservers"><a href="#4-修改node01中hbase的配置文件regionservers" class="headerlink" title="4.修改node01中hbase的配置文件regionservers"></a>4.修改node01中hbase的配置文件regionservers</h6><p>[root@node01 conf]# vi regionservers<br>node02<br>node03<br>node04</p>
<h6 id="5-新建backup-masters文件，并做修改"><a href="#5-新建backup-masters文件，并做修改" class="headerlink" title="5.新建backup-masters文件，并做修改"></a>5.新建backup-masters文件，并做修改</h6><p>[root@node01 conf]# vi backup-masters<br>node05</p>
<h6 id="6-把hdfs-site-xml-copy到hbase的配置目录下"><a href="#6-把hdfs-site-xml-copy到hbase的配置目录下" class="headerlink" title="6.把hdfs-site.xml copy到hbase的配置目录下"></a>6.把hdfs-site.xml copy到hbase的配置目录下</h6><p>[root@node01 conf]# cp /opt/sxt/hadoop-2.6.5/etc/hadoop/hdfs-site.xml ./</p>
<h6 id="7-同步配置文件"><a href="#7-同步配置文件" class="headerlink" title="7.同步配置文件"></a>7.同步配置文件</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@node01 conf]# scp ./* node02:`pwd`</div><div class="line">[root@node01 conf]# scp ./* node03:`pwd`</div><div class="line">[root@node01 conf]# scp ./* node04:`pwd`</div><div class="line">[root@node01 conf]# scp ./* node05:`pwd`</div></pre></td></tr></table></figure>
<h6 id="8-启动集群（先启动ZK和Hadoop集群）"><a href="#8-启动集群（先启动ZK和Hadoop集群）" class="headerlink" title="8.启动集群（先启动ZK和Hadoop集群）"></a>8.启动集群（先启动ZK和Hadoop集群）</h6><p>[root@node01 conf]# start-hbase.sh</p>
<h6 id="9-验证"><a href="#9-验证" class="headerlink" title="9.验证"></a>9.验证</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">hbase(main):004:0&gt; create &apos;person&apos;,&apos;0001&apos;,&apos;col1&apos;,&apos;col2&apos;</div><div class="line">hbase(main):005:0&gt; list</div><div class="line">TABLE                                                                                                                                 </div><div class="line">person</div></pre></td></tr></table></figure>
<p><img src="/media/15049401864093.jpg" alt=""><br>配置成功！</p>
<h4 id="验证集群的高可用"><a href="#验证集群的高可用" class="headerlink" title="验证集群的高可用"></a>验证集群的高可用</h4><p>在node01的hbase中创建了一个表person<br>杀死node01的HMaster<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@node01 ~]# jps</div><div class="line">3220 DFSZKFailoverController</div><div class="line">6210 Jps</div><div class="line">5740 HMaster</div><div class="line">2876 NameNode</div><div class="line">3062 JournalNode</div><div class="line">[root@node01 ~]# kill -9 5740</div><div class="line">[root@node01 ~]# jps</div><div class="line">3220 DFSZKFailoverController</div><div class="line">2876 NameNode</div><div class="line">6295 Jps</div><div class="line">3062 JournalNode</div></pre></td></tr></table></figure></p>
<p>此时node01的hbase已经不能访问了<br><img src="/media/15049402267437.jpg" alt=""><br>node05变成了Master：<br><img src="/media/15049402402031.jpg" alt=""><br>在node05上进入hbase客户端，查看表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">hbase(main):001:0&gt; list</div><div class="line">TABLE                                                                                                                                 </div><div class="line">person </div><div class="line">```                                                                                                                               </div><div class="line"></div><div class="line">#### Bug解决1</div><div class="line">配置好后启动hbase，发现node05的jps中有HMaster，而node01没有，访问网页，node01无法连接，node05无法获取master</div><div class="line"></div><div class="line">Hadoop集群和Zookeeper没有任何问题，HBASE_MANAGES_ZK=false也设置了，查看日志，报错：</div><div class="line">Caused by: org.apache.hadoop.hbase.MasterNotRunningException: java.io.IOException: Can&apos;t get master address from ZooKeeper; znode data == null</div><div class="line">百思不得其解，最后发现，配置文件有问题：</div><div class="line">```xml</div><div class="line">&lt;property&gt;</div><div class="line">       &lt;name&gt;hbase.rootdir&lt;/name&gt;</div><div class="line">       &lt;value&gt;hdfs://mycluster&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line">	这里正确应该是：</div><div class="line">&lt;property&gt;</div><div class="line">       &lt;name&gt;hbase.rootdir&lt;/name&gt;</div><div class="line">       &lt;value&gt;hdfs://mycluster/hbase&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure></p>
<h4 id="Bug解决2"><a href="#Bug解决2" class="headerlink" title="Bug解决2"></a>Bug解决2</h4><p>验证hbase高可用，down掉主机后，备机并没有变成主机，两台机器的HMaster服务都关闭了，原因：解决上个bug修改配置文件后，没有同步！<br>解决办法：<br>(一)    停止hbase进程<br>主机上执行stop-hbase.sh<br>(二)    如果HregionServer进程还在，手动停止node02、node03、node03上的HregionServer<br>kill -9 HregionServerId<br>(三)    清除脏数据<br>删除HDFS中的hbase目录：hdfs dfs -rm -r /hbase<br>删除Zookeeper中的 hbase目录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@node02 conf]# zkCli.sh</div><div class="line">Welcome to ZooKeeper!</div><div class="line">[zk: localhost:2181(CONNECTED) 0] ls /</div><div class="line">[hbase, hadoop-ha, yarn-leader-election, zookeeper]</div><div class="line">[zk: localhost:2181(CONNECTED) 1] rmr /hbase</div><div class="line">[zk: localhost:2181(CONNECTED) 2] ls /</div><div class="line">[hadoop-ha, yarn-leader-election, zookeeper]</div></pre></td></tr></table></figure></p>
<p>(四)    修改之前出错的配置文件<br>同步node01和node05的配置文件<br>(五)    重启hbase，问题解决<br>一定要同步配置文件！</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>HBase依赖jar包为安装包lib目录下的jar包，可以全部引入，也可以只引入最少依赖包，再引入之前的hadoop依赖包，最少依赖包是hbase开头的包和high-scale-lib-1.1.1.jar、htrace-core-2.04.jar、netty-3.6.6.Final.jar三个包。<br>项目需要添加hbase-site.xml配置文件，与MapReduce整合时需要hadoop的相关配置文件。</p>
<h4 id="需求：通话记录查询"><a href="#需求：通话记录查询" class="headerlink" title="需求：通话记录查询"></a>需求：通话记录查询</h4><p>表：本机号码    主叫/被叫(0/1)    通话时间    对方号码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">HBaseAdmin hbaseAdmin;</div><div class="line">HTable hTable;</div><div class="line">String tableName = <span class="string">"call"</span>;</div><div class="line">     </div><div class="line"><span class="meta">@Before</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">Configuration conf = <span class="keyword">new</span> Configuration();</div><div class="line"><span class="comment">//指定hbase的zk集群</span></div><div class="line"><span class="comment">//一定要手动设置</span></div><div class="line"><span class="comment">//如果是伪分布式，指定伪分布式那台服务器</span></div><div class="line">       conf.set(<span class="string">"hbase.zookeeper.quorum"</span>,<span class="string">"node02,node03,node04"</span>);    </div><div class="line">hbaseAdmin = <span class="keyword">new</span> HBaseAdmin(conf);</div><div class="line">hTable = <span class="keyword">new</span> HTable(conf, tableName);</div><div class="line">&#125;</div><div class="line">     </div><div class="line"><span class="meta">@After</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       <span class="keyword">if</span>(hbaseAdmin != <span class="keyword">null</span>)&#123;</div><div class="line">           hbaseAdmin.close();</div><div class="line">       &#125;</div><div class="line"><span class="keyword">if</span>(hTable != <span class="keyword">null</span>)&#123;</div><div class="line">           hTable.close();</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="建表："><a href="#建表：" class="headerlink" title="建表："></a>建表：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createTable</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">         </div><div class="line">    <span class="keyword">if</span>(hbaseAdmin.tableExists(tableName)) &#123;</div><div class="line">        hbaseAdmin.disableTable(tableName);</div><div class="line">        hbaseAdmin.deleteTable(tableName);</div><div class="line">    &#125;</div><div class="line">         </div><div class="line">    <span class="comment">//表名</span></div><div class="line">    HTableDescriptor desc = <span class="keyword">new</span></div><div class="line">        HTableDescriptor(TableName.valueOf(tableName));</div><div class="line">         </div><div class="line">    <span class="comment">/*</span></div><div class="line">     * 列族的数目</div><div class="line">     * HBase currently does not do well with anything </div><div class="line">     * above two or three column families </div><div class="line">     * so keep the number of column families in your schema low.</div><div class="line">     * hbase对超过3个的列族，支持不太好</div><div class="line">     */</div><div class="line">     HColumnDescriptor family = <span class="keyword">new</span> HColumnDescriptor(<span class="string">"cf1"</span>);</div><div class="line">         </div><div class="line">     family.setBlockCacheEnabled(<span class="keyword">true</span>);<span class="comment">//开启读缓存，默认就为true</span></div><div class="line">     family.setInMemory(<span class="keyword">true</span>);<span class="comment">//开启缓存，默认false</span></div><div class="line">     family.setMaxVersions(<span class="number">1</span>);<span class="comment">//最大版本数，默认就是1</span></div><div class="line">         </div><div class="line">     desc.addFamily(family);</div><div class="line">         </div><div class="line">     hbaseAdmin.createTable(desc);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="插入数据："><a href="#插入数据：" class="headerlink" title="插入数据："></a>插入数据：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">         </div><div class="line">    <span class="comment">//rowkey设置为：手机号_时间戳</span></div><div class="line">    String rowkey = <span class="string">"18734590000_20170714104600"</span>;</div><div class="line">    Put put = <span class="keyword">new</span> Put(rowkey.getBytes());</div><div class="line">    <span class="comment">//通话类型：主叫/被叫(1/0)</span></div><div class="line">    put.add(<span class="string">"cf1"</span>.getBytes(), <span class="string">"type"</span>.getBytes(), <span class="string">"1"</span>.getBytes());</div><div class="line">    <span class="comment">//通话时间</span></div><div class="line">    put.add(<span class="string">"cf1"</span>.getBytes(), <span class="string">"time"</span>.getBytes(), </div><div class="line">        <span class="string">"2017-07-14 10:46:00"</span>.getBytes());</div><div class="line">    <span class="comment">//对方号码</span></div><div class="line">    put.add(<span class="string">"cf1"</span>.getBytes(), <span class="string">"oppoPhoneNum"</span>.getBytes(),       </div><div class="line">        <span class="string">"13876580000"</span>.getBytes());</div><div class="line">         </div><div class="line">    hTable.put(put);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="查询数据："><a href="#查询数据：" class="headerlink" title="查询数据："></a>查询数据：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">         </div><div class="line">    String rowkey = <span class="string">"18734590000_20170714104600"</span>;</div><div class="line">         </div><div class="line">    Get get = <span class="keyword">new</span> Get(rowkey.getBytes());</div><div class="line">    get.addColumn(<span class="string">"cf1"</span>.getBytes(), <span class="string">"time"</span>.getBytes());</div><div class="line">    get.addColumn(<span class="string">"cf1"</span>.getBytes(), <span class="string">"oppoPhoneNum"</span>.getBytes());</div><div class="line">    </div><div class="line">    Result result = hTable.get(get);</div><div class="line">         </div><div class="line">    Cell cell1 = result.getColumnLatestCell(<span class="string">"cf1"</span>.getBytes(),                 <span class="string">"time"</span>.getBytes());</div><div class="line">    Cell cell2 = result.getColumnLatestCell(<span class="string">"cf1"</span>.getBytes(), </div><div class="line">        <span class="string">"oppoPhoneNum"</span>.getBytes());</div><div class="line">   </div><div class="line">    System.out.println(<span class="keyword">new</span> String(CellUtil.cloneValue(cell1)));</div><div class="line">    System.out.println(<span class="keyword">new</span> String(CellUtil.cloneValue(cell2)));</div><div class="line">         </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="插入10个手机号，每个手机号有100条通话记录，-时间按降序排列："><a href="#插入10个手机号，每个手机号有100条通话记录，-时间按降序排列：" class="headerlink" title="插入10个手机号，每个手机号有100条通话记录， 时间按降序排列："></a>插入10个手机号，每个手机号有100条通话记录， 时间按降序排列：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertDB</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">         </div><div class="line">    List&lt;Put&gt; puts = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">         </div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;</div><div class="line">        String rowkey;</div><div class="line">        String phoneNum = getPhoneNum(<span class="string">"186"</span>);</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;<span class="number">100</span>; j++)&#123;</div><div class="line">            String date = getDate(<span class="string">"2017"</span>);</div><div class="line">            SimpleDateFormat sdf = </div><div class="line"><span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMddHHmmss"</span>);</div><div class="line">            <span class="keyword">long</span> time = sdf.parse(date).getTime();</div><div class="line">            rowkey = phoneNum + (Long.MAX_VALUE - time);</div><div class="line">            System.out.println(rowkey);</div><div class="line">                  </div><div class="line">            Put put = <span class="keyword">new</span> Put(rowkey.getBytes());</div><div class="line">            put.add(<span class="string">"cf1"</span>.getBytes(),<span class="string">"type"</span>.getBytes(),</div><div class="line">(random.nextInt(<span class="number">2</span>)+<span class="string">""</span>).getBytes());</div><div class="line">            put.add(<span class="string">"cf1"</span>.getBytes(),<span class="string">"time"</span>.getBytes(),</div><div class="line">(date).getBytes());</div><div class="line">            put.add(<span class="string">"cf1"</span>.getBytes(),<span class="string">"oppoPhoneNum"</span>.getBytes(),</div><div class="line">getPhoneNum(<span class="string">"137"</span>).getBytes());</div><div class="line">                  </div><div class="line">            puts.add(put);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">         </div><div class="line">    hTable.put(puts);</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> Random random = <span class="keyword">new</span> Random();</div><div class="line">     </div><div class="line"><span class="comment">/**</span></div><div class="line"> * 随机生成手机号</div><div class="line"> * <span class="doctag">@param</span> prefix 手机号前三位</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPhoneNum</span><span class="params">(String prefix)</span> </span>&#123;</div><div class="line"><span class="comment">//生成的数字如果不够8位，用0补充</span></div><div class="line">    <span class="keyword">return</span> prefix + String.format(<span class="string">"%08d"</span>, random.nextInt(<span class="number">99999999</span>));</div><div class="line">&#125;</div><div class="line">     </div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 随机生成时间</div><div class="line"> * <span class="doctag">@param</span> year 年</div><div class="line"> * <span class="doctag">@return</span> 时间  格式：yyyyMMddHHmmss</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getDate</span><span class="params">(String year)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> year + String.format(<span class="string">"%02d%02d%02d%02d%02d"</span>,</div><div class="line">        <span class="keyword">new</span> Object[] &#123;random.nextInt(<span class="number">12</span>)+<span class="number">1</span>,random.nextInt(<span class="number">29</span>)+<span class="number">1</span>,</div><div class="line">                      random.nextInt(<span class="number">24</span>),random.nextInt(<span class="number">60</span>),</div><div class="line">                       random.nextInt(<span class="number">60</span>)&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="查询某个手机号某个月的通话记录："><a href="#查询某个手机号某个月的通话记录：" class="headerlink" title="查询某个手机号某个月的通话记录："></a>查询某个手机号某个月的通话记录：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 手机号：18698423056</div><div class="line"> * 时间：2017年1月</div><div class="line"> */</div><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanDB</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Scan scan = <span class="keyword">new</span> Scan();</div><div class="line">    SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMddHHmmss"</span>);</div><div class="line">String startRowKey = <span class="string">"18698423056"</span> + </div><div class="line">(Long.MAX_VALUE - sdf.parse(<span class="string">"20170201000000"</span>).getTime());</div><div class="line">String stopRowKey = <span class="string">"18698423056"</span> + </div><div class="line">(Long.MAX_VALUE - sdf.parse(<span class="string">"20170101000000"</span>).getTime());</div><div class="line">         </div><div class="line">    scan.setStartRow(startRowKey.getBytes());</div><div class="line">    scan.setStopRow(stopRowKey.getBytes());</div><div class="line">         </div><div class="line">    ResultScanner rss = hTable.getScanner(scan);</div><div class="line">    <span class="keyword">for</span>(Result rs : rss)&#123;</div><div class="line">        Cell cell1 = rs.getColumnLatestCell(</div><div class="line">            <span class="string">"cf1"</span>.getBytes(), <span class="string">"type"</span>.getBytes());</div><div class="line">Cell cell2 = rs.getColumnLatestCell(</div><div class="line">            <span class="string">"cf1"</span>.getBytes(), <span class="string">"time"</span>.getBytes());</div><div class="line">Cell cell3 = rs.getColumnLatestCell(</div><div class="line">            <span class="string">"cf1"</span>.getBytes(), <span class="string">"oppoPhoneNum"</span>.getBytes());</div><div class="line">System.out.println(</div><div class="line">            <span class="keyword">new</span> String(CellUtil.cloneValue(cell1)) + <span class="string">"-"</span> +</div><div class="line">            <span class="keyword">new</span> String(CellUtil.cloneValue(cell2)) + <span class="string">"-"</span> +</div><div class="line">            <span class="keyword">new</span> String(CellUtil.cloneValue(cell3))</div><div class="line">);</div><div class="line">    &#125;       </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="查询某个手机号所有的主叫-type-0-的通话记录："><a href="#查询某个手机号所有的主叫-type-0-的通话记录：" class="headerlink" title="查询某个手机号所有的主叫(type=0)的通话记录："></a>查询某个手机号所有的主叫(type=0)的通话记录：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 手机号：18696384891</div><div class="line"> */</div><div class="line"> <span class="meta">@Test</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanDB2</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">     FilterList list = </div><div class="line"><span class="keyword">new</span> FilterList(FilterList.Operator.MUST_PASS_ALL);</div><div class="line">         </div><div class="line">     PrefixFilter filter1 = </div><div class="line"><span class="keyword">new</span> PrefixFilter(<span class="string">"18696384891"</span>.getBytes());</div><div class="line">          </div><div class="line">     SingleColumnValueFilter filter2 = </div><div class="line"><span class="keyword">new</span> SingleColumnValueFilter(</div><div class="line"><span class="string">"cf1"</span>.getBytes(), <span class="string">"type"</span>.getBytes(),</div><div class="line">                      CompareOp.EQUAL, <span class="string">"0"</span>.getBytes());</div><div class="line">         </div><div class="line">     list.addFilter(filter1);</div><div class="line">     list.addFilter(filter2);</div><div class="line">         </div><div class="line">     Scan scan = <span class="keyword">new</span> Scan();</div><div class="line">     scan.setFilter(list);</div><div class="line">         </div><div class="line">     ResultScanner rss = hTable.getScanner(scan);</div><div class="line">     <span class="keyword">for</span> (Result rs : rss) &#123;</div><div class="line">         Cell cell1 = rs.getColumnLatestCell(</div><div class="line"><span class="string">"cf1"</span>.getBytes(), <span class="string">"type"</span>.getBytes());</div><div class="line">         Cell cell2 = rs.getColumnLatestCell(</div><div class="line"><span class="string">"cf1"</span>.getBytes(), <span class="string">"time"</span>.getBytes());</div><div class="line">         Cell cell3 = rs.getColumnLatestCell(</div><div class="line"><span class="string">"cf1"</span>.getBytes(), <span class="string">"oppoPhoneNum"</span>.getBytes());</div><div class="line">         System.out.println(</div><div class="line">             <span class="keyword">new</span> String(CellUtil.cloneValue(cell1)) + <span class="string">"-"</span> +</div><div class="line">             <span class="keyword">new</span> String(CellUtil.cloneValue(cell2)) + <span class="string">"-"</span> +</div><div class="line">             <span class="keyword">new</span> String(CellUtil.cloneValue(cell3))</div><div class="line">         );</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="设计表"><a href="#设计表" class="headerlink" title="设计表"></a>设计表</h3><h4 id="人员-角色"><a href="#人员-角色" class="headerlink" title="人员-角色"></a>人员-角色</h4><p>人员有多个角色，角色考虑优先级，角色有多个人员<br>人员可以添加删除角色<br>角色可以添加删除人员<br>人员和角色可以添加删除<br><img src="/media/15049408045777.jpg" alt=""></p>
<h4 id="组织架构组：部门-子部门"><a href="#组织架构组：部门-子部门" class="headerlink" title="组织架构组：部门-子部门"></a>组织架构组：部门-子部门</h4><p><img src="/media/15049408398775.jpg" alt=""></p>
<h4 id="微博表设计"><a href="#微博表设计" class="headerlink" title="微博表设计"></a>微博表设计</h4><p>关注列表：添加、取消<br>粉丝列表<br>查看首页：所有关注过的好友微博，时间降序排序<br>查看某个用户的微博，时间降序排序<br>发布微博<br><img src="/media/15049409080848.jpg" alt=""><br><img src="/media/15049409225534.jpg" alt=""><br><img src="/media/15049409408141.jpg" alt=""></p>
<h3 id="Protobuf"><a href="#Protobuf" class="headerlink" title="Protobuf"></a>Protobuf</h3><p>Protocol Buffers是一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化。它很适合做数据存储或 RPC 数据交换格式。可用于通讯协议、数据存储等领域的语言无关、平台无关、可扩展的序列化结构数据格式。目前提供了 C++、Java、Python 三种语言的 API。</p>
<h4 id="安装protobuf（node05）"><a href="#安装protobuf（node05）" class="headerlink" title="安装protobuf（node05）"></a>安装protobuf（node05）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@node05 sxt]# tar zxvf protobuf-2.5.0.tar.gz</div><div class="line"># 安装一些常用软件需要依赖的包</div><div class="line">[root@node05 protobuf-2.5.0]# yum groupinstall Development tools -y</div><div class="line">[root@node05 protobuf-2.5.0]# ./configure --prefix=/opt/sxt/protobuf</div><div class="line">[root@node05 protobuf-2.5.0]# make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h4 id="对通话记录案例中的列和行进行整合优化"><a href="#对通话记录案例中的列和行进行整合优化" class="headerlink" title="对通话记录案例中的列和行进行整合优化"></a>对通话记录案例中的列和行进行整合优化</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[root@node05 ~]# vi call.proto</div><div class="line">package com.sxt.hbase;</div><div class="line">#通话记录详情</div><div class="line">message Record &#123;</div><div class="line">    required string type = 1;</div><div class="line">    required string time = 2;</div><div class="line">    required string oppoPhoneNum = 3;</div><div class="line">&#125;</div><div class="line">#一天的通话记录</div><div class="line">message RecordList &#123;</div><div class="line">    repeated Record rlist = 1;</div><div class="line">&#125; </div><div class="line">[root@node05 ~]# /opt/sxt/protobuf/bin/protoc --java_out=./ call.proto</div><div class="line">[root@node05 ~]# ls</div><div class="line">anaconda-ks.cfg  call.proto  com  install.log  install.log.syslog</div><div class="line">[root@node05 ~]# cd com</div><div class="line">[root@node05 com]# ls</div><div class="line">sxt</div><div class="line">[root@node05 com]# cd sxt</div><div class="line">[root@node05 sxt]# ls</div><div class="line">hbase</div><div class="line">[root@node05 sxt]# cd hbase</div><div class="line">[root@node05 hbase]# ls</div><div class="line">Call.java</div><div class="line"># Call.java是对call.proto的封装</div></pre></td></tr></table></figure>
<p>把Call.java放到查询通话记录的项目中，Call.java对列和行分别进行了封装<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 随机生成时间</div><div class="line"> * <span class="doctag">@param</span> time yyyyMMdd</div><div class="line"> * <span class="doctag">@return</span> 时间  格式：yyyyMMddHHmmss</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getDate2</span><span class="params">(String time)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> time + String.format(<span class="string">"%02d%02d%02d"</span>,</div><div class="line">                                <span class="keyword">new</span> Object[] &#123;</div><div class="line">                                    random.nextInt(<span class="number">24</span>),</div><div class="line">                                    random.nextInt(<span class="number">60</span>),</div><div class="line">                                    random.nextInt(<span class="number">60</span>)</div><div class="line">                                &#125;);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * 插入10个手机号，每个手机号一天产生100条通话记录</div><div class="line"> * 一天当中所有的通话记录封装到一起</div><div class="line"> * 时间按降序排列</div><div class="line"> */</div><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertDB2</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">         </div><div class="line">    List&lt;Put&gt; puts = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">         </div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;</div><div class="line">        String rowkey;</div><div class="line">        String phoneNum = getPhoneNum(<span class="string">"186"</span>);</div><div class="line">        String date = <span class="string">"20170714000000"</span>;</div><div class="line">        SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMddHHmmss"</span>);</div><div class="line">        rowkey = phoneNum + <span class="string">"_"</span> + </div><div class="line">(Long.MAX_VALUE-(sdf.parse(date).getTime()));</div><div class="line">              </div><div class="line">        Call.RecordList.Builder recordList = Call.RecordList.newBuilder();</div><div class="line">              </div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;<span class="number">100</span>; j++)&#123;</div><div class="line">            String dnum = getPhoneNum(<span class="string">"138"</span>);</div><div class="line">            String dateStr = getDate2(<span class="string">"20170714"</span>);</div><div class="line">            String type = random.nextInt(<span class="number">2</span>) + <span class="string">""</span>;</div><div class="line">                  </div><div class="line">            Call.Record.Builder record = Call.Record.newBuilder();</div><div class="line">            record.setType(type);</div><div class="line">            record.setTime(dateStr);</div><div class="line">            record.setOppoPhoneNum(dnum);</div><div class="line">                  </div><div class="line">            recordList.addRlist(record);</div><div class="line">        &#125;</div><div class="line">              </div><div class="line">        Put put = <span class="keyword">new</span> Put(rowkey.getBytes());</div><div class="line">        <span class="comment">//这一个手机号一天的记录放到cf1中，名称为records，可以任意命名</span></div><div class="line">        put.add(<span class="string">"cf1"</span>.getBytes(), <span class="string">"records"</span>.getBytes(), recordList.build().toByteArray());</div><div class="line">         puts.add(put);</div><div class="line">    &#125;</div><div class="line">         </div><div class="line">    hTable.put(puts);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * 查询某个手机号1天的通话记录</div><div class="line"> * <span class="doctag">@throws</span> Exception</div><div class="line"> */</div><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getDB2</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    String rowkey = <span class="string">"186970848059223370536893175807"</span>;</div><div class="line">    Get get = <span class="keyword">new</span> Get(rowkey.getBytes());</div><div class="line">         </div><div class="line">    get.addColumn(<span class="string">"cf1"</span>.getBytes(), <span class="string">"records"</span>.getBytes());</div><div class="line">         </div><div class="line">    Result rs = hTable.get(get);</div><div class="line">    Cell cell = rs.getColumnLatestCell(<span class="string">"cf1"</span>.getBytes(),     </div><div class="line">        <span class="string">"records"</span>.getBytes());</div><div class="line">         </div><div class="line">    Call.RecordList recordList = Call.RecordList.parseFrom(</div><div class="line">        CellUtil.cloneValue(cell));</div><div class="line">         </div><div class="line">    <span class="keyword">for</span>(Call.Record record : recordList.getRlistList()) &#123;</div><div class="line">              System.out.println(record.getType() + <span class="string">" - "</span> + </div><div class="line">                  record.getTime() + <span class="string">" - "</span> + </div><div class="line">                  record.getOppoPhoneNum());</div><div class="line">    &#125;</div><div class="line">         </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="HBase优化"><a href="#HBase优化" class="headerlink" title="HBase优化"></a>HBase优化</h3><h4 id="设计表的优化"><a href="#设计表的优化" class="headerlink" title="设计表的优化"></a>设计表的优化</h4><h5 id="1-Pre-Creating-Regions（预分区）"><a href="#1-Pre-Creating-Regions（预分区）" class="headerlink" title="1.Pre-Creating Regions（预分区）"></a>1.Pre-Creating Regions（预分区）</h5><p>默认情况下，在创建HBase表的时候会自动创建一个region分区，当导入数据的时候，所有的HBase客户端都向这一个region写数据，直到这个region足够大了才进行切分。一种可以加快批量写入速度的方法是通过预先创建一些空的regions，这样当数据写入HBase时，会按照region分区情况，在集群内做数据的负载均衡。</p>
<p>例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">createTable</span><span class="params">(HBaseAdmin admin, </span></span></div><div class="line">    HTableDescriptor table, <span class="keyword">byte</span>[][] splits) </div><div class="line">    <span class="keyword">throws</span> IOException &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        admin.createTable(table, splits);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (TableExistsException e) &#123;</div><div class="line">        logger.info(<span class="string">"table "</span> + table.getNameAsString() + </div><div class="line"><span class="string">" already exists"</span>);</div><div class="line">        <span class="comment">// the table already exists...</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * 当rowkey是数字类型时，使用以下规则分区</div><div class="line"> * start:001</div><div class="line"> * endkey:100</div><div class="line"> * region:10个，[001,010][011,020]...</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[][] getHexSplits(String startKey, String endKey, <span class="keyword">int</span> numRegions) &#123;</div><div class="line">    <span class="keyword">byte</span>[][] splits = <span class="keyword">new</span> <span class="keyword">byte</span>[numRegions-<span class="number">1</span>][];</div><div class="line">    BigInteger lowestKey = <span class="keyword">new</span> BigInteger(startKey, <span class="number">16</span>);</div><div class="line">    BigInteger highestKey = <span class="keyword">new</span> BigInteger(endKey, <span class="number">16</span>);</div><div class="line">    BigInteger range = highestKey.subtract(lowestKey);</div><div class="line">    BigInteger regionIncrement = range.divide(BigInteger.valueOf(numRegions));</div><div class="line">    lowestKey = lowestKey.add(regionIncrement);</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; numRegions-<span class="number">1</span>;i++) &#123;</div><div class="line">     BigInteger key = lowestKey.add(regionIncrement.multiply(BigInteger.valueOf(i)));</div><div class="line">     <span class="keyword">byte</span>[] b = String.format(<span class="string">"%016x"</span>, key).getBytes();</div><div class="line">     splits[i] = b;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> splits;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="2-rowkey的设计"><a href="#2-rowkey的设计" class="headerlink" title="2.rowkey的设计"></a>2.rowkey的设计</h5><p>HBase中row key用来检索表中的记录，支持以下三种方式：<br>•    通过单个row key访问：即按照某个row key键值进行get操作；<br>•    通过row key的range进行scan：即通过设置startRowKey和endRowKey，在这个范围内进行扫描；<br>•    全表扫描：即直接扫描整张表中所有行记录。<br>在HBase中，row key可以是任意字符串，最大长度64KB，实际应用中一般为10~100 bytes，存为byte[]字节数组，一般设计成定长的。<br>row key是按照字典序存储，因此，设计row key时，要充分利用这个排序特点，将经常一起读取的数据存储到一块，将最近可能会被访问的数据放在一块。<br>举个例子：如果最近写入HBase表中的数据是最可能被访问的，可以考虑将时间戳作为row key的一部分，由于是字典序排序，所以可以使用Long.MAX_VALUE - timestamp作为row key，这样能保证新写入的数据在读取时可以被快速命中。<br>Rowkey规则：<br>1)    越小越好<br>2)    Rowkey的设计是要根据实际业务来<br>3)    散列性<br>a)    取反   001  002 ：100    200 取反后，rowkey可能落在不同的region上<br>b)    Hash   rowkey取hash值后，可能会均匀分布在不同的region上<br>散列的弊端：降低了范围查找的效率</p>
<h5 id="3-Column-Family"><a href="#3-Column-Family" class="headerlink" title="3.Column Family"></a>3.Column Family</h5><p>不要在一张表里定义太多的column family。目前Hbase并不能很好的处理超过2~3个column family的表。因为某个column family在flush的时候，它邻近的column family也会因关联效应被触发flush，最终导致系统产生更多的I/O。</p>
<h5 id="4-In-Memory"><a href="#4-In-Memory" class="headerlink" title="4.In Memory"></a>4.In Memory</h5><p>创建表的时候，可以通过HColumnDescriptor.setInMemory(true)将表放到RegionServer的缓存中，保证在读取的时候被cache命中。</p>
<h5 id="5-Max-Version"><a href="#5-Max-Version" class="headerlink" title="5.Max Version"></a>5.Max Version</h5><p>创建表的时候，可以通过HColumnDescriptor.setMaxVersions(int maxVersions)设置表中数据的最大版本，如果只需要保存最新版本的数据，那么可以设置setMaxVersions(1)。</p>
<h5 id="6-Time-To-Live"><a href="#6-Time-To-Live" class="headerlink" title="6.Time To Live"></a>6.Time To Live</h5><p>创建表的时候，可以通过HColumnDescriptor.setTimeToLive(int timeToLive)设置表中数据的存储生命期，过期数据将自动被删除，例如如果只需要存储最近两天的数据，那么可以设置setTimeToLive(2 <em> 24 </em> 60 * 60)。</p>
<h5 id="7-Compact-amp-Split"><a href="#7-Compact-amp-Split" class="headerlink" title="7.Compact &amp; Split"></a>7.Compact &amp; Split</h5><p>在HBase中，数据在更新时首先写入WAL 日志(HLog)和内存(MemStore)中，MemStore中的数据是排序的，当MemStore累计到一定阈值时，就会创建一个新的MemStore，并且将老的MemStore添加到flush队列，由单独的线程flush到磁盘上，成为一个StoreFile。于此同时，系统会在zookeeper中记录一个redo point，表示这个时刻之前的变更已经持久化了(minor compact)。<br>StoreFile是只读的，一旦创建后就不可以再修改。因此Hbase的更新其实是不断追加的操作。当一个Store中的StoreFile达到一定的阈值后，就会进行一次合并(major compact)，将对同一个key的修改合并到一起，形成一个大的StoreFile，当StoreFile的大小达到一定阈值后，又会对 StoreFile进行分割(split)，等分为两个StoreFile。<br>由于对表的更新是不断追加的，处理读请求时，需要访问Store中全部的StoreFile和MemStore，将它们按照row key进行合并，由于StoreFile和MemStore都是经过排序的，并且StoreFile带有内存中索引，通常合并过程还是比较快的。<br>实际应用中，可以考虑必要时手动进行major compact，将同一个row key的修改进行合并形成一个大的StoreFile。同时，可以将StoreFile设置大些，减少split的发生。<br>hbase为了防止小文件（被刷到磁盘的menstore）过多，以保证保证查询效率，hbase需要在必要的时候将这些小的store file合并成相对较大的store file，这个过程就称之为compaction。在hbase中，主要存在两种类型的compaction：minor  compaction和major compaction。<br>minor compaction是较小、很少文件的合并。<br>major compaction是将所有的store file合并成一个，触发major compaction的可能条件有：major_compact 命令、majorCompact() API、region server自动运行（相关参数：hbase.hregion.majoucompaction 默认为24 小时、hbase.hregion.majorcompaction.jetter 默认值为0.2 ，作用是防止region server在同一时间进行major compaction）。<br>hbase.hregion.majorcompaction.jetter参数的作用是：<br>对参数hbase.hregion.majoucompaction 规定的值起到浮动的作用，假如两个参数都为默认值24和0.2，那么major compact最终使用的数值为：19.2~28.8 这个范围。<br>关闭自动major compaction，使用手动方式。<br>手动编程major compaction：Timer类（java），contab（shell）</p>
<p>minor compaction的运行机制要复杂一些，它由一下几个参数共同决定：<br>hbase.hstore.compaction.min<br>默认值为 3，表示至少需要三个满足条件的store file时，minor compaction才会启动<br>hbase.hstore.compaction.max<br>默认值为10，表示一次minor compaction中最多选取10个store file<br>hbase.hstore.compaction.min.size<br>表示文件大小小于该值的store file 一定会加入到minor compaction的store file中<br>hbase.hstore.compaction.max.size<br>表示文件大小大于该值的store file一定会被minor compaction排除<br>hbase.hstore.compaction.ratio<br>将store file 按照文件年龄排序（older to younger），minor compaction总是从older store file开始选择</p>
<h4 id="写表的优化"><a href="#写表的优化" class="headerlink" title="写表的优化"></a>写表的优化</h4><h5 id="1-多HTable并发写"><a href="#1-多HTable并发写" class="headerlink" title="1.多HTable并发写"></a>1.多HTable并发写</h5><p>创建多个HTable客户端用于写操作，提高写数据的吞吐量，一个例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> Configuration conf = HBaseConfiguration.create();</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> String table_log_name = <span class="string">"user_log"</span>;</div><div class="line">wTableLog = <span class="keyword">new</span> HTable[tableN];</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tableN; i++) &#123;</div><div class="line">    wTableLog[i] = <span class="keyword">new</span> HTable(conf, table_log_name);</div><div class="line">    wTableLog[i].setWriteBufferSize(<span class="number">5</span> * <span class="number">1024</span> * <span class="number">1024</span>); <span class="comment">//5MB</span></div><div class="line">    wTableLog[i].setAutoFlush(<span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="2-HTable参数设置"><a href="#2-HTable参数设置" class="headerlink" title="2.HTable参数设置"></a>2.HTable参数设置</h5><h6 id="Auto-Flush"><a href="#Auto-Flush" class="headerlink" title="Auto Flush"></a>Auto Flush</h6><p>通过调用HTable.setAutoFlush(false)方法可以将HTable写客户端的自动flush关闭，这样可以批量写入数据到HBase，而不是有一条put就执行一次更新，只有当put填满客户端写缓存时，才实际向HBase服务端发起写请求。默认情况下auto flush是开启的。</p>
<h6 id="Write-Buffer"><a href="#Write-Buffer" class="headerlink" title="Write Buffer"></a>Write Buffer</h6><p>通过调用HTable.setWriteBufferSize(writeBufferSize)方法可以设置HTable客户端的写buffer大小，如果新设置的buffer小于当前写buffer中的数据时，buffer将会被flush到服务端。其中，writeBufferSize的单位是byte字节数，可以根据实际写入数据量的多少来设置该值。</p>
<h6 id="WAL-Flag"><a href="#WAL-Flag" class="headerlink" title="WAL Flag"></a>WAL Flag</h6><p>在HBae中，客户端向集群中的RegionServer提交数据时（Put/Delete操作），首先会先写WAL（Write Ahead Log）日志（即HLog，一个RegionServer上的所有Region共享一个HLog），只有当WAL日志写成功后，再接着写MemStore，然后客户端被通知提交数据成功；如果写WAL日志失败，客户端则被通知提交失败。这样做的好处是可以做到RegionServer宕机后的数据恢复。<br>因此，对于相对不太重要的数据，可以在Put/Delete操作时，通过调用Put.setWriteToWAL(false)或Delete.setWriteToWAL(false)函数，放弃写WAL日志，从而提高数据写入的性能。<br>值得注意的是：谨慎选择关闭WAL日志，因为这样的话，一旦RegionServer宕机，Put/Delete的数据将会无法根据WAL日志进行恢复。</p>
<h5 id="3-批量写"><a href="#3-批量写" class="headerlink" title="3.批量写"></a>3.批量写</h5><p>通过调用HTable.put(Put)方法可以将一个指定的row key记录写入HBase，同样HBase提供了另一个方法：通过调用HTable.put(List<put>)方法可以将指定的row key列表，批量写入多行记录，这样做的好处是批量执行，只需要一次网络I/O开销，这对于对数据实时性要求高，网络传输RTT高的情景下可能带来明显的性能提升。</put></p>
<h5 id="4-多线程并发写"><a href="#4-多线程并发写" class="headerlink" title="4.多线程并发写"></a>4.多线程并发写</h5><p>在客户端开启多个HTable写线程，每个写线程负责一个HTable对象的flush操作，这样结合定时flush和写buffer（writeBufferSize），可以既保证在数据量小的时候，数据可以在较短时间内被flush（如1秒内），同时又保证在数据量大的时候，写buffer一满就及时进行flush。下面给个具体的例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threadN; i++) &#123;</div><div class="line">    Thread th = <span class="keyword">new</span> Thread() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    sleep(<span class="number">1000</span>); <span class="comment">//1 second</span></div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">synchronized</span> (wTableLog[i]) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        wTableLog[i].flushCommits();</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    th.setDaemon(<span class="keyword">true</span>);</div><div class="line">    th.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="读表的优化"><a href="#读表的优化" class="headerlink" title="读表的优化"></a>读表的优化</h4><h5 id="1-多个HTable并发读"><a href="#1-多个HTable并发读" class="headerlink" title="1.    多个HTable并发读"></a>1.    多个HTable并发读</h5><p>创建多个HTable客户端用于读操作，提高读数据的吞吐量，一个例子：<br>static final Configuration conf = HBaseConfiguration.create();<br>static final String table_log_name = “user_log”;<br>rTableLog = new HTable[tableN];<br>for (int i = 0; i &lt; tableN; i++) {<br>    rTableLog[i] = new HTable(conf, table_log_name);<br>    rTableLog[i].setScannerCaching(50);<br>}</p>
<h5 id="2-HTable参数设置-1"><a href="#2-HTable参数设置-1" class="headerlink" title="2.HTable参数设置"></a>2.HTable参数设置</h5><h6 id="Scanner-Caching"><a href="#Scanner-Caching" class="headerlink" title="Scanner Caching"></a>Scanner Caching</h6><p>hbase.client.scanner.caching配置项可以设置HBase scanner一次从服务端抓取的数据条数，默认情况下一次一条。通过将其设置成一个合理的值，可以减少scan过程中next()的时间开销，代价是scanner需要通过客户端的内存来维持这些被cache的行记录。<br>有三个地方可以进行配置：<br>a)    在HBase的conf配置文件中进行配置；<br>b)    通过调用HTable.setScannerCaching(int scannerCaching)进行配置；<br>c)    通过调用Scan.setCaching(int caching)进行配置。<br>三者的优先级越来越高。</p>
<h6 id="Scan-Attribute-Selection"><a href="#Scan-Attribute-Selection" class="headerlink" title="Scan Attribute Selection"></a>Scan Attribute Selection</h6><p>scan时指定需要的Column Family，可以减少网络传输数据量，否则默认scan操作会返回整行所有Column Family的数据。</p>
<h6 id="Close-ResultScanner"><a href="#Close-ResultScanner" class="headerlink" title="Close ResultScanner"></a>Close ResultScanner</h6><p>通过scan取完数据后，记得要关闭ResultScanner，否则RegionServer可能会出现问题（对应的Server资源无法释放）。</p>
<h5 id="3-批量读"><a href="#3-批量读" class="headerlink" title="3.批量读"></a>3.批量读</h5><p>通过调用HTable.get(Get)方法可以根据一个指定的row key获取一行记录，同样HBase提供了另一个方法：通过调用HTable.get(List<get>)方法可以根据一个指定的row key列表，批量获取多行记录，这样做的好处是批量执行，只需要一次网络I/O开销，这对于对数据实时性要求高而且网络传输RTT高的情景下可能带来明显的性能提升。</get></p>
<h5 id="4-多线程并发读"><a href="#4-多线程并发读" class="headerlink" title="4.多线程并发读"></a>4.多线程并发读</h5><p>在客户端开启多个HTable读线程，每个读线程负责通过HTable对象进行get操作。下面是一个多线程并发读取HBase，获取店铺一天内各分钟PV值的例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataReaderServer</span> </span>&#123;</div><div class="line">     <span class="comment">// 获取店铺一天内各分钟PV值的入口函数</span></div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, String&gt; </span></div><div class="line">         <span class="title">getUnitMinutePV</span><span class="params">(<span class="keyword">long</span> uid, <span class="keyword">long</span> startStamp, <span class="keyword">long</span> endStamp)</span> &#123;</div><div class="line">         <span class="keyword">long</span> min = startStamp;</div><div class="line">         <span class="keyword">int</span> count = (<span class="keyword">int</span>) ((endStamp - startStamp) / (<span class="number">60</span> * <span class="number">1000</span>));</div><div class="line">         List&lt;String&gt; lst = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= count; i++) &#123;</div><div class="line">              min = startStamp + i * <span class="number">60</span> * <span class="number">1000</span>;</div><div class="line">              lst.add(uid + <span class="string">"_"</span> + min);</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">return</span> parallelBatchMinutePV(lst);</div><div class="line">     &#125;</div><div class="line">     <span class="comment">// 多线程并发查询，获取分钟PV值</span></div><div class="line">     <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, String&gt; </span></div><div class="line">         <span class="title">parallelBatchMinutePV</span><span class="params">(List&lt;String&gt; lstKeys)</span> &#123;</div><div class="line">         ConcurrentHashMap&lt;String, String&gt; hashRet = </div><div class="line">             <span class="keyword">new</span> ConcurrentHashMap&lt;String, String&gt;();</div><div class="line">         <span class="keyword">int</span> parallel = <span class="number">3</span>;</div><div class="line">         List&lt;List&lt;String&gt;&gt; lstBatchKeys = <span class="keyword">null</span>;</div><div class="line">         <span class="keyword">if</span> (lstKeys.size() &lt; parallel) &#123;</div><div class="line">              lstBatchKeys = <span class="keyword">new</span> ArrayList&lt;List&lt;String&gt;&gt;(<span class="number">1</span>);</div><div class="line">              lstBatchKeys.add(lstKeys);</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">              lstBatchKeys = <span class="keyword">new</span> ArrayList&lt;List&lt;String&gt;&gt;(parallel);</div><div class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parallel; i++) &#123;</div><div class="line">                  List&lt;String&gt; lst = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">                  lstBatchKeys.add(lst);</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; lstKeys.size(); i++) &#123;</div><div class="line">                  lstBatchKeys.get(i % parallel).add(lstKeys.get(i));</div><div class="line">              &#125;</div><div class="line">         &#125;</div><div class="line">         List&lt;Future&lt;ConcurrentHashMap&lt;String, String&gt;&gt;&gt; futures = </div><div class="line">             <span class="keyword">new</span> ArrayList&lt;Future&lt;ConcurrentHashMap&lt;String, </div><div class="line">String&gt;&gt;&gt;(<span class="number">5</span>);</div><div class="line">         ThreadFactoryBuilder builder = <span class="keyword">new</span> ThreadFactoryBuilder();</div><div class="line">         builder.setNameFormat(<span class="string">"ParallelBatchQuery"</span>);</div><div class="line">         ThreadFactory factory = builder.build();</div><div class="line">         ThreadPoolExecutor executor = </div><div class="line">             (ThreadPoolExecutor) Executors.</div><div class="line">                 newFixedThreadPool(lstBatchKeys.size(), factory);</div><div class="line">         <span class="keyword">for</span> (List&lt;String&gt; keys : lstBatchKeys) &#123;</div><div class="line">              Callable&lt;ConcurrentHashMap&lt;String, String&gt;&gt; callable = </div><div class="line">                  <span class="keyword">new</span> BatchMinutePVCallable(keys);</div><div class="line">              FutureTask&lt;ConcurrentHashMap&lt;String, String&gt;&gt; future = </div><div class="line">                  (FutureTask&lt;ConcurrentHashMap&lt;String, String&gt;&gt;)</div><div class="line">executor.submit(callable);</div><div class="line">              futures.add(future);</div><div class="line">         &#125;</div><div class="line">         executor.shutdown();</div><div class="line">         <span class="comment">// Wait for all the tasks to finish</span></div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">              <span class="keyword">boolean</span> stillRunning = </div><div class="line">!executor.awaitTermination(</div><div class="line"><span class="number">5000000</span>, TimeUnit.MILLISECONDS);</div><div class="line">              <span class="keyword">if</span> (stillRunning) &#123;</div><div class="line">                  <span class="keyword">try</span> &#123;</div><div class="line">                       executor.shutdownNow();</div><div class="line">                  &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                       e.printStackTrace();</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">         &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  Thread.currentThread().interrupt();</div><div class="line">              &#125; <span class="keyword">catch</span> (Exception e1) &#123;</div><div class="line">                  <span class="comment">// TODO Auto-generated catch block</span></div><div class="line">                  e1.printStackTrace();</div><div class="line">              &#125;</div><div class="line">         &#125;</div><div class="line">         <span class="comment">// Look for any exception</span></div><div class="line">         <span class="keyword">for</span> (Future f : futures) &#123;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  <span class="keyword">if</span> (f.get() != <span class="keyword">null</span>) &#123;</div><div class="line">                       hashRet.putAll(</div><div class="line">(ConcurrentHashMap&lt;String, String&gt;) f.get());</div><div class="line">                  &#125;</div><div class="line">              &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                  <span class="keyword">try</span> &#123;</div><div class="line">                       Thread.currentThread().interrupt();</div><div class="line">                  &#125; <span class="keyword">catch</span> (Exception e1) &#123;</div><div class="line">                       e1.printStackTrace();</div><div class="line">                  &#125;</div><div class="line">              &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">                  e.printStackTrace();</div><div class="line">              &#125;</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">return</span> hashRet;</div><div class="line">     &#125;</div><div class="line">     <span class="comment">// 一个线程批量查询，获取分钟PV值</span></div><div class="line">     <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, String&gt; </span></div><div class="line">         <span class="title">getBatchMinutePV</span><span class="params">(List&lt;String&gt; lstKeys)</span> &#123;</div><div class="line">         ConcurrentHashMap&lt;String, String&gt; hashRet = <span class="keyword">null</span>;</div><div class="line">         List&lt;Get&gt; lstGet = <span class="keyword">new</span> ArrayList&lt;Get&gt;();</div><div class="line">         String[] splitValue = <span class="keyword">null</span>;</div><div class="line">         <span class="keyword">for</span> (String s : lstKeys) &#123;</div><div class="line">              splitValue = s.split(<span class="string">"_"</span>);</div><div class="line">              <span class="keyword">long</span> uid = Long.parseLong(splitValue[<span class="number">0</span>]);</div><div class="line">              <span class="keyword">long</span> min = Long.parseLong(splitValue[<span class="number">1</span>]);</div><div class="line">              <span class="keyword">byte</span>[] key = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">16</span>];</div><div class="line">              Bytes.putLong(key, <span class="number">0</span>, uid);</div><div class="line">              Bytes.putLong(key, <span class="number">8</span>, min);</div><div class="line">              Get g = <span class="keyword">new</span> Get(key);</div><div class="line">              g.addFamily(fp);</div><div class="line">              lstGet.add(g);</div><div class="line">         &#125;</div><div class="line">         Result[] res = <span class="keyword">null</span>;</div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">              res = tableMinutePV[rand.nextInt(tableN)].get(lstGet);</div><div class="line">         &#125; <span class="keyword">catch</span> (IOException e1) &#123;</div><div class="line">              logger.error(<span class="string">"tableMinutePV exception, e="</span> + e1.getStackTrace());</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">if</span> (res != <span class="keyword">null</span> &amp;&amp; res.length &gt; <span class="number">0</span>) &#123;</div><div class="line">              hashRet = <span class="keyword">new</span> ConcurrentHashMap&lt;String, String&gt;(res.length);</div><div class="line">              <span class="keyword">for</span> (Result re : res) &#123;</div><div class="line">                  <span class="keyword">if</span> (re != <span class="keyword">null</span> &amp;&amp; !re.isEmpty()) &#123;</div><div class="line">                       <span class="keyword">try</span> &#123;</div><div class="line">                            <span class="keyword">byte</span>[] key = re.getRow();</div><div class="line">                            <span class="keyword">byte</span>[] value = re.getValue(fp, cp);</div><div class="line">                            <span class="keyword">if</span> (key != <span class="keyword">null</span> &amp;&amp; value != <span class="keyword">null</span>) &#123;</div><div class="line">                                 hashRet.put(</div><div class="line">                                     String.valueOf(</div><div class="line">                                         Bytes.toLong(key, Bytes.SIZEOF_LONG)),</div><div class="line">                                      String.valueOf(Bytes.toLong(</div><div class="line">value)));</div><div class="line">                            &#125;</div><div class="line">                       &#125; <span class="keyword">catch</span> (Exception e2) &#123;</div><div class="line">                            logger.error(e2.getStackTrace());</div><div class="line">                       &#125;</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">return</span> hashRet;</div><div class="line">     &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 调用接口类，实现Callable接口</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BatchMinutePVCallable</span> <span class="keyword">implements</span> </span></div><div class="line">    <span class="title">Callable</span>&lt;<span class="title">ConcurrentHashMap</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt;&gt; &#123;</div><div class="line">     <span class="keyword">private</span> List&lt;String&gt; keys;</div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="title">BatchMinutePVCallable</span><span class="params">(List&lt;String&gt; lstKeys)</span> </span>&#123;</div><div class="line">         <span class="keyword">this</span>.keys = lstKeys;</div><div class="line">     &#125;</div><div class="line">     <span class="function"><span class="keyword">public</span> ConcurrentHashMap&lt;String, String&gt; <span class="title">call</span><span class="params">()</span> </span></div><div class="line">         <span class="keyword">throws</span> Exception &#123;</div><div class="line">         <span class="keyword">return</span> DataReadServer.getBatchMinutePV(keys);</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h6 id="5-缓存查询结果"><a href="#5-缓存查询结果" class="headerlink" title="5.缓存查询结果"></a>5.缓存查询结果</h6><p>对于频繁查询HBase的应用场景，可以考虑在应用程序中做缓存，当有新的查询请求时，首先在缓存中查找，如果存在则直接返回，不再查询HBase；否则对HBase发起读请求查询，然后在应用程序中将查询结果缓存起来。至于缓存的替换策略，可以考虑LRU等常用的策略。</p>
<h6 id="6-Blockcache"><a href="#6-Blockcache" class="headerlink" title="6.Blockcache"></a>6.Blockcache</h6><p>HBase上Regionserver的内存分为两个部分，一部分作为Memstore，主要用来写；另外一部分作为BlockCache，主要用于读。<br>写请求会先写入Memstore，Regionserver会给每个region提供一个Memstore，当Memstore满64MB以后，会启动 flush刷新到磁盘。当Memstore的总大小超过限制时（heapsize <em> hbase.regionserver.global.memstore.upperLimit </em> 0.9），会强行启动flush进程，从最大的Memstore开始flush直到低于限制。<br>读请求先到Memstore中查数据，查不到就到BlockCache中查，再查不到就会到磁盘上读，并把读的结果放入BlockCache。由于BlockCache采用的是LRU策略，因此BlockCache达到上限(heapsize <em> hfile.block.cache.size </em> 0.85)后，会启动淘汰机制，淘汰掉最老的一批数据。<br>一个Regionserver上有一个BlockCache和N个Memstore，它们的大小之和不能大于等于heapsize * 0.8，否则HBase不能启动。默认BlockCache为0.2，而Memstore为0.4。对于注重读响应时间的系统，可以将 BlockCache设大些，比如设置BlockCache=0.4，Memstore=0.39，以加大缓存的命中率。</p>
<h6 id="HTable和HTablePool"><a href="#HTable和HTablePool" class="headerlink" title="HTable和HTablePool"></a>HTable和HTablePool</h6><p>HTable和HTablePool都是HBase客户端API的一部分，可以使用它们对HBase表进行CRUD操作。下面结合在项目中的应用情况，对二者使用过程中的注意事项做一下概括总结。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Configuration conf = HBaseConfiguration.create();</div><div class="line"><span class="keyword">try</span> (Connection connection = ConnectionFactory.createConnection(conf)) &#123;</div><div class="line">     <span class="keyword">try</span> (Table table = connection.getTable(TableName.valueOf(tablename)) &#123;</div><div class="line">          <span class="comment">//use table as needed, the table returned is lightweight</span></div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="HTable"><a href="#HTable" class="headerlink" title="HTable"></a>HTable</h4><p>HTable是HBase客户端与HBase服务端通讯的Java API对象，客户端可以通过HTable对象与服务端进行CRUD操作（增删改查）。它的创建很简单：<br>Configuration conf = HBaseConfiguration.create();<br>HTable table = new HTable(conf, “tablename”);<br>//TODO CRUD Operation……</p>
<p>HTable使用时的一些注意事项：<br>1)    规避HTable对象的创建开销<br>因为客户端创建HTable对象后，需要进行一系列的操作：检查.META.表确认指定名称的HBase表是否存在，表是否有效等等，整个时间开销比较重，可能会耗时几秒钟之长，因此最好在程序启动时一次性创建完成需要的HTable对象，如果使用Java API，一般来说是在构造函数中进行创建，程序启动后直接重用。<br>2)    HTable对象不是线程安全的<br>HTable对象对于客户端读写数据来说不是线程安全的，因此多线程时，要为每个线程单独创建复用一个HTable对象，不同对象间不要共享HTable对象使用，特别是在客户端auto flash被置为false时，由于存在本地write buffer，可能导致数据不一致。<br>3)    HTable对象之间共享Configuration<br>HTable对象共享Configuration对象，这样的好处在于：<br>•    共享ZooKeeper的连接：每个客户端需要与ZooKeeper建立连接，查询用户的table regions位置，这些信息可以在连接建立后缓存起来共享使用；<br>•    共享公共的资源：客户端需要通过ZooKeeper查找-ROOT-和.META.表，这个需要网络传输开销，客户端缓存这些公共资源后能够减少后续的网络传输开销，加快查找过程速度。<br>因此，与以下这种方式相比：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">HTable table1 = <span class="keyword">new</span> HTable(<span class="string">"table1"</span>);</div><div class="line">HTable table2 = <span class="keyword">new</span> HTable(<span class="string">"table2"</span>);</div></pre></td></tr></table></figure></p>
<p>下面的方式更有效些：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Configuration conf = HBaseConfiguration.create();</div><div class="line">HTable table1 = <span class="keyword">new</span> HTable(conf, <span class="string">"table1"</span>);</div><div class="line">HTable table2 = <span class="keyword">new</span> HTable(conf, <span class="string">"table2"</span>);</div></pre></td></tr></table></figure></p>
<p>备注：<br>即使是高负载的多线程程序，也并没有发现因为共享Configuration而导致的性能问题；如果你的实际情况中不是如此，那么可以尝试不共享Configuration。</p>
<h4 id="HTablePool"><a href="#HTablePool" class="headerlink" title="HTablePool"></a>HTablePool</h4><p>HTablePool可以解决HTable存在的线程不安全问题，同时通过维护固定数量的HTable对象，能够在程序运行期间复用这些HTable资源对象。<br>Configuration conf = HBaseConfiguration.create();<br>HTablePool pool = new HTablePool(conf, 10);</p>
<p>1)    HTablePool可以自动创建HTable对象，而且对客户端来说使用上是完全透明的，可以避免多线程间数据并发修改问题。<br>2)    HTablePool中的HTable对象之间是公用Configuration连接的，能够可以减少网络开销。<br>HTablePool的使用很简单：每次进行操作前，通过HTablePool的getTable方法取得一个HTable对象，然后进行put/get/scan/delete等操作，最后通过HTablePool的putTable方法将HTable对象放回到HTablePool中。<br>下面是个使用HTablePool的简单例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createUser</span><span class="params">(String username, String firstName, </span></span></div><div class="line">    String lastName, String email, </div><div class="line">    String password, String roles)</div><div class="line">         <span class="keyword">throws</span> IOException &#123;</div><div class="line">     HTable table = rm.getTable(UserTable.NAME);</div><div class="line">　　 Put put = <span class="keyword">new</span> Put(Bytes.toBytes(username));</div><div class="line">　　 put.add(UserTable.DATA_FAMILY,             </div><div class="line">        UserTable.FIRSTNAME,Bytes.toBytes(firstName));</div><div class="line">　　 put.add(UserTable.DATA_FAMILY, </div><div class="line">        UserTable.LASTNAME,Bytes.toBytes(lastName));</div><div class="line">　　 put.add(UserTable.DATA_FAMILY, UserTable.EMAIL, </div><div class="line">        Bytes.toBytes(email));</div><div class="line">　　 put.add(UserTable.DATA_FAMILY,  </div><div class="line">        UserTable.CREDENTIALS,Bytes.toBytes(password));</div><div class="line">　　 put.add(UserTable.DATA_FAMILY, UserTable.ROLES, </div><div class="line">        Bytes.toBytes(roles));</div><div class="line">　　 table.put(put);</div><div class="line">　　 table.flushCommits();</div><div class="line">　　 rm.putTable(table);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="HBase和关系型数据库的区别"><a href="#HBase和关系型数据库的区别" class="headerlink" title="HBase和关系型数据库的区别"></a>HBase和关系型数据库的区别</h4><p>1.不能使用column之间过滤查询<br>2.不支持全文索引。需要和solr整合完成全文搜索。<br>a)    使用MR批量读取hbase中的数据，在solr里面建立索引（no store）之保存rowkey的值。<br>b)    根据关键词从索引中搜索到rowkey（分页）<br>c)    根据rowkey从hbase查询所有数据</p>
<h3 id="HBase与MapReduce整合"><a href="#HBase与MapReduce整合" class="headerlink" title="HBase与MapReduce整合"></a>HBase与MapReduce整合</h3><p>使用HBase与MapReduce完成wordcount，输出的结果存入HBase的表中</p>
<p>创建表：<br><code>hbase(main):004:0&gt; create &#39;wc&#39;,&#39;cf&#39;</code><br>Job类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WCJob</span> </span>&#123;</div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">         Configuration conf = <span class="keyword">new</span> Configuration();</div><div class="line">         conf.set(<span class="string">"fs.defaultFS"</span>, <span class="string">"hdfs://node01:8020"</span>);</div><div class="line">         <span class="comment">// 指定hbase的zk集群</span></div><div class="line">         <span class="comment">// 如果是伪分布式指定伪分布式那台服务器</span></div><div class="line">         conf.set(<span class="string">"hbase.zookeeper.quorum"</span>, <span class="string">"node02,node03,node04"</span>);</div><div class="line">         <span class="comment">// 在eclipse中直接运行MR程序，加这个配置</span></div><div class="line">         conf.set(<span class="string">"mapreduce.app-submission.cross-platform"</span>, <span class="string">"true"</span>);</div><div class="line">         </div><div class="line">         Job job = Job.getInstance(conf);</div><div class="line">         </div><div class="line">         job.setJobName(<span class="string">"wc job"</span>);</div><div class="line">         </div><div class="line">         job.setJarByClass(WCJob.class);</div><div class="line">         <span class="comment">// 在eclipse中直接运行MR程序，加这个配置，</span></div><div class="line">         <span class="comment">// 把项目打成jar包，并在这里说明jar包存放位置</span></div><div class="line">         job.setJar(<span class="string">"E:\\package\\HBaseWC.jar"</span>);</div><div class="line">         </div><div class="line">         job.setMapperClass(WCMapper.class);</div><div class="line">         job.setMapOutputKeyClass(Text.class);</div><div class="line">         job.setMapOutputValueClass(IntWritable.class);</div><div class="line">         </div><div class="line">         TableMapReduceUtil.initTableReducerJob(</div><div class="line">                  <span class="string">"wc"</span>, <span class="comment">// output table</span></div><div class="line">                  WCReducer.class, <span class="comment">// reducer class</span></div><div class="line">                  job);</div><div class="line">         </div><div class="line">         <span class="comment">// 参数boolean addDependencyJars  </span></div><div class="line"><span class="comment">// 当以本地方式运行MR时 ,必须设置为false</span></div><div class="line">         <span class="comment">/*TableMapReduceUtil.initTableReducerJob(</span></div><div class="line">                  "wc",</div><div class="line">                  WCReducer.class,</div><div class="line">                  job,</div><div class="line">                  null,</div><div class="line">                  null,</div><div class="line">                  null,</div><div class="line">                  null,</div><div class="line">                  false);*/</div><div class="line">          </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 对initTableReducerJob()方法的参数的解析</span></div><div class="line">        </div><div class="line">         </div><div class="line">         Path path = <span class="keyword">new</span> Path(</div><div class="line"><span class="string">"/user/root/wordcount/input/wordcount.txt"</span>);</div><div class="line">         FileInputFormat.addInputPath(job, path);</div><div class="line">         </div><div class="line">         <span class="keyword">if</span>(job.waitForCompletion(<span class="keyword">true</span>)) &#123;</div><div class="line">              System.out.println(<span class="string">"success!"</span>);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Mapper类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WCMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</div><div class="line">     <span class="meta">@Override</span></div><div class="line">     <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span></span></div><div class="line">              <span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">         </div><div class="line">         String[] strs = StringUtils.split(value.toString(), <span class="string">' '</span>);</div><div class="line">         <span class="keyword">for</span> (String s : strs) &#123;</div><div class="line">              context.write(<span class="keyword">new</span> Text(s), <span class="keyword">new</span> IntWritable(<span class="number">1</span>));</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Reducer类"><a href="#Reducer类" class="headerlink" title="Reducer类"></a>Reducer类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">pulic <span class="class"><span class="keyword">class</span> <span class="title">WCReducer</span> <span class="keyword">extends</span></span></div><div class="line">         <span class="title">TableReducer</span>&lt;<span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">ImmutableBytesWritable</span>&gt; &#123;</div><div class="line">     </div><div class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] CF = <span class="string">"cf"</span>.getBytes();</div><div class="line">       <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] COUNT = <span class="string">"count"</span>.getBytes();</div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values, Context context)</span></span></div><div class="line">                <span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">         <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">         <span class="keyword">for</span> (IntWritable val : values) &#123;</div><div class="line">           i += val.get();</div><div class="line">         &#125;</div><div class="line">         Put put = <span class="keyword">new</span> Put(Bytes.toBytes(key.toString()));</div><div class="line">         put.add(CF, COUNT, Bytes.toBytes(i));</div><div class="line">         context.write(<span class="keyword">null</span>, put);</div><div class="line">       &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>查看结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">hbase(main):007:0&gt; scan &apos;wc&apos;</div><div class="line">ROW            COLUMN+CELL                                                                                        </div><div class="line"> C              column=cf:count, timestamp=1500100742828, value=\x00\x00\x00\x04                                   </div><div class="line"> C++            column=cf:count, timestamp=1500100742828, value=\x00\x00\x00\x02                                   </div><div class="line"> Hadoop         column=cf:count, timestamp=1500100742828, value=\x00\x00\x00\x01                                   </div><div class="line"> Java           column=cf:count, timestamp=1500100742828, value=\x00\x00\x00\x04                                   </div><div class="line"> MySQL          column=cf:count, timestamp=1500100742828, value=\x00\x00\x00\x03                                   </div><div class="line"> Oracle         column=cf:count, timestamp=1500100742828, value=\x00\x00\x00\x01                                   </div><div class="line"> Spring         column=cf:count, timestamp=1500100742828, value=\x00\x00\x00\x01</div></pre></td></tr></table></figure></p>
</qualifier></family>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/HBase/" rel="tag"># HBase</a>
          
            <a href="/tags/HBase原理及其搭建/" rel="tag"># HBase原理及其搭建</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/11/08/HADOOP--hadoop运行原理及其搭建/" rel="next" title="HADOOP--hadoop运行原理及其搭建">
                <i class="fa fa-chevron-left"></i> HADOOP--hadoop运行原理及其搭建
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/11/28/ Hive学习笔记/" rel="prev" title="Hive学习笔记">
                Hive学习笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Chant" />
          <p class="site-author-name" itemprop="name">Chant</p>
           
              <p class="site-description motion-element" itemprop="description">Take things as they are with a cavalier attitude./用漫不经心的态度过随遇而安的生活</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Chant00" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/profile.php?id=100014951437344" target="_blank" title="Facebook">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                  Facebook
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/63254896/" target="_blank" title="豆瓣">
                  
                    <i class="fa fa-fw fa-book"></i>
                  
                  豆瓣
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              值得一看：
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://isujin.com/" title="素锦" target="_blank">素锦</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://zhibimo.com/explore/books" title="知笔墨" target="_blank">知笔墨</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.danielaandrade.com/" title="Daniela Andrade" target="_blank">Daniela Andrade</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#物理视图"><span class="nav-number">1.</span> <span class="nav-text">物理视图</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HBase体系架构"><span class="nav-number"></span> <span class="nav-text">HBase体系架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Client"><span class="nav-number">1.</span> <span class="nav-text">Client</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Zookeeper"><span class="nav-number">2.</span> <span class="nav-text">Zookeeper</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Master"><span class="nav-number">3.</span> <span class="nav-text">Master</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RegionServer"><span class="nav-number">4.</span> <span class="nav-text">RegionServer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储模型"><span class="nav-number"></span> <span class="nav-text">存储模型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#region"><span class="nav-number">1.</span> <span class="nav-text">region</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HLog-WAL-log"><span class="nav-number">2.</span> <span class="nav-text">HLog(WAL log)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据模型：Memstore-与-storefile"><span class="nav-number">3.</span> <span class="nav-text">数据模型：Memstore 与 storefile</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HBase伪分布式搭建（node01）"><span class="nav-number"></span> <span class="nav-text">HBase伪分布式搭建（node01）</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#0-启动zookeeper集群和hadoop集群"><span class="nav-number">0.0.1.</span> <span class="nav-text">0.启动zookeeper集群和hadoop集群</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#1-解压hbase安装包"><span class="nav-number">0.0.2.</span> <span class="nav-text">1.解压hbase安装包</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-配置环境变量"><span class="nav-number">0.0.3.</span> <span class="nav-text">2.配置环境变量</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-hbase-env-sh中配置JAVA-HOME"><span class="nav-number">0.0.4.</span> <span class="nav-text">3.hbase-env.sh中配置JAVA_HOME</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-修改hbase-site-xml配置文件"><span class="nav-number">0.0.5.</span> <span class="nav-text">4.修改hbase-site.xml配置文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-启动hbase"><span class="nav-number">0.0.6.</span> <span class="nav-text">5.启动hbase</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#6-进入hbase命令行"><span class="nav-number">0.0.7.</span> <span class="nav-text">6.进入hbase命令行</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基础命令练习"><span class="nav-number"></span> <span class="nav-text">基础命令练习</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HBase完全分布式搭建"><span class="nav-number"></span> <span class="nav-text">HBase完全分布式搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#角色分布"><span class="nav-number">1.</span> <span class="nav-text">角色分布</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#0-再准备一台机器node05"><span class="nav-number">1.0.1.</span> <span class="nav-text">0.    再准备一台机器node05</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#1-从node01上分发hbase目录到其他机器"><span class="nav-number">1.0.2.</span> <span class="nav-text">1.从node01上分发hbase目录到其他机器</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-修改node01中hbase的配置文件hbase-env-sh"><span class="nav-number">1.0.3.</span> <span class="nav-text">2.修改node01中hbase的配置文件hbase-env.sh</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-修改node01中hbase的配置文件hbase-site-xml"><span class="nav-number">1.0.4.</span> <span class="nav-text">3.修改node01中hbase的配置文件hbase-site.xml</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-修改node01中hbase的配置文件regionservers"><span class="nav-number">1.0.5.</span> <span class="nav-text">4.修改node01中hbase的配置文件regionservers</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-新建backup-masters文件，并做修改"><span class="nav-number">1.0.6.</span> <span class="nav-text">5.新建backup-masters文件，并做修改</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#6-把hdfs-site-xml-copy到hbase的配置目录下"><span class="nav-number">1.0.7.</span> <span class="nav-text">6.把hdfs-site.xml copy到hbase的配置目录下</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7-同步配置文件"><span class="nav-number">1.0.8.</span> <span class="nav-text">7.同步配置文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8-启动集群（先启动ZK和Hadoop集群）"><span class="nav-number">1.0.9.</span> <span class="nav-text">8.启动集群（先启动ZK和Hadoop集群）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#9-验证"><span class="nav-number">1.0.10.</span> <span class="nav-text">9.验证</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证集群的高可用"><span class="nav-number">2.</span> <span class="nav-text">验证集群的高可用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Bug解决2"><span class="nav-number">3.</span> <span class="nav-text">Bug解决2</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API"><span class="nav-number"></span> <span class="nav-text">API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#需求：通话记录查询"><span class="nav-number">1.</span> <span class="nav-text">需求：通话记录查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#建表："><span class="nav-number">1.1.</span> <span class="nav-text">建表：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入数据："><span class="nav-number">1.2.</span> <span class="nav-text">插入数据：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询数据："><span class="nav-number">1.3.</span> <span class="nav-text">查询数据：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#插入10个手机号，每个手机号有100条通话记录，-时间按降序排列："><span class="nav-number">1.4.</span> <span class="nav-text">插入10个手机号，每个手机号有100条通话记录， 时间按降序排列：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询某个手机号某个月的通话记录："><span class="nav-number">1.5.</span> <span class="nav-text">查询某个手机号某个月的通话记录：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查询某个手机号所有的主叫-type-0-的通话记录："><span class="nav-number">1.6.</span> <span class="nav-text">查询某个手机号所有的主叫(type=0)的通话记录：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设计表"><span class="nav-number"></span> <span class="nav-text">设计表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#人员-角色"><span class="nav-number">1.</span> <span class="nav-text">人员-角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#组织架构组：部门-子部门"><span class="nav-number">2.</span> <span class="nav-text">组织架构组：部门-子部门</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#微博表设计"><span class="nav-number">3.</span> <span class="nav-text">微博表设计</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Protobuf"><span class="nav-number"></span> <span class="nav-text">Protobuf</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装protobuf（node05）"><span class="nav-number">1.</span> <span class="nav-text">安装protobuf（node05）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#对通话记录案例中的列和行进行整合优化"><span class="nav-number">2.</span> <span class="nav-text">对通话记录案例中的列和行进行整合优化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HBase优化"><span class="nav-number"></span> <span class="nav-text">HBase优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#设计表的优化"><span class="nav-number">1.</span> <span class="nav-text">设计表的优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-Pre-Creating-Regions（预分区）"><span class="nav-number">1.1.</span> <span class="nav-text">1.Pre-Creating Regions（预分区）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-rowkey的设计"><span class="nav-number">1.2.</span> <span class="nav-text">2.rowkey的设计</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-Column-Family"><span class="nav-number">1.3.</span> <span class="nav-text">3.Column Family</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-In-Memory"><span class="nav-number">1.4.</span> <span class="nav-text">4.In Memory</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-Max-Version"><span class="nav-number">1.5.</span> <span class="nav-text">5.Max Version</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-Time-To-Live"><span class="nav-number">1.6.</span> <span class="nav-text">6.Time To Live</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-Compact-amp-Split"><span class="nav-number">1.7.</span> <span class="nav-text">7.Compact & Split</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#写表的优化"><span class="nav-number">2.</span> <span class="nav-text">写表的优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-多HTable并发写"><span class="nav-number">2.1.</span> <span class="nav-text">1.多HTable并发写</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-HTable参数设置"><span class="nav-number">2.2.</span> <span class="nav-text">2.HTable参数设置</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Auto-Flush"><span class="nav-number">2.2.1.</span> <span class="nav-text">Auto Flush</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Write-Buffer"><span class="nav-number">2.2.2.</span> <span class="nav-text">Write Buffer</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#WAL-Flag"><span class="nav-number">2.2.3.</span> <span class="nav-text">WAL Flag</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-批量写"><span class="nav-number">2.3.</span> <span class="nav-text">3.批量写</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-多线程并发写"><span class="nav-number">2.4.</span> <span class="nav-text">4.多线程并发写</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#读表的优化"><span class="nav-number">3.</span> <span class="nav-text">读表的优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-多个HTable并发读"><span class="nav-number">3.1.</span> <span class="nav-text">1.    多个HTable并发读</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-HTable参数设置-1"><span class="nav-number">3.2.</span> <span class="nav-text">2.HTable参数设置</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Scanner-Caching"><span class="nav-number">3.2.1.</span> <span class="nav-text">Scanner Caching</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Scan-Attribute-Selection"><span class="nav-number">3.2.2.</span> <span class="nav-text">Scan Attribute Selection</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Close-ResultScanner"><span class="nav-number">3.2.3.</span> <span class="nav-text">Close ResultScanner</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-批量读"><span class="nav-number">3.3.</span> <span class="nav-text">3.批量读</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-多线程并发读"><span class="nav-number">3.4.</span> <span class="nav-text">4.多线程并发读</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#5-缓存查询结果"><span class="nav-number">3.4.1.</span> <span class="nav-text">5.缓存查询结果</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#6-Blockcache"><span class="nav-number">3.4.2.</span> <span class="nav-text">6.Blockcache</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#HTable和HTablePool"><span class="nav-number">3.4.3.</span> <span class="nav-text">HTable和HTablePool</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HTable"><span class="nav-number">4.</span> <span class="nav-text">HTable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HTablePool"><span class="nav-number">5.</span> <span class="nav-text">HTablePool</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HBase和关系型数据库的区别"><span class="nav-number">6.</span> <span class="nav-text">HBase和关系型数据库的区别</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HBase与MapReduce整合"><span class="nav-number"></span> <span class="nav-text">HBase与MapReduce整合</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Reducer类"><span class="nav-number">1.</span> <span class="nav-text">Reducer类</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chant</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  







  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/three/three.min.js"></script>

  
  <script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://chant00.com/2016/11/28/2017-09-09/';
          this.page.identifier = '2016/11/28/2017-09-09/';
          this.page.title = 'HBase学习笔记';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://chant-1.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("7n9J9l0UCv4yQu1307uCu3oM-gzGzoHsz", "OUDiIhwsTbY8xOgAKOuYf7Xb");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  


  

  

</body>
</html>
